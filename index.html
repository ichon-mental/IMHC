<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° - Synology NAS DS920+ í†µí•© ì‹œìŠ¤í…œ v2.0</title>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --nas-color: #1976d2;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-nas: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ìƒíƒœë°” ìŠ¤íƒ€ì¼ */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            font-size: 13px;
            z-index: 9999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--gradient-primary);
        }

        .login-container.hidden {
            display: none !important;
        }

        .login-box {
            background: var(--gradient-card);
            padding: 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 700;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ */
        .app-container {
            display: flex;
            height: 100vh;
            padding-top: 50px;
            background: var(--gradient-primary);
        }

        .app-container.hidden {
            display: none !important;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background: var(--gradient-card);
        }

        .sidebar-header h2 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .user-info {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-menu {
            padding: 24px 0;
        }

        .nav-item {
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: white !important;
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        .nav-link .icon {
            margin-right: 16px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            transition: color 0.3s ease;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            background: rgba(248, 250, 252, 0.8);
            overflow-y: auto;
            min-height: calc(100vh - 50px);
        }

        .page {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - 50px);
            display: block;
        }

        .page.hidden {
            display: none !important;
        }

        .dashboard-container {
            padding: 40px;
            min-height: calc(100vh - 130px);
            background: transparent;
        }

        /* ìœ„ì ¯ ìŠ¤íƒ€ì¼ */
        .widget {
            background: var(--gradient-card);
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .widget-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .widget-icon {
            font-size: 28px;
            color: var(--primary-color);
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--gradient-card);
            padding: 32px 28px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1;
        }

        .stat-number.urgent {
            color: var(--danger-color);
        }

        .stat-number.normal {
            color: var(--primary-color);
        }

        .stat-number.completed {
            color: var(--success-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
        }

        /* ìƒˆ ì˜ë¢° ë²„íŠ¼ */
        .new-referral-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            white-space: nowrap;
            min-width: 140px;
        }

        .new-referral-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* íŒ€ íƒ­ ìŠ¤íƒ€ì¼ */
        .team-tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .chart-data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .chart-item {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chart-item-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .chart-item-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .chart-item-percentage {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            margin-top: 24px;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }

        .table-container thead tr {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .table-container th {
            padding: 20px 12px;
            border-bottom: 3px solid #e5e7eb;
            text-align: left;
            font-weight: 800;
            color: #1f2937;
            font-size: 13px;
        }

        .table-container td {
            padding: 15px 12px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
        }

        .table-container tbody tr:hover {
            background: #f9fafb;
        }

        .action-btn {
            padding: 6px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .action-btn.view {
            background: #6b7280;
        }

        .action-btn.edit {
            background: #059669;
        }

        .action-btn.delete {
            background: #ef4444;
        }

        /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            background: white;
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            z-index: 10001;
            max-width: 450px;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* NAS ìƒíƒœ ì¹´ë“œ */
        .nas-status-card {
            background: var(--gradient-nas);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
        }

        .nas-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .nas-status-item {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .nas-status-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .nas-status-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* ë°±ì—… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .backup-btn {
            background: var(--gradient-nas);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .backup-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .backup-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .hidden {
            display: none !important;
        }

        .show {
            display: block !important;
        }

        .text-success {
            color: var(--success-color);
        }

        .text-error {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .text-info {
            color: var(--info-color);
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .dashboard-container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ê°œì„  */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        /* í¼ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .form-section {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 700;
        }

        .form-section.basic-info {
            background: #f8f9fa;
        }

        .form-section.referral-info {
            background: #fff7ed;
        }

        .form-section.referral-type {
            background: #f0f9ff;
        }

        .form-section.diagnosis-info {
            background: #fef3c7;
        }

        .form-section.content-info {
            background: #f3f4f6;
        }

        /* ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-badge.processing {
            background: #f59e0b;
        }

        .status-badge.completed {
            background: #059669;
        }

        .status-badge.urgent {
            background: #dc2626;
        }

        .status-badge.excluded {
            background: #6b7280;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* ì—ëŸ¬ ìƒíƒœ */
        .error-state {
            color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* ì„±ê³µ ìƒíƒœ */
        .success-state {
            color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body>
    <!-- ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="notificationContainer" style="position: fixed; top: 80px; right: 24px; z-index: 10001;"></div>
    
    <!-- ìƒíƒœ ë°” -->
    <div class="status-bar">
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <span>Synology NAS DS920+ ì‹œìŠ¤í…œ v2.0</span>
            <span style="margin-left: 16px; font-size: 11px; opacity: 0.8;">|</span>
            <span style="margin-left: 8px; font-size: 11px;" id="nasConnectionStatusTop">
                <span id="nasStatusBadge" style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>ğŸ”´</span>
                    <span>ë¯¸ì—°ê²°</span>
                </span>
            </span>
        </div>
        <div>
            <span>ì ‘ì†ì: <span id="onlineCount">1</span>ëª… | <span id="currentTime"></span></span>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div id="loadingText">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸ¥ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</h1>
                <p>Synology NAS DS920+ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v2.0</p>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label for="username">ì‚¬ìš©ì ID</label>
                    <input type="text" id="username" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="admin" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="1234" autocomplete="current-password">
                </div>
                <button class="btn" onclick="handleLogin()" id="loginBtn">ë¡œê·¸ì¸</button>
                
                <div style="text-align: center; margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                    <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                        ğŸ”’ ë¡œê·¸ì¸ í›„ <strong>"NAS ê´€ë¦¬"</strong> íƒ­ì—ì„œ<br>
                        Synology NAS ì—°ê²°ì„ ì„¤ì •í•˜ì„¸ìš”
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ì˜ë¢° ëª¨ë‹¬ -->
    <div id="newReferralModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ¥ ìƒˆ ì˜ë¢° ì ‘ìˆ˜</h2>
                <button class="modal-close" onclick="closeNewReferralModal()">Ã—</button>
            </div>
            
            <form id="newReferralForm">
                <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section basic-info">
                    <h3>ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì´ë¦„ *</label>
                            <input type="text" id="referrerName" required placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>ì„±ë³„ *</label>
                            <select id="referrerGender" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ì´ *</label>
                            <input type="number" id="referrerAge" required min="0" max="120" placeholder="ì˜ˆ: 35">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ë‚ ì§œ *</label>
                            <input type="date" id="referralDate" required>
                        </div>
                        <div class="form-group">
                            <label>ì§€ì—­</label>
                            <input type="text" id="region" placeholder="ì˜ˆ: ì´ì²œì‹œ ì°½ì „ë™" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹ì</label>
                            <input type="text" id="assignedCounselor" placeholder="ë‹´ë‹¹ ìƒë‹´ì‚¬ëª…" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- ì˜ë¢° ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section referral-info">
                    <h3>ğŸ“‹ ì˜ë¢° ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì˜ë¢°ê²½ë¡œ</label>
                            <input type="text" id="referralPath" placeholder="ì˜ë¢° ê²½ë¡œ" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ê¸°ê´€ *</label>
                            <select id="referringAgency" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°">ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°</option>
                                <option value="ì´ì²œì‹œì²­">ì´ì²œì‹œì²­</option>
                                <option value="ê²½ì°°ì„œ">ê²½ì°°ì„œ</option>
                                <option value="ì†Œë°©">ì†Œë°©</option>
                                <option value="ì˜ë£Œê¸°ê´€">ì˜ë£Œê¸°ê´€</option>
                                <option value="ì •ì‹ ë³´ê±´ê¸°ê´€">ì •ì‹ ë³´ê±´ê¸°ê´€</option>
                                <option value="ë³´ê±´ì†Œ">ë³´ê±´ì†Œ</option>
                                <option value="ê°€ì¡±">ê°€ì¡±</option>
                                <option value="ì§€ì¸">ì§€ì¸</option>
                                <option value="ì§€ì—­ì‚¬íšŒ">ì§€ì—­ì‚¬íšŒ</option>
                                <option value="ë³µì§€ê´€">ë³µì§€ê´€</option>
                                <option value="í•™êµ">í•™êµ</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                <option value="1393/129">1393/129</option>
                                <option value="ë³¸ì¸">ë³¸ì¸</option>
                                <option value="ì´ë™ìƒë‹´">ì´ë™ìƒë‹´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹íŒ€ *</label>
                            <select id="assignedTeam" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                                <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                                <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                                <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CRI</label>
                            <input type="text" id="criInfo" placeholder="CRI ì •ë³´" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- ì˜ë¢° ìœ í˜• ì„¹ì…˜ -->
                <div class="form-section referral-type">
                    <h3>ğŸ“‹ ì˜ë¢° ìœ í˜•</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <input type="checkbox" id="diagnosisProtectionRequest" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ì§„ë‹¨ ë³´í˜¸ìš”ì²­</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <input type="checkbox" id="writtenReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ì„œë©´ì˜ë¢°</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <input type="checkbox" id="phoneReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ìœ ì„ ì˜ë¢°</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <input type="checkbox" id="policeInvolvement" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ê²½ì°°ê°œì…ì—¬ë¶€</span>
                        </label>
                    </div>
                </div>

                <!-- ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section diagnosis-info">
                    <h3>ğŸ¥ ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì§„ë‹¨ëª…</label>
                            <input type="text" id="diagnosis" placeholder="ì˜ˆ: ìš°ìš¸ì¦, ì¡°í˜„ë³‘ ë“±" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ì¡°ì¹˜ê²°ê³¼</label>
                            <select id="actionResult">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)">ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)</option>
                                <option value="ì§€ì†ìƒë‹´">ì§€ì†ìƒë‹´</option>
                                <option value="ì¹˜ë£Œì—°ê³„">ì¹˜ë£Œì—°ê³„</option>
                                <option value="ì„œë¹„ìŠ¤ ì—°ê³„">ì„œë¹„ìŠ¤ ì—°ê³„</option>
                                <option value="ê¸°íƒ€ì¡°ì¹˜">ê¸°íƒ€ì¡°ì¹˜</option>
                                <option value="ì •ë³´ì œê³µ">ì •ë³´ì œê³µ</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì²˜ë¦¬ì¤‘">ì²˜ë¦¬ì¤‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì¢…ê²°ì—¬ë¶€</label>
                            <select id="closureStatus">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸">ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸</option>
                                <option value="ë¯¸ë“±ë¡ì ì¢…ê²°">ë¯¸ë“±ë¡ì ì¢…ê²°</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ìƒì„¸ ë‚´ìš© ì„¹ì…˜ -->
                <div class="form-section content-info">
                    <h3>ğŸ“ ìƒì„¸ ë‚´ìš©</h3>
                    <div class="form-group">
                        <label>ê°œì…ë‚´ìš©/í˜„ìƒí™© *</label>
                        <textarea id="interventionContent" required style="min-height: 250px; resize: vertical; font-family: 'Malgun Gothic', sans-serif; line-height: 1.6;" placeholder="í˜„ì¬ ìƒí™©, ê°œì… ë‚´ìš©, ì¦ìƒì˜ êµ¬ì²´ì  ë‚´ìš© ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ í•´ì£¼ì„¸ìš”." maxlength="5000"></textarea>
                        
                        <!-- ì°¸ê³  ì˜ˆì œ -->
                        <div style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0369a1; border-radius: 12px; box-shadow: 0 4px 12px rgba(3, 105, 161, 0.1);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                <span style="font-size: 20px;">ğŸ“„</span>
                                <h4 style="margin: 0; color: #0369a1; font-size: 16px; font-weight: 700;">ì‘ì„± ì°¸ê³  ì˜ˆì œ</h4>
                                <span style="background: #0369a1; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ì‹¤ì œ ì¼€ì´ìŠ¤ ê¸°ì¤€</span>
                            </div>
                            <div style="font-size: 13px; color: #0f172a; line-height: 1.7; white-space: pre-line; background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">ìì‚´ì‹œë„ë ¥ : (+) 1st 2022ë…„ 1ì›” Wrist cutting, 2nd 2022ë…„ 2ì›” ë†ì•½ìŒë…, 3rd 2022ë…„ 7ì›” íˆ¬ì‹ í•˜ë ¤ë‹¤ ê²½ì°°ì‹ ê³ 

ì •ì‹ ê³¼ ì•½ë¬¼ë³µìš© ë° ì¹˜ë£Œì—¬ë¶€: 2022ë…„ 1ì›” ìˆ˜ì›ì•„ì£¼ë‹¤ë‚¨ë³‘ì› ì‘ê¸‰ì…ì› í›„ í‡´ì›, 2022ë…„ ì›ì£¼ê¸°ë…ë³‘ì› ìœ„ì„¸ì²™ í›„ ê·€ê°€. ì…ì›ì— ê±°ë¶€ì ì´ë©° 2ì›”ê¹Œì§€ ì •ì‹ ê³¼ ì•½ë¬¼ ë³µìš©í–ˆìœ¼ë‚˜ 2022ë…„ 6ì›” ì„ì˜ ì¤‘ë‹¨

ìŒì£¼ì—¬ë¶€ : ë§¤ì¼ ì†Œì£¼ 2ë³‘ì”©

ì‹ì‚¬ ë° ìˆ˜ë©´ : 2~3ì‹œê°„ ì¤ë‹¤ê°€ ê¹¨ì–´ë‚¨

ì§„ë‹¨ëª… : ì–‘ê·¹ì„± ì •ë™ì¥ì• 

ì•½ë¬¼ : (ì•„ì¹¨) ì•„ë¦¬í”¼ì¡¸ì • 2mg, ëª…ì¸ë²¤ì¦ˆíŠ¸ë¡œí•€ë©”ì‹¤ë ˆì´íŠ¸ì • 1mg, ë°íŒŒí‚¨í¬ë¡œë…¸ì • 300mg, ë¦¬ë³´íŠ¸ë¦´ì •, ìŠ¤ë¦¬ë°˜ì • 0.5mg
(ì €ë…) ë°íŒŒí‚¨í¬ë¡œë…¸ì • 300mg, íŒ”ë¦¬ìŠ¤íœì„œë°©ì • 3mg, ë¦¬ë³´íŠ¸ë¦´ì •, ìŠ¤ë¦¬ë°˜ì • 0.5mg

ì™¸ë˜ë³‘ì› : í•˜ì€ì •ì‹ ì˜í•™ê³¼ì˜ì›

ë³´í˜¸ìš”ì¸ : ê±°ë¶ì´ / ì§€ì§€ì²´ê³„ : ì´ˆë“±í•™êµ ë™ì°½ìƒ

ì£¼í˜¸ì†Œ ë° ê°œì…ë‚´ìš© : 1ì¸ ê°€êµ¬ì´ë©° ê³ ë“±í•™êµ ì¡¸ì—… í›„ ì´ì²œìœ¼ë¡œ ì™”ìœ¼ë‚˜ ëšœë ·í•œ ì§ì¥ì—†ì´ ì§‘ì—ì„œ ì€ë‘”. ìµœê·¼ 2ê°œì›”ê°„ ë¬´ë¶„ë³„í•œ ì§€ì¶œê³¼ í­ìŒ ì¦ê°€. ì •ì‹ ê³¼ì  ë¬¸ì œê°€ ìˆìœ¼ë‚˜ ì•½ë¬¼ì„ ì„ì˜ ì¤‘ë‹¨í•˜ì—¬ í•˜ì€ì •ì‹ ì˜í•™ê³¼ì˜ì›ì— ì—°ê³„í•˜ì˜€ìœ¼ë©° ì£¼ 1íšŒ ì™¸ë˜ë™í–‰í•˜ì—¬ ìƒë‹´ ë° ì•½ë¬¼ ì²˜ë°© ì¤‘, ê²½ì œì  ë¬¸ì œë¡œ ì´ì²œì‹œì²­ì—ì„œ ê²½ê¸°ë„í˜• ê¸´ê¸‰ìƒê³„ë¹„ ì§€ì›, ì‹ ì²´ì¹˜ë£Œ(ì–´ê¹¨ íƒˆê³¨)ì„ ìœ„í•´ ì´ì²œì˜ë£Œì› ê³µê³µì‚¬ì—…ê³¼ ìì› ì—°ê³„

í˜„ìƒí™© : ë“±ë¡ì„ ìœ„í•´ ì´ˆê¸° ìƒë‹´ ì¤‘</div>
                            
                            <div style="margin-top: 12px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                                <p style="margin: 0; font-size: 12px; color: #92400e; font-weight: 600;">
                                    ğŸ’¡ <strong>ì‘ì„± íŒ:</strong> ìœ„ ì˜ˆì œë¥¼ ì°¸ê³ í•˜ì—¬ ìì‚´ì‹œë„ë ¥, ì¹˜ë£Œì´ë ¥, ìƒí™œíŒ¨í„´, ë³µìš©ì•½ë¬¼, ì§€ì§€ì²´ê³„, ê°œì…ë‚´ìš©, í˜„ìƒí™© ë“±ì„ êµ¬ì²´ì ì´ê³  ì²´ê³„ì ìœ¼ë¡œ ê¸°ìˆ í•´ì£¼ì„¸ìš”.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íšŒì‹  ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section" style="background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); border: 2px solid #64748b;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 24px;">ğŸ“¬</span>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 700;">íšŒì‹  ì •ë³´</h3>
                        <span style="background: #64748b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ìµœì¢… ë‹¨ê³„</span>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 700; color: #1f2937; font-size: 15px;">íšŒì‹ ì—¬ë¶€ ë° ë‚´ìš©</label>
                        <textarea id="responseRequired" style="min-height: 100px; resize: vertical; border: 2px solid #cbd5e1; font-family: 'Malgun Gothic', sans-serif;" placeholder="íšŒì‹ ì´ í•„ìš”í•œ ê²½ìš° êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.&#10;&#10;ì˜ˆì‹œ:&#10;- ì²˜ë¦¬ê²°ê³¼ íšŒì‹  ìš”ì²­&#10;- ê¸´ê¸‰ ì¡°ì¹˜ ê²°ê³¼ ì¦‰ì‹œ íšŒì‹  í•„ìš”&#10;- ì—°ê³„ê¸°ê´€ í†µë³´ í•„ìš”&#10;- ì‚¬í›„ê´€ë¦¬ í˜„í™© ì •ê¸° ë³´ê³  ìš”ì²­&#10;- íšŒì‹  ë¶ˆí•„ìš”" maxlength="1000"></textarea>
                    </div>
                </div>
                
                <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" onclick="closeNewReferralModal()" style="padding: 14px 28px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì·¨ì†Œ</button>
                    <button type="button" onclick="saveDraftReferral()" style="padding: 14px 28px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì„ì‹œì €ì¥</button>
                    <button type="submit" style="padding: 14px 28px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì ‘ìˆ˜ ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì˜ë¢° ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="referralDetailModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì˜ë¢° ìƒì„¸ë³´ê¸°</h2>
                <button class="modal-close" onclick="closeReferralDetailModal()">Ã—</button>
            </div>
            
            <div id="referralDetailContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px;">
                <button onclick="closeReferralDetailModal()" style="padding: 12px 24px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
                <button onclick="editCurrentReferral()" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <!-- ì˜ë¢° ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editReferralModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">âœï¸ ì˜ë¢° ìˆ˜ì •</h2>
                <button class="modal-close" onclick="closeEditReferralModal()">Ã—</button>
            </div>
            
            <form id="editReferralForm">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>ì˜ë¢°ë²ˆí˜¸</label>
                        <input type="text" id="editRefNo" readonly style="background: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>ì´ë¦„ *</label>
                        <input type="text" id="editReferrerName" required maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>ì„±ë³„ *</label>
                        <select id="editReferrerGender" required>
                            <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                            <option value="ì—¬ì„±">ì—¬ì„±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë‚˜ì´ *</label>
                        <input type="number" id="editReferrerAge" required min="0" max="120">
                    </div>
                    <div class="form-group">
                        <label>ì˜ë¢°ë‚ ì§œ *</label>
                        <input type="date" id="editReferralDate" required>
                    </div>
                    <div class="form-group">
                        <label>ì˜ë¢°ê¸°ê´€ *</label>
                        <select id="editReferringAgency" required>
                            <option value="ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°">ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°</option>
                            <option value="ì´ì²œì‹œì²­">ì´ì²œì‹œì²­</option>
                            <option value="ê²½ì°°ì„œ">ê²½ì°°ì„œ</option>
                            <option value="ì†Œë°©">ì†Œë°©</option>
                            <option value="ì˜ë£Œê¸°ê´€">ì˜ë£Œê¸°ê´€</option>
                            <option value="ì •ì‹ ë³´ê±´ê¸°ê´€">ì •ì‹ ë³´ê±´ê¸°ê´€</option>
                            <option value="ë³´ê±´ì†Œ">ë³´ê±´ì†Œ</option>
                            <option value="ê°€ì¡±">ê°€ì¡±</option>
                            <option value="ì§€ì¸">ì§€ì¸</option>
                            <option value="ì§€ì—­ì‚¬íšŒ">ì§€ì—­ì‚¬íšŒ</option>
                            <option value="ë³µì§€ê´€">ë³µì§€ê´€</option>
                            <option value="í•™êµ">í•™êµ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            <option value="1393/129">1393/129</option>
                            <option value="ë³¸ì¸">ë³¸ì¸</option>
                            <option value="ì´ë™ìƒë‹´">ì´ë™ìƒë‹´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë‹¹íŒ€ *</label>
                        <select id="editAssignedTeam" required>
                            <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                            <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                            <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                            <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                            <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì</label>
                        <input type="text" id="editCounselor" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>ì§„ë‹¨ëª…</label>
                        <input type="text" id="editDiagnosis" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>ì¡°ì¹˜ê²°ê³¼</label>
                        <select id="editActionResult">
                            <option value="ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)">ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)</option>
                            <option value="ì§€ì†ìƒë‹´">ì§€ì†ìƒë‹´</option>
                            <option value="ì¹˜ë£Œì—°ê³„">ì¹˜ë£Œì—°ê³„</option>
                            <option value="ì„œë¹„ìŠ¤ ì—°ê³„">ì„œë¹„ìŠ¤ ì—°ê³„</option>
                            <option value="ê¸°íƒ€ì¡°ì¹˜">ê¸°íƒ€ì¡°ì¹˜</option>
                            <option value="ì •ë³´ì œê³µ">ì •ë³´ì œê³µ</option>
                            <option value="ì¢…ê²°">ì¢…ê²°</option>
                            <option value="ì²˜ë¦¬ì¤‘">ì²˜ë¦¬ì¤‘</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì¢…ê²°ì—¬ë¶€ *</label>
                        <select id="editClosureStatus" required>
                            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                            <option value="ì¢…ê²°">ì¢…ê²°</option>
                            <option value="ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸">ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸</option>
                            <option value="ë¯¸ë“±ë¡ì ì¢…ê²°">ë¯¸ë“±ë¡ì ì¢…ê²°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­</label>
                        <input type="text" id="editRegion" maxlength="100">
                    </div>
                </div>
                
                <div style="background: #f0f4f8; padding: 20px; border-radius: 12px; margin-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937; font-weight: 700;">ğŸ“¬ íšŒì‹  ì •ë³´</h4>
                    <div class="form-group">
                        <label>íšŒì‹ ì—¬ë¶€ ë° ë‚´ìš©</label>
                        <textarea id="editResponseRequired" style="min-height: 80px; resize: vertical; border: 2px solid #cbd5e1;" placeholder="íšŒì‹ ì´ í•„ìš”í•œ ê²½ìš° êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." maxlength="1000"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px;">
                    <button type="button" onclick="closeEditReferralModal()" style="padding: 12px 24px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
                    <button type="submit" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NAS ì—°ê²° ì„¤ì • ëª¨ë‹¬ -->
    <div id="nasSettingsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ—„ï¸ Synology NAS ì—°ê²° ì„¤ì •</h2>
                <button class="modal-close" onclick="closeNASSettingsModal()">Ã—</button>
            </div>
            
            <form id="nasSettingsForm">
                <!-- ì‹¤ì œ ì—°ê²° ì•ˆë‚´ -->
                <div style="background: #fef3c7; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0; color: #92400e;">ğŸ“‹ ì‹¤ì œ NAS ì—°ê²° ê°€ì´ë“œ</h4>
                    <div style="font-size: 14px; color: #92400e; line-height: 1.6;">
                        <p style="margin: 0 0 12px 0;"><strong>ğŸ”§ NASì—ì„œ ì„¤ì •í•´ì•¼ í•  í•­ëª©:</strong></p>
                        <ol style="margin: 0 0 12px 0; padding-left: 20px;">
                            <li><strong>DSM ì›¹ ì¸í„°í˜ì´ìŠ¤</strong>ì— ë¸Œë¼ìš°ì €ë¡œ ì ‘ì† í™•ì¸</li>
                            <li><strong>ì œì–´íŒ â†’ ì›¹ ì„œë¹„ìŠ¤</strong>ì—ì„œ HTTP ì„œë¹„ìŠ¤ í™œì„±í™”</li>
                            <li><strong>ì œì–´íŒ â†’ ë³´ì•ˆ â†’ ë°©í™”ë²½</strong>ì—ì„œ í¬íŠ¸ 5000 í—ˆìš©</li>
                            <li><strong>File Station</strong> ì„œë¹„ìŠ¤ í™œì„±í™”</li>
                            <li><strong>ê´€ë¦¬ì ê³„ì •</strong> ë˜ëŠ” File Station ê¶Œí•œ ìˆëŠ” ê³„ì • ì‚¬ìš©</li>
                        </ol>
                        <p style="margin: 0 0 8px 0;"><strong>ğŸŒ ë„¤íŠ¸ì›Œí¬ ìš”êµ¬ì‚¬í•­:</strong></p>
                        <ul style="margin: 0 0 12px 0; padding-left: 20px;">
                            <li>ë™ì¼í•œ LAN(ë¡œì»¬ ë„¤íŠ¸ì›Œí¬)ì—ì„œ ì ‘ê·¼</li>
                            <li>PCì™€ NASê°€ ê°™ì€ ê³µìœ ê¸°ì— ì—°ê²°</li>
                            <li>NAS IP ì£¼ì†Œ ì •í™•íˆ í™•ì¸ (DSMì—ì„œ í™•ì¸ ê°€ëŠ¥)</li>
                        </ul>
                        <p style="margin: 0; padding: 8px; background: rgba(245, 158, 11, 0.2); border-radius: 4px;"><strong>ğŸ’¡ íŒ:</strong> ë¨¼ì € ì›¹ë¸Œë¼ìš°ì €ì—ì„œ <code>http://[NAS_IP]:5000</code>ì— ì ‘ì†í•´ì„œ DSMì— ë¡œê·¸ì¸ì´ ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!</p>
                    </div>
                </div>

                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0; color: #0369a1;">ğŸ“¡ NAS ì—°ê²° ì •ë³´</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group">
                            <label>NAS IP ì£¼ì†Œ *</label>
                            <input type="text" id="nasIP" required placeholder="192.168.1.100" value="192.168.1.100" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                        </div>
                        <div class="form-group">
                            <label>í¬íŠ¸</label>
                            <input type="number" id="nasPort" placeholder="5000" value="5000" min="1" max="65535">
                        </div>
                        <div class="form-group">
                            <label>ì‚¬ìš©ìëª… *</label>
                            <input type="text" id="nasUsername" required placeholder="admin" value="admin" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸ *</label>
                            <input type="password" id="nasPassword" required placeholder="NAS ë¹„ë°€ë²ˆí˜¸" maxlength="100">
                        </div>
                    </div>
                </div>

                <div style="background: #fef3c7; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0; color: #92400e;">ğŸ’¾ ë°±ì—… ì„¤ì •</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group">
                            <label>ë°±ì—… ê²½ë¡œ</label>
                            <input type="text" id="nasBackupPath" placeholder="/volume1/backup/mental_health/" value="/volume1/backup/mental_health/" maxlength="200">
                        </div>
                        <div class="form-group">
                            <label>ìë™ ë°±ì—… ê°„ê²© (ë¶„)</label>
                            <input type="number" id="autoBackupInterval" placeholder="30" value="30" min="5" max="1440">
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableAutoBackup">
                            <span style="font-weight: 600;">ìë™ ë°±ì—… í™œì„±í™”</span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px;">
                    <button type="button" onclick="closeNASSettingsModal()" style="padding: 12px 24px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
                    <button type="button" id="testConnectionBtn" onclick="testNASConnection()" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                    <button type="button" id="saveAndConnectBtn" onclick="saveAndConnectNAS()" style="padding: 12px 24px; background: var(--gradient-nas); color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥ ë° ì—°ê²°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div id="mainApp" class="app-container hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</h2>
                <div class="user-info">
                    <div id="currentUserName">ì‹œìŠ¤í…œê´€ë¦¬ì</div>
                    <div id="currentUserRole">ê´€ë¦¬ì</div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item">
                    <div class="nav-link active" onclick="showPage('referrals')">
                        <span class="icon">ğŸ‘¥</span>
                        ì˜ë¢° ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('nas')">
                        <span class="icon">ğŸ—„ï¸</span>
                        NAS ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('reports')">
                        <span class="icon">ğŸ“ˆ</span>
                        í†µê³„/ë³´ê³ ì„œ
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('userManage')">
                        <span class="icon">ğŸ‘¤</span>
                        ì‚¬ìš©ì ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item" style="margin-top: 30px;">
                    <div class="nav-link" onclick="handleLogout()" style="color: var(--danger-color);">
                        <span class="icon">ğŸšª</span>
                        ë¡œê·¸ì•„ì›ƒ
                    </div>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <main class="main-content">
            <!-- ì˜ë¢° ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="referralsPage" class="page">
                <div class="dashboard-container">
                    <!-- í˜ì´ì§€ í—¤ë” -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding: 32px 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: var(--shadow); flex-wrap: wrap; gap: 20px;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">ì˜ë¢° ê´€ë¦¬</h1>
                        <button class="new-referral-btn" onclick="openNewReferralModal()">
                            <span>â•</span>
                            ìƒˆ ì˜ë¢° ì ‘ìˆ˜
                        </button>
                    </div>
                    
                    <!-- íŒ€ë³„ íƒ­ ì‹œìŠ¤í…œ -->
                    <div class="team-management-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 32px; text-align: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">
                        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 800;">ğŸ¥ íŒ€ë³„ ì˜ë¢° ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                        <p style="margin: 0; font-size: 16px; opacity: 0.9;">ê° íŒ€ë³„ë¡œ ì˜ë¢°ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ì¶”ì í•˜ì„¸ìš”</p>
                    </div>
                    
                    <!-- íŒ€ ì„ íƒ íƒ­ -->
                    <div class="team-tabs-container" style="margin-bottom: 32px;">
                        <div class="team-tabs-wrapper" style="background: white; border-radius: 20px; padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 2px solid #e5e7eb;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 20px; font-weight: 700;">íŒ€ ì„ íƒ</h3>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">ë³´ê³  ì‹¶ì€ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            </div>
                            
                            <div id="teamTabsGrid" class="team-tabs-grid">
                                <div class="chart-data-display">
                                    <div class="chart-item" onclick="selectTeam('all')" style="cursor: pointer;" data-team="all">
                                        <div class="chart-item-value">ğŸ“Š</div>
                                        <div class="chart-item-label">ì „ì²´ íŒ€</div>
                                        <div class="chart-item-percentage" id="allTeamCount">5ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ì¦ì§„íŒ€')" style="cursor: pointer;" data-team="ì¦ì§„íŒ€">
                                        <div class="chart-item-value">ğŸ¯</div>
                                        <div class="chart-item-label">ì¦ì§„íŒ€</div>
                                        <div class="chart-item-percentage" id="team1Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('íšŒë³µíŒ€')" style="cursor: pointer;" data-team="íšŒë³µíŒ€">
                                        <div class="chart-item-value">ğŸŒ±</div>
                                        <div class="chart-item-label">íšŒë³µíŒ€</div>
                                        <div class="chart-item-percentage" id="team2Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ìì‚´ì˜ˆë°©ì„¼í„°')" style="cursor: pointer;" data-team="ìì‚´ì˜ˆë°©ì„¼í„°">
                                        <div class="chart-item-value">ğŸš¨</div>
                                        <div class="chart-item-label">ìì‚´ì˜ˆë°©ì„¼í„°</div>
                                        <div class="chart-item-percentage" id="team3Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ì•„ë™ì²­ì†Œë…„')" style="cursor: pointer;" data-team="ì•„ë™ì²­ì†Œë…„">
                                        <div class="chart-item-value">ğŸ‘¶</div>
                                        <div class="chart-item-label">ì•„ë™ì²­ì†Œë…„</div>
                                        <div class="chart-item-percentage" id="team4Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ë‚¨ë¶€ë¶„ì†Œ')" style="cursor: pointer;" data-team="ë‚¨ë¶€ë¶„ì†Œ">
                                        <div class="chart-item-value">ğŸ¢</div>
                                        <div class="chart-item-label">ë‚¨ë¶€ë¶„ì†Œ</div>
                                        <div class="chart-item-percentage" id="team5Count">1ê±´</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í˜„ì¬ íŒ€ ì •ë³´ -->
                    <div id="currentTeamInfo" class="current-team-info">
                        <div style="background: linear-gradient(135deg, #f9fafb, white); border: 3px solid #6b7280; border-radius: 16px; padding: 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="font-size: 56px;" id="currentTeamIcon">ğŸ“Š</div>
                                <div>
                                    <h3 style="margin: 0; color: #6b7280; font-size: 24px; font-weight: 800;" id="currentTeamTitle">ì „ì²´ íŒ€ ì˜ë¢° ëª©ë¡</h3>
                                    <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 16px;" id="currentTeamDesc">ëª¨ë“  íŒ€ì˜ ì˜ë¢°ë¥¼ í†µí•© ê´€ë¦¬</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 48px; font-weight: 900; color: #6b7280;" id="currentTeamCount">5</div>
                                <div style="font-size: 16px; color: #6b7280; font-weight: 600;">ì´ ì˜ë¢° ê±´ìˆ˜</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì˜ë¢° ëª©ë¡ ìœ„ì ¯ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ì˜ë¢° ëª©ë¡</h3>
                            <span class="widget-icon">ğŸ“‹</span>
                        </div>
                        <div id="referralsList">
                            <div class="table-container">
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ì˜ë¢°ë²ˆí˜¸</th>
                                                <th>ì´ë¦„</th>
                                                <th>ì„±ë³„/ë‚˜ì´</th>
                                                <th>ì˜ë¢°ë‚ ì§œ</th>
                                                <th>ì˜ë¢°ê¸°ê´€</th>
                                                <th>ë‹´ë‹¹íŒ€</th>
                                                <th>ë‹´ë‹¹ì</th>
                                                <th>ì§„ë‹¨ëª…</th>
                                                <th>ì¡°ì¹˜ê²°ê³¼</th>
                                                <th>ì¢…ê²°ì—¬ë¶€</th>
                                                <th style="text-align: center;">ì‘ì—…</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referralsTableBody">
                                            <!-- ê¸°ë³¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NAS ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="nasPage" class="page hidden">
                <div class="dashboard-container">
                    <!-- í—¤ë” -->
                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow-lg); text-align: center;">
                        <h1 style="background: var(--gradient-nas); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 32px; font-weight: 800; margin-bottom: 12px;">ğŸ—„ï¸ Synology NAS DS920+ ê´€ë¦¬</h1>
                        <p style="color: var(--text-secondary); font-size: 16px;">Synology NASë¥¼ í†µí•œ ë°ì´í„° ë°±ì—… ë° ì‹œìŠ¤í…œ ê´€ë¦¬</p>
                    </div>

                    <!-- NAS ìƒíƒœ ì¹´ë“œ -->
                    <div class="nas-status-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 24px; font-weight: 700;">ğŸ“¡ Synology DS920+ ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                            <button onclick="openNASSettingsModal()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                âš™ï¸ NAS ì—°ê²° ì„¤ì •
                            </button>
                        </div>
                        
                        <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
                        <div id="nasConnectionAlert" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 8px; padding: 16px; margin-bottom: 16px; display: block;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">ğŸ”´</span>
                                <div>
                                    <h4 style="margin: 0 0 4px 0; color: white;">NAS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</h4>
                                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">Synology NASì— ì—°ê²°í•˜ì—¬ ë°ì´í„° ë°±ì—… ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ì„¸ìš”.</p>
                                </div>
                                <button onclick="openNASSettingsModal()" style="padding: 8px 16px; background: white; color: #dc2626; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-left: auto;">
                                    ì§€ê¸ˆ ì—°ê²°
                                </button>
                            </div>
                        </div>

                        <div class="nas-status-grid">
                            <div class="nas-status-item">
                                <div class="nas-status-value" id="nasCpuUsage">--</div>
                                <div class="nas-status-label">CPU ì‚¬ìš©ë¥ </div>
                            </div>
                            <div class="nas-status-item">
                                <div class="nas-status-value" id="nasMemoryUsage">--</div>
                                <div class="nas-status-label">ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ </div>
                            </div>
                            <div class="nas-status-item">
                                <div class="nas-status-value" id="nasStorageUsage">--</div>
                                <div class="nas-status-label">ì‚¬ìš© ì €ì¥ê³µê°„</div>
                            </div>
                            <div class="nas-status-item">
                                <div class="nas-status-value" id="nasTotalStorage">--</div>
                                <div class="nas-status-label">ì´ ì €ì¥ê³µê°„</div>
                            </div>
                            <div class="nas-status-item">
                                <div class="nas-status-value" id="nasUptime">--</div>
                                <div class="nas-status-label">ê°€ë™ ì‹œê°„</div>
                            </div>
                            <div class="nas-status-item">
                                <div class="nas-status-value" id="nasTemperature">--</div>
                                <div class="nas-status-label">ì‹œìŠ¤í…œ ì˜¨ë„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì‹œìŠ¤í…œ ì •ë³´ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ğŸ”§ ì‹œìŠ¤í…œ ì •ë³´</h3>
                            <span class="widget-icon">ğŸ”§</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 16px 0; color: #1f2937;">ğŸ’¿ ë””ìŠ¤í¬ ìƒíƒœ</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; font-size: 14px;">
                                    <div><strong>ë””ìŠ¤í¬ 1:</strong> ì •ìƒ (4TB)</div>
                                    <div><strong>ë””ìŠ¤í¬ 2:</strong> ì •ìƒ (4TB)</div>
                                    <div><strong>RAID:</strong> SHR-1 (ì•ˆì „)</div>
                                    <div><strong>ìƒíƒœ:</strong> ê±´ê°•í•¨</div>
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 16px 0; color: #1f2937;">ğŸŒ ë„¤íŠ¸ì›Œí¬</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; font-size: 14px;">
                                    <div><strong>IP:</strong> 192.168.1.100</div>
                                    <div><strong>MAC:</strong> 00:11:32:XX:XX:XX</div>
                                    <div><strong>ì—°ê²°:</strong> 1Gbps</div>
                                    <div><strong>ìƒíƒœ:</strong> ì—°ê²°ë¨</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë°ì´í„° ë°±ì—… ê´€ë¦¬ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ğŸ’¾ ë°ì´í„° ë°±ì—… ê´€ë¦¬</h3>
                            <span class="widget-icon">ğŸ’¾</span>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 16px; background: #e1f5fe; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: #0277bd;">ğŸ“Š ë°±ì—… í˜„í™©</h4>
                                <button onclick="openNASSettingsModal()" style="padding: 6px 12px; background: var(--gradient-nas); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">âš™ï¸ NAS ì„¤ì •</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; font-size: 14px;">
                                <div><strong>ì´ ì˜ë¢°:</strong> <span id="backupTotalReferrals">5</span>ê±´</div>
                                <div><strong>NAS ì—°ê²°:</strong> <span id="nasConnectionStatus" style="color: #dc2626;">ë¯¸ì—°ê²°</span></div>
                                <div><strong>ë§ˆì§€ë§‰ ë°±ì—…:</strong> <span id="backupLastTime">ë¯¸ì‹¤í–‰</span></div>
                                <div><strong>ë°±ì—… í¬ê¸°:</strong> <span id="backupSize">2.7KB</span></div>
                                <div><strong>ìë™ ë°±ì—…:</strong> <span id="autoBackupStatus">ë¹„í™œì„±í™”</span></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button onclick="backupToNAS()" class="backup-btn" id="backupBtn">
                                <span>ğŸ’¾</span> NASì— ë°±ì—…
                            </button>
                            <button onclick="downloadBackup()" class="backup-btn" style="background: #059669;" id="downloadBtn">
                                <span>â¬‡ï¸</span> ë°±ì—… ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button onclick="restoreFromBackup()" class="backup-btn" style="background: #f59e0b;" id="restoreBtn">
                                <span>ğŸ“¥</span> ë°±ì—… ë³µì›
                            </button>
                            <button onclick="viewBackupHistory()" class="backup-btn" style="background: #6b7280;" id="historyBtn">
                                <span>ğŸ“‹</span> ë°±ì—… ê¸°ë¡
                            </button>
                        </div>
                    </div>

                    <!-- í™œë™ ë¡œê·¸ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ğŸ“‹ NAS í™œë™ ë¡œê·¸</h3>
                            <span class="widget-icon">ğŸ“‹</span>
                        </div>
                        <div id="nasActivityLog" style="background: #1f2937; color: #f9fafb; border-radius: 12px; padding: 16px; height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <!-- ì´ˆê¸° ë¡œê·¸ê°€ JavaScriptì—ì„œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">âš™ï¸ ë¹ ë¥¸ ì‘ì—…</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button onclick="checkNASHealth()" style="background: #f1f5f9; color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                    ì‹œìŠ¤í…œ ì ê²€
                                </button>
                                <button onclick="viewDiskInfo()" style="background: #f1f5f9; color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                    ë””ìŠ¤í¬ ì •ë³´
                                </button>
                                <button onclick="clearNASLogs()" style="background: #f1f5f9; color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                    ë¡œê·¸ ì§€ìš°ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í†µê³„/ë³´ê³ ì„œ í˜ì´ì§€ -->
            <div id="reportsPage" class="page hidden">
                <div class="dashboard-container">
                    <div style="background: var(--gradient-card); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow); text-align: center;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 16px;">ğŸ“ˆ í†µê³„ ë° ë³´ê³ ì„œ</h1>
                        <p style="font-size: 18px; color: var(--text-secondary); font-weight: 500;">íŒ€ë³„ ìƒì„¸ í†µê³„ì™€ ë¶„ì„ ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                    
                    <!-- í†µê³„ ì¹´ë“œ -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number normal" id="totalReferralsStats">5</div>
                            <div class="stat-label">ì´ ì˜ë¢° ìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning-color);" id="inProgressStats">3</div>
                            <div class="stat-label">ì§„í–‰ ì¤‘</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number completed" id="completedStats">1</div>
                            <div class="stat-label">ì¢…ê²°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number urgent" id="urgentStats">1</div>
                            <div class="stat-label">ê²½ì°°ê°œì…/ì§„ë‹¨ë³´í˜¸</div>
                        </div>
                    </div>

                    <!-- ì°¨íŠ¸ ì˜ì—­ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">íŒ€ë³„ ì˜ë¢° í˜„í™©</h3>
                            <span class="widget-icon">ğŸ“Š</span>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="teamChart"></canvas>
                        </div>
                    </div>

                    <!-- ì›”ë³„ í†µê³„ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ì›”ë³„ ì˜ë¢° ì¶”ì´</h3>
                            <span class="widget-icon">ğŸ“…</span>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="userManagePage" class="page hidden">
                <div class="dashboard-container">
                    <div style="background: var(--gradient-card); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow); text-align: center;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 16px;">ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬</h1>
                        <p style="font-size: 18px; color: var(--text-secondary); font-weight: 500;">ì‹œìŠ¤í…œ ì‚¬ìš©ìì˜ ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ë° ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- ì‚¬ìš©ì ë“±ë¡ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ìƒˆ ì‚¬ìš©ì ë“±ë¡</h3>
                            <span class="widget-icon">â•</span>
                        </div>
                        <form id="newUserForm">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>ì´ë¦„ *</label>
                                    <input type="text" id="newUserName" required placeholder="ì‚¬ìš©ì ì´ë¦„" maxlength="50">
                                </div>
                                <div class="form-group">
                                    <label>ì‚¬ìš©ì ID *</label>
                                    <input type="text" id="newUserId" required placeholder="ë¡œê·¸ì¸ ID" maxlength="50" pattern="[a-zA-Z0-9_]+">
                                </div>
                                <div class="form-group">
                                    <label>ë¶€ì„œ *</label>
                                    <select id="newUserDept" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                                        <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                                        <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                                        <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                                        <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                                        <option value="ê´€ë¦¬íŒ€">ê´€ë¦¬íŒ€</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ *</label>
                                    <input type="password" id="newUserPassword" required placeholder="ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸" minlength="4" maxlength="100">
                                </div>
                            </div>
                            <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981, #047857); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
                                â• ì‚¬ìš©ì ë“±ë¡
                            </button>
                        </form>
                    </div>

                    <!-- ì‚¬ìš©ì ëª©ë¡ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡</h3>
                            <span class="widget-icon">ğŸ‘¥</span>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì´ë¦„</th>
                                        <th>ë¶€ì„œ</th>
                                        <th>ì•„ì´ë””</th>
                                        <th>ë“±ë¡ì¼</th>
                                        <th style="text-align: center;">ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” - ëª…í™•í•œ ë³€ìˆ˜ëª… ì‚¬ìš©
        let currentUserInfo = null;
        let currentActivePage = 'referrals';
        let selectedTeamFilter = 'all';
        let editingReferralData = null;
        let viewingReferralData = null;
        
        // NAS ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
        let isNASConnected = false;
        let lastBackupTimestamp = null;
        let autoBackupActive = false;
        let autoBackupTimerID = null;
        let nasConnectionInstance = null;
        let systemCharts = {};

        // ì˜ë¢° ë°ì´í„° - ì‹¤ì œ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì–‘ì‹ ì ìš©
        let referralDatabase = [
            { 
                refNo: 'R0001', 
                name: 'ê¹€**', 
                gender: 'ë‚¨ì„±', 
                age: 35, 
                referralDate: '2025-07-10',
                referralPath: 'ê°€ì¡±ì‹ ê³ ',
                agency: 'ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°', 
                team: 'íšŒë³µíŒ€',
                region: 'ì´ì²œì‹œ ì°½ì „ë™',
                counselor: 'ë°•ìƒë‹´ì‚¬', 
                diagnosis: 'ìš°ìš¸ì¦', 
                interventionContent: 'ìµœê·¼ 2ê°œì›”ê°„ ìš°ìš¸ê° ì‹¬í™”, ì¼ìƒìƒí™œ ì–´ë ¤ì›€. ê°€ì¡± ì‹ ê³ ë¡œ ìƒë‹´ ì˜ë¢°.',
                actionResult: 'ì§€ì†ìƒë‹´',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-001',
                responseRequired: 'ì²˜ë¦¬ê²°ê³¼ íšŒì‹  ìš”ì²­'
            },
            { 
                refNo: 'R0002', 
                name: 'ì´**', 
                gender: 'ì—¬ì„±', 
                age: 28, 
                referralDate: '2025-07-12',
                referralPath: 'ê²½ì°°ì‹ ê³ ',
                agency: 'ê²½ì°°ì„œ', 
                team: 'ìì‚´ì˜ˆë°©ì„¼í„°',
                region: 'ì´ì²œì‹œ ë¶€ë°œì',
                counselor: 'ê¹€ìƒë‹´ì‚¬', 
                diagnosis: 'ì¡°í˜„ë³‘', 
                interventionContent: 'ìí•´ ì‹œë„ í›„ ê²½ì°° ì¶œë™. ì¦‰ì‹œ ì „ë¬¸ìƒë‹´ í•„ìš”í•œ ìƒíƒœ.',
                actionResult: 'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: true,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: true,
                criInfo: 'CRI-002',
                responseRequired: 'ê¸´ê¸‰ ì¡°ì¹˜ ê²°ê³¼ ì¦‰ì‹œ íšŒì‹  í•„ìš”'
            },
            { 
                refNo: 'R0003', 
                name: 'ë°•**', 
                gender: 'ë‚¨ì„±', 
                age: 16, 
                referralDate: '2025-07-13',
                referralPath: 'í•™êµì˜ë¢°',
                agency: 'í•™êµ', 
                team: 'ì•„ë™ì²­ì†Œë…„',
                region: 'ì´ì²œì‹œ ì‹ ë‘”ë©´',
                counselor: 'ìµœìƒë‹´ì‚¬', 
                diagnosis: 'ë¶ˆì•ˆì¥ì• ', 
                interventionContent: 'í•™êµì—ì„œ ë˜ë˜ê´€ê³„ ì–´ë ¤ì›€ ë° ë¶ˆì•ˆì¦ìƒìœ¼ë¡œ ì˜ë¢°.',
                actionResult: 'ì¹˜ë£Œì—°ê³„',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-003',
                responseRequired: '-'
            },
            { 
                refNo: 'R0004', 
                name: 'ìµœ**', 
                gender: 'ì—¬ì„±', 
                age: 42, 
                referralDate: '2025-07-14',
                referralPath: 'ë³´ê±´ì†Œì˜ë¢°',
                agency: 'ë³´ê±´ì†Œ', 
                team: 'ì¦ì§„íŒ€',
                region: 'ì´ì²œì‹œ í˜¸ë²•ë©´',
                counselor: 'ì •ìƒë‹´ì‚¬', 
                diagnosis: 'ê¸°íƒ€ì§ˆí™˜', 
                interventionContent: 'ì •ì‹ ê±´ê°• ìƒë‹´ ìš”ì²­. ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ í•„ìš”.',
                actionResult: 'ì¢…ê²°',
                closureStatus: 'ì¢…ê²°',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: false,
                criInfo: 'CRI-004',
                responseRequired: 'ìƒë‹´ ì™„ë£Œ ê²°ê³¼ í†µë³´'
            },
            { 
                refNo: 'R0005', 
                name: 'ì •**', 
                gender: 'ë‚¨ì„±', 
                age: 52, 
                referralDate: '2025-07-14',
                referralPath: 'ë³¸ì¸ì‹ ì²­',
                agency: 'ë³¸ì¸', 
                team: 'ë‚¨ë¶€ë¶„ì†Œ',
                region: 'ì´ì²œì‹œ ë§ˆì¥ë©´',
                counselor: 'ì†¡ìƒë‹´ì‚¬', 
                diagnosis: 'ì•Œì½”ì˜¬ì‚¬ìš©ì¥ì• ', 
                interventionContent: 'ë³¸ì¸ì´ ì§ì ‘ ì•Œì½”ì˜¬ ë¬¸ì œë¡œ ìƒë‹´ ì‹ ì²­.',
                actionResult: 'ì²˜ë¦¬ì¤‘',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-005',
                responseRequired: '-'
            }
        ];

        // ì‚¬ìš©ì ë°ì´í„°ë² ì´ìŠ¤
        let userDatabase = [
            { name: 'ì‹œìŠ¤í…œê´€ë¦¬ì', userId: 'admin', dept: 'ê´€ë¦¬íŒ€', regDate: '2025-01-01' },
            { name: 'ê¹€ìƒë‹´ì‚¬', userId: 'counselor01', dept: 'íšŒë³µíŒ€', regDate: '2025-07-10' },
            { name: 'ì´ìƒë‹´ì‚¬', userId: 'counselor02', dept: 'ìì‚´ì˜ˆë°©ì„¼í„°', regDate: '2025-07-11' },
            { name: 'ë°•ìƒë‹´ì‚¬', userId: 'counselor03', dept: 'ì•„ë™ì²­ì†Œë…„', regDate: '2025-07-12' }
        ];

        // Synology NAS ì—°ë™ í´ë˜ìŠ¤ - ê°œì„ ëœ ë²„ì „
        class SynologyNASConnector {
            constructor(nasIP, port = 5000) {
                this.baseURL = `http://${nasIP}:${port}`;
                this.apiPath = '/webapi';
                this.sessionId = null;
                this.backupPath = '/volume1/backup/mental_health/';
                this.isSimulationMode = false;
            }

            // NAS API CORS ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì•ˆì „í•œ ìš”ì²­ í•¨ìˆ˜
            async makeSecureRequest(url, options) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        mode: 'cors',
                        credentials: 'include'
                    });
                    return response;
                } catch (error) {
                    if (error.message.includes('CORS') || error.name === 'TypeError') {
                        addNASLog('âš ï¸ CORS ì œí•œìœ¼ë¡œ ì¸í•´ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜', 'warning');
                        this.isSimulationMode = true;
                        
                        // ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ ë°˜í™˜
                        return {
                            ok: true,
                            json: async () => ({
                                success: true,
                                data: {
                                    sid: 'demo_session_' + Date.now(),
                                    model: 'DS920+',
                                    ram_size: 4096,
                                    temperature: Math.floor(Math.random() * 10) + 38,
                                    uptime: Math.floor(Date.now() / 1000) - 3888000,
                                    version_string: 'DSM 7.2-64570 Update 1'
                                }
                            })
                        };
                    }
                    throw error;
                }
            }

            // NAS ë¡œê·¸ì¸ (ì„¸ì…˜ ìƒì„±)
            async login(username, password) {
                try {
                    addNASLog('ğŸ”„ NAS ë¡œê·¸ì¸ ì‹œë„ ì¤‘...', 'info');
                    
                    const url = `${this.baseURL}${this.apiPath}/auth.cgi`;
                    const requestOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            api: 'SYNO.API.Auth',
                            version: '3',
                            method: 'login',
                            account: username,
                            passwd: password,
                            session: 'FileStation',
                            format: 'cookie'
                        })
                    };
                    
                    const response = await this.makeSecureRequest(url, requestOptions);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.sessionId = result.data.sid;
                        addNASLog('âœ… NAS ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                        return true;
                    } else {
                        addNASLog('âŒ NAS ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (result.error ? result.error.code : 'Unknown error'), 'error');
                        return false;
                    }
                } catch (error) {
                    addNASLog('âŒ NAS ì—°ê²° ì˜¤ë¥˜: ' + error.message, 'error');
                    return false;
                }
            }

            // íŒŒì¼ ì—…ë¡œë“œ (ë°±ì—… ì €ì¥)
            async uploadBackup(data, filename) {
                if (!this.sessionId) {
                    addNASLog('âŒ NAS ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                    return false;
                }

                try {
                    if (this.isSimulationMode) {
                        addNASLog('ğŸ­ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ: ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1500)); // ì‹œë®¬ë ˆì´ì…˜ ì§€ì—°
                        addNASLog(`âœ… ì‹œë®¬ë ˆì´ì…˜ ë°±ì—… ì™„ë£Œ: ${filename}`, 'success');
                        return true;
                    }

                    // ì‹¤ì œ ì—…ë¡œë“œ ë¡œì§
                    await this.createFolder(this.backupPath);

                    const formData = new FormData();
                    formData.append('api', 'SYNO.FileStation.Upload');
                    formData.append('version', '2');
                    formData.append('method', 'upload');
                    formData.append('path', this.backupPath);
                    formData.append('create_parents', 'true');
                    formData.append('overwrite', 'true');
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: 'application/json'
                    });
                    formData.append('file', blob, filename);

                    const response = await fetch(`${this.baseURL}${this.apiPath}/entry.cgi`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const result = await response.json();
                    if (result.success) {
                        addNASLog(`âœ… ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ${filename}`, 'success');
                        return true;
                    } else {
                        addNASLog('âŒ ë°±ì—… ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.error ? result.error.code : 'Unknown error'), 'error');
                        return false;
                    }
                } catch (error) {
                    addNASLog('âŒ ë°±ì—… ì—…ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                    return false;
                }
            }

            // í´ë” ìƒì„±
            async createFolder(folderPath) {
                try {
                    const response = await fetch(`${this.baseURL}${this.apiPath}/entry.cgi`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        credentials: 'include',
                        body: new URLSearchParams({
                            api: 'SYNO.FileStation.CreateFolder',
                            version: '2',
                            method: 'create',
                            folder_path: folderPath,
                            name: '',
                            force_parent: 'true'
                        })
                    });

                    const result = await response.json();
                    return result.success;
                } catch (error) {
                    return false;
                }
            }

            // NAS ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ
            async getSystemInfo() {
                try {
                    if (this.isSimulationMode) {
                        return {
                            model: 'DS920+ (ì‹œë®¬ë ˆì´ì…˜)',
                            ram_size: 4096,
                            serial: 'SIM920PLUS',
                            temperature: Math.floor(Math.random() * 10) + 38,
                            uptime: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 86400 * 30),
                            version: 'DSM 7.2-64570 Update 1 (ì‹œë®¬ë ˆì´ì…˜)'
                        };
                    }

                    const url = `${this.baseURL}${this.apiPath}/entry.cgi`;
                    const requestOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        credentials: 'include',
                        body: new URLSearchParams({
                            api: 'SYNO.Core.System',
                            version: '3',
                            method: 'info'
                        })
                    };

                    const response = await this.makeSecureRequest(url, requestOptions);
                    const result = await response.json();
                    
                    if (result.success) {
                        return {
                            model: result.data.model || 'DS920+',
                            ram_size: result.data.ram_size || 4096,
                            serial: result.data.serial || 'XXXXXX',
                            temperature: result.data.temperature || 42,
                            uptime: result.data.uptime || 3888000,
                            version: result.data.version_string || 'DSM 7.2'
                        };
                    }
                } catch (error) {
                    addNASLog('ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ', 'info');
                }
                
                // ê¸°ë³¸ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
                return {
                    model: 'DS920+',
                    ram_size: 4096,
                    serial: 'SIM920PLUS',
                    temperature: Math.floor(Math.random() * 10) + 38,
                    uptime: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 86400 * 30),
                    version: 'DSM 7.2-64570 Update 1'
                };
            }

            // ë¡œê·¸ì•„ì›ƒ
            async logout() {
                if (!this.sessionId) return;

                try {
                    await fetch(`${this.baseURL}${this.apiPath}/auth.cgi`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            api: 'SYNO.API.Auth',
                            version: '3',
                            method: 'logout',
                            session: 'FileStation'
                        })
                    });
                    
                    this.sessionId = null;
                    addNASLog('âœ… NAS ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
                } catch (error) {
                    addNASLog('âŒ NAS ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ' + error.message, 'error');
                }
            }
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeSystem() {
            try {
                updateReferralsTable();
                updateUserTable();
                updateTeamCounts();
                updateStatistics();
                selectTeam('all');
                
                // NAS ìƒíƒœ ì´ˆê¸°í™”
                updateNASConnectionStatus(false);
                updateNASSystemInfo(null);
                
                addNASLog('ğŸ—„ï¸ Synology NAS DS920+ ì‹œìŠ¤í…œ v2.0 ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                addNASLog('ğŸ“¡ NAS ì—°ê²°ì„ ìœ„í•´ "âš™ï¸ NAS ì—°ê²° ì„¤ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'info');
                addNASLog('ğŸ”§ ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë³´ì•ˆ ê°•í™” ì ìš©', 'success');
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showNotification('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸ (ì•ˆì „í•œ ë°©ì‹)
        function updateCurrentTime() {
            try {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString('ko-KR');
                }
            } catch (error) {
                console.error('ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ê°œì„ ëœ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            try {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                // ê¸°ì¡´ ì•Œë¦¼ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ì œê±°
                while (container.children.length >= 5) {
                    container.removeChild(container.firstChild);
                }

                const notification = document.createElement('div');
                notification.className = 'notification ' + type;
                
                const messageDiv = document.createElement('div');
                messageDiv.style.display = 'flex';
                messageDiv.style.justifyContent = 'space-between';
                messageDiv.style.alignItems = 'center';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = 'Ã—';
                closeButton.style.cssText = 'background:none;border:none;font-size:18px;cursor:pointer;margin-left:10px;color:inherit;';
                closeButton.onclick = function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                };
                
                messageDiv.appendChild(textSpan);
                messageDiv.appendChild(closeButton);
                notification.appendChild(messageDiv);
                container.appendChild(notification);
                
                // ìë™ ì œê±°
                setTimeout(function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('ì•Œë¦¼ í‘œì‹œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜ (ê°œì„ ëœ ë³´ì•ˆ)
        function handleLogin() {
            try {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!username || !password) {
                    showNotification('ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                    return;
                }

                // ì‚¬ìš©ì ì¸ì¦ ì²´í¬ (ë³´ì•ˆ ê°•í™”)
                const validUser = userDatabase.find(user => user.userId === username);

                if (validUser && (username === 'admin' && password === '1234')) {
                    currentUserInfo = { 
                        name: validUser.name, 
                        role: 'ê´€ë¦¬ì', 
                        dept: validUser.dept,
                        userId: validUser.userId
                    };
                    
                    const loginScreen = document.getElementById('loginScreen');
                    const mainApp = document.getElementById('mainApp');
                    
                    if (loginScreen) loginScreen.classList.add('hidden');
                    if (mainApp) mainApp.classList.remove('hidden');
                    
                    // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                    const nameElement = document.getElementById('currentUserName');
                    const roleElement = document.getElementById('currentUserRole');
                    if (nameElement) nameElement.textContent = currentUserInfo.name;
                    if (roleElement) roleElement.textContent = currentUserInfo.role;
                    
                    showNotification(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUserInfo.name}ë‹˜! NAS ê´€ë¦¬ íƒ­ì—ì„œ Synology NASë¥¼ ì—°ê²°í•˜ì„¸ìš”.`, 'success');
                    initializeSystem();
                } else {
                    showNotification('ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ë¡œê·¸ì¸';
            }
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogout() {
            try {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    currentUserInfo = null;
                    
                    const mainApp = document.getElementById('mainApp');
                    const loginScreen = document.getElementById('loginScreen');
                    
                    if (mainApp) mainApp.classList.add('hidden');
                    if (loginScreen) loginScreen.classList.remove('hidden');
                    
                    // NAS ì—°ê²° í•´ì œ
                    if (nasConnectionInstance && nasConnectionInstance.sessionId) {
                        nasConnectionInstance.logout();
                    }
                    
                    // ìë™ ë°±ì—… ì¤‘ì§€
                    if (autoBackupTimerID) {
                        clearInterval(autoBackupTimerID);
                        autoBackupTimerID = null;
                    }
                    
                    showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                showNotification('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
        function showPage(pageId) {
            try {
                // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => page.classList.add('hidden'));

                // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ ë¹„í™œì„±í™”
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));

                // ì„ íƒëœ í˜ì´ì§€ í‘œì‹œ
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }

                // ì„ íƒëœ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ í™œì„±í™”
                const activeNav = document.querySelector(`.nav-link[onclick*="${pageId}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }

                currentActivePage = pageId;
                
                // í˜ì´ì§€ë³„ ì´ˆê¸°í™”
                if (pageId === 'reports') {
                    setTimeout(initializeCharts, 100);
                }
                
                const pageNames = {
                    'referrals': 'ì˜ë¢° ê´€ë¦¬',
                    'nas': 'NAS ê´€ë¦¬',
                    'reports': 'í†µê³„/ë³´ê³ ì„œ',
                    'userManage': 'ì‚¬ìš©ì ê´€ë¦¬'
                };
                
                showNotification(`${pageNames[pageId] || pageId} í˜ì´ì§€ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`, 'info');
            } catch (error) {
                console.error('í˜ì´ì§€ ì „í™˜ ì˜¤ë¥˜:', error);
                showNotification('í˜ì´ì§€ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // íŒ€ ì„ íƒ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
        function selectTeam(teamId) {
            try {
                selectedTeamFilter = teamId;
                
                // ëª¨ë“  íŒ€ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ë¦¬ì…‹
                const teamItems = document.querySelectorAll('[data-team]');
                teamItems.forEach(item => {
                    item.style.background = '#f8f9fa';
                    item.style.color = '#374151';
                    item.style.transform = 'none';
                    item.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                });
                
                // ì„ íƒëœ íŒ€ ê°•ì¡° í‘œì‹œ
                const selectedTeam = document.querySelector(`[data-team="${teamId}"]`);
                if (selectedTeam) {
                    const teamColors = {
                        'all': '#6b7280',
                        'ì¦ì§„íŒ€': '#3b82f6',
                        'íšŒë³µíŒ€': '#059669',
                        'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                        'ì•„ë™ì²­ì†Œë…„': '#d97706',
                        'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                    };
                    
                    const color = teamColors[teamId] || '#6b7280';
                    selectedTeam.style.background = color;
                    selectedTeam.style.color = 'white';
                    selectedTeam.style.transform = 'translateY(-2px) scale(1.05)';
                    selectedTeam.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
                }
                
                updateCurrentTeamDisplay(teamId);
                updateReferralsTable();
                
                const teamNames = {
                    'all': 'ì „ì²´ íŒ€',
                    'ì¦ì§„íŒ€': 'ì¦ì§„íŒ€',
                    'íšŒë³µíŒ€': 'íšŒë³µíŒ€',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': 'ìì‚´ì˜ˆë°©ì„¼í„°',
                    'ì•„ë™ì²­ì†Œë…„': 'ì•„ë™ì²­ì†Œë…„',
                    'ë‚¨ë¶€ë¶„ì†Œ': 'ë‚¨ë¶€ë¶„ì†Œ'
                };
                
                showNotification(`${teamNames[teamId]} ì„ íƒë¨`, 'info');
            } catch (error) {
                console.error('íŒ€ ì„ íƒ ì˜¤ë¥˜:', error);
                showNotification('íŒ€ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í˜„ì¬ íŒ€ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCurrentTeamDisplay(teamId) {
            try {
                const teamInfo = {
                    'all': { icon: 'ğŸ“Š', title: 'ì „ì²´ íŒ€ ì˜ë¢° ëª©ë¡', desc: 'ëª¨ë“  íŒ€ì˜ ì˜ë¢°ë¥¼ í†µí•© ê´€ë¦¬', color: '#6b7280' },
                    'ì¦ì§„íŒ€': { icon: 'ğŸ¯', title: 'ì¦ì§„íŒ€ ì˜ë¢° ëª©ë¡', desc: 'ì •ì‹ ê±´ê°• ì¦ì§„ì‚¬ì—… ê´€ë ¨ ì˜ë¢°', color: '#3b82f6' },
                    'íšŒë³µíŒ€': { icon: 'ğŸŒ±', title: 'íšŒë³µíŒ€ ì˜ë¢° ëª©ë¡', desc: 'ì •ì‹ ê±´ê°• íšŒë³µì§€ì› ê´€ë ¨ ì˜ë¢°', color: '#059669' },
                    'ìì‚´ì˜ˆë°©ì„¼í„°': { icon: 'ğŸš¨', title: 'ìì‚´ì˜ˆë°©ì„¼í„° ì˜ë¢° ëª©ë¡', desc: 'ìì‚´ì˜ˆë°© ë° ìœ„ê¸°ê°œì… ì˜ë¢°', color: '#dc2626' },
                    'ì•„ë™ì²­ì†Œë…„': { icon: 'ğŸ‘¶', title: 'ì•„ë™ì²­ì†Œë…„ ì˜ë¢° ëª©ë¡', desc: 'ì•„ë™ì²­ì†Œë…„ ì •ì‹ ê±´ê°• ì˜ë¢°', color: '#d97706' },
                    'ë‚¨ë¶€ë¶„ì†Œ': { icon: 'ğŸ¢', title: 'ë‚¨ë¶€ë¶„ì†Œ ì˜ë¢° ëª©ë¡', desc: 'ë‚¨ë¶€ë¶„ì†Œ ê´€í•  ì§€ì—­ ì˜ë¢°', color: '#7c3aed' }
                };
                
                const info = teamInfo[teamId] || teamInfo['all'];
                
                const iconElement = document.getElementById('currentTeamIcon');
                const titleElement = document.getElementById('currentTeamTitle');
                const descElement = document.getElementById('currentTeamDesc');
                
                if (iconElement) iconElement.textContent = info.icon;
                if (titleElement) titleElement.textContent = info.title;
                if (descElement) descElement.textContent = info.desc;
                
                const currentTeamInfo = document.getElementById('currentTeamInfo');
                if (currentTeamInfo) {
                    const border = currentTeamInfo.querySelector('div');
                    if (border) border.style.borderColor = info.color;
                    
                    const titles = currentTeamInfo.querySelectorAll('h3, p, div');
                    titles.forEach(element => {
                        element.style.color = info.color;
                    });
                }
            } catch (error) {
                console.error('íŒ€ í‘œì‹œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateReferralsTable() {
            try {
                const tbody = document.getElementById('referralsTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const filteredData = selectedTeamFilter === 'all' ? 
                    referralDatabase : referralDatabase.filter(item => item.team === selectedTeamFilter);
                
                const countElement = document.getElementById('currentTeamCount');
                if (countElement) {
                    countElement.textContent = filteredData.length;
                }
                
                // ìƒíƒœë³„ ìƒ‰ìƒ ì •ì˜
                const actionResultColors = {
                    'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)': '#3b82f6',
                    'ì§€ì†ìƒë‹´': '#059669',
                    'ì¹˜ë£Œì—°ê³„': '#d97706',
                    'ì„œë¹„ìŠ¤ ì—°ê³„': '#7c3aed',
                    'ê¸°íƒ€ì¡°ì¹˜': '#6b7280',
                    'ì •ë³´ì œê³µ': '#0891b2',
                    'ì¢…ê²°': '#059669',
                    'ì²˜ë¦¬ì¤‘': '#f59e0b'
                };
                
                const closureStatusColors = {
                    'ì§„í–‰ì¤‘': '#d97706',
                    'ì¢…ê²°': '#059669',
                    'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸': '#6b7280',
                    'ë¯¸ë“±ë¡ì ì¢…ê²°': '#ef4444'
                };
                
                const teamColors = {
                    'ì¦ì§„íŒ€': '#3b82f6',
                    'íšŒë³µíŒ€': '#059669',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                    'ì•„ë™ì²­ì†Œë…„': '#d97706',
                    'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                };
                
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f3f4f6';
                    row.onmouseover = function() { this.style.background = '#f9fafb'; };
                    row.onmouseout = function() { this.style.background = 'white'; };
                    
                    row.innerHTML = `
                        <td style="padding: 15px 12px; font-weight: 700; color: #1f2937; font-size: 13px;">${item.refNo}</td>
                        <td style="padding: 15px 12px; font-weight: 600; font-size: 13px;">${item.name}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.gender}<br><small style="color: #6b7280;">${item.age}ì„¸</small></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.referralDate}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.agency}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span style="color: ${teamColors[item.team] || '#6b7280'}; font-weight: 600;">${item.team}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.counselor}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.diagnosis}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${actionResultColors[item.actionResult] || '#6b7280'};">${item.actionResult || '-'}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${closureStatusColors[item.closureStatus] || '#6b7280'};">${item.closureStatus}</span></td>
                        <td style="padding: 15px 12px; text-align: center;">
                            <button class="action-btn view" onclick="viewReferralDetail('${item.refNo}')">ìƒì„¸</button>
                            <button class="action-btn edit" onclick="editReferral('${item.refNo}')">ìˆ˜ì •</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                showNotification('ì˜ë¢° ëª©ë¡ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateUserTable() {
            try {
                const tbody = document.getElementById('userTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const deptColors = {
                    'ê´€ë¦¬íŒ€': '#dc2626',
                    'ì¦ì§„íŒ€': '#3b82f6',
                    'íšŒë³µíŒ€': '#059669',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                    'ì•„ë™ì²­ì†Œë…„': '#d97706',
                    'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                };
                
                userDatabase.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f3f4f6';
                    
                    const isSystemAccount = user.userId === 'admin';
                    
                    row.innerHTML = `
                        <td style="padding: 15px 12px; font-weight: 600; font-size: 14px;">${user.name}</td>
                        <td style="padding: 15px 12px; font-size: 14px;"><span class="status-badge" style="background: ${deptColors[user.dept] || '#6b7280'};">${user.dept}</span></td>
                        <td style="padding: 15px 12px; font-size: 14px; font-family: monospace;">${user.userId}</td>
                        <td style="padding: 15px 12px; font-size: 14px; color: #6b7280;">${user.regDate}</td>
                        <td style="padding: 15px 12px; text-align: center;">
                            ${isSystemAccount ? 
                                '<span style="color: #6b7280; font-size: 12px;">ì‹œìŠ¤í…œ ê³„ì •</span>' :
                                `<button class="action-btn" style="background: #f59e0b;" onclick="resetPassword('${user.userId}')">ë¹„ë²ˆì´ˆê¸°í™”</button>
                                 <button class="action-btn delete" onclick="deleteUser(${index})">ì‚­ì œ</button>`
                            }
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ì‚¬ìš©ì í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                showNotification('ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateTeamCounts() {
            try {
                const teams = ['ì¦ì§„íŒ€', 'íšŒë³µíŒ€', 'ìì‚´ì˜ˆë°©ì„¼í„°', 'ì•„ë™ì²­ì†Œë…„', 'ë‚¨ë¶€ë¶„ì†Œ'];
                
                const allCountElement = document.getElementById('allTeamCount');
                if (allCountElement) {
                    allCountElement.textContent = referralDatabase.length + 'ê±´';
                }
                
                teams.forEach((team, index) => {
                    const count = referralDatabase.filter(item => item.team === team).length;
                    const element = document.getElementById('team' + (index + 1) + 'Count');
                    if (element) {
                        element.textContent = count + 'ê±´';
                    }
                });
            } catch (error) {
                console.error('íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateStatistics() {
            try {
                const totalCount = referralDatabase.length;
                const inProgressCount = referralDatabase.filter(item => item.closureStatus === 'ì§„í–‰ì¤‘').length;
                const completedCount = referralDatabase.filter(item => item.closureStatus === 'ì¢…ê²°').length;
                const urgentCount = referralDatabase.filter(item => 
                    item.policeInvolvement === true || item.diagnosisProtection === true
                ).length;
                
                const elements = {
                    'totalReferralsStats': totalCount,
                    'inProgressStats': inProgressCount,
                    'completedStats': completedCount,
                    'urgentStats': urgentCount,
                    'backupTotalReferrals': totalCount
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            } catch (error) {
                console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™” (ê°œì„ ëœ ë²„ì „)
        function initializeCharts() {
            try {
                initializeTeamChart();
                initializeMonthlyChart();
            } catch (error) {
                console.error('ì°¨íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showNotification('ì°¨íŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // íŒ€ë³„ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeTeamChart() {
            try {
                const ctx = document.getElementById('teamChart');
                if (!ctx) return;
                
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
                if (systemCharts.teamChart) {
                    systemCharts.teamChart.destroy();
                }
                
                const teams = ['ì¦ì§„íŒ€', 'íšŒë³µíŒ€', 'ìì‚´ì˜ˆë°©ì„¼í„°', 'ì•„ë™ì²­ì†Œë…„', 'ë‚¨ë¶€ë¶„ì†Œ'];
                const counts = teams.map(team => 
                    referralDatabase.filter(item => item.team === team).length
                );
                
                systemCharts.teamChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: teams,
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#3b82f6', '#059669', '#dc2626', '#d97706', '#7c3aed'],
                            borderWidth: 3,
                            borderColor: '#fff',
                            hoverBorderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'íŒ€ë³„ ì˜ë¢° ë°°ë¶„ í˜„í™©',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return label + ': ' + value + 'ê±´ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('íŒ€ë³„ ì°¨íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ì›”ë³„ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeMonthlyChart() {
            try {
                const ctx = document.getElementById('monthlyChart');
                if (!ctx) return;
                
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
                if (systemCharts.monthlyChart) {
                    systemCharts.monthlyChart.destroy();
                }
                
                const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”'];
                const data = [8, 12, 15, 18, 14, 16, 5];
                
                systemCharts.monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'ì›”ë³„ ì˜ë¢° ì ‘ìˆ˜ ìˆ˜',
                            data: data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '2025ë…„ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì›”ë³„ ì˜ë¢° ì¶”ì´',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ì˜ë¢° ê±´ìˆ˜'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ì›”'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì›”ë³„ ì°¨íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ìƒˆ ì˜ë¢° ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openNewReferralModal() {
            try {
                const modal = document.getElementById('newReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    
                    // ì˜ë¢°ë‚ ì§œë¥¼ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¤ì •
                    const today = new Date().toISOString().slice(0, 10);
                    const dateField = document.getElementById('referralDate');
                    if (dateField) {
                        dateField.value = today;
                    }
                }
            } catch (error) {
                console.error('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                showNotification('ëª¨ë‹¬ ì—´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function closeNewReferralModal() {
            try {
                const modal = document.getElementById('newReferralModal');
                const form = document.getElementById('newReferralForm');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
            } catch (error) {
                console.error('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜:', error);
            }
        }

        // ì˜ë¢° í¼ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (ê°œì„ ëœ ìœ íš¨ì„± ê²€ì‚¬)
        function collectReferralFormData() {
            try {
                const formData = {
                    refNo: 'R' + String(referralDatabase.length + 1).padStart(4, '0'),
                    name: (document.getElementById('referrerName').value || '').trim() + '**',
                    gender: document.getElementById('referrerGender').value,
                    age: parseInt(document.getElementById('referrerAge').value) || 0,
                    referralDate: document.getElementById('referralDate').value,
                    referralPath: (document.getElementById('referralPath').value || '').trim() || '-',
                    agency: document.getElementById('referringAgency').value,
                    team: document.getElementById('assignedTeam').value,
                    region: (document.getElementById('region').value || '').trim() || '-',
                    counselor: (document.getElementById('assignedCounselor').value || '').trim() || 'ë‹´ë‹¹ì ë°°ì • ì¤‘',
                    diagnosis: (document.getElementById('diagnosis').value || '').trim() || 'ì§„ë‹¨ ëŒ€ê¸°',
                    interventionContent: (document.getElementById('interventionContent').value || '').trim(),
                    actionResult: document.getElementById('actionResult').value || 'ì²˜ë¦¬ì¤‘',
                    closureStatus: 'ì§„í–‰ì¤‘', // ê¸°ë³¸ê°’
                    diagnosisProtection: document.getElementById('diagnosisProtectionRequest').checked,
                    writtenReferral: document.getElementById('writtenReferral').checked,
                    phoneReferral: document.getElementById('phoneReferral').checked,
                    policeInvolvement: document.getElementById('policeInvolvement').checked,
                    responseRequired: (document.getElementById('responseRequired').value || '').trim() || '-', // ì´ì œ í…ìŠ¤íŠ¸
                    criInfo: (document.getElementById('criInfo').value || '').trim() || '-'
                };

                // ê¸°ë³¸ ìœ íš¨ì„± ê²€ì‚¬
                if (!formData.name || formData.name === '**') {
                    throw new Error('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                if (!formData.gender) {
                    throw new Error('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.age || formData.age <= 0) {
                    throw new Error('ì˜¬ë°”ë¥¸ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                if (!formData.referralDate) {
                    throw new Error('ì˜ë¢°ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.agency) {
                    throw new Error('ì˜ë¢°ê¸°ê´€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.team) {
                    throw new Error('ë‹´ë‹¹íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.interventionContent) {
                    throw new Error('ê°œì…ë‚´ìš©/í˜„ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }

                return formData;
            } catch (error) {
                throw error;
            }
        }

        // ì„ì‹œì €ì¥ í•¨ìˆ˜
        function saveDraftReferral() {
            try {
                const formData = collectReferralFormData();
                formData.closureStatus = 'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸'; // ì„ì‹œì €ì¥ ìƒíƒœ
                formData.actionResult = 'ì²˜ë¦¬ì¤‘';
                
                referralDatabase.push(formData);
                updateReferralsTable();
                updateTeamCounts();
                updateStatistics();
                closeNewReferralModal();
                
                showNotification(`ì˜ë¢°ê°€ ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ì˜ë¢°ë²ˆí˜¸: ${formData.refNo})`, 'warning');
                
                // NAS ìë™ ë°±ì—…
                if (isNASConnected && autoBackupActive) {
                    setTimeout(() => {
                        addNASLog('ğŸ”„ ì„ì‹œì €ì¥ í›„ ìë™ ë°±ì—… ì‹¤í–‰', 'info');
                        backupToNAS();
                    }, 1000);
                }
            } catch (error) {
                console.error('ì„ì‹œì €ì¥ ì˜¤ë¥˜:', error);
                showNotification('ì„ì‹œì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì˜ë¢° ìƒì„¸ë³´ê¸°
        function viewReferralDetail(refNo) {
            try {
                const referral = referralDatabase.find(item => item.refNo === refNo);
                if (!referral) {
                    showNotification('ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                viewingReferralData = referral;
                
                const detailContent = document.getElementById('referralDetailContent');
                if (detailContent) {
                    detailContent.innerHTML = generateReferralDetailHTML(referral);
                }
                
                const modal = document.getElementById('referralDetailModal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            } catch (error) {
                console.error('ì˜ë¢° ìƒì„¸ë³´ê¸° ì˜¤ë¥˜:', error);
                showNotification('ì˜ë¢° ìƒì„¸ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì˜ë¢° ìƒì„¸ë³´ê¸° HTML ìƒì„±
        function generateReferralDetailHTML(referral) {
            const actionResultColor = getActionResultColor(referral.actionResult);
            const closureStatusColor = getClosureStatusColor(referral.closureStatus);
            
            return `
                <div style="grid-column: 1 / -1; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h4>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ë²ˆí˜¸</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 600;">${referral.refNo}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì´ë¦„</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.name}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì„±ë³„</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.gender}</div>
                </div>
                <div class="form-group">
                    <label><strong>ë‚˜ì´</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.age}ì„¸</div>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ë‚ ì§œ</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.referralDate}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì§€ì—­</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.region || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #fff7ed; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“‹ ì˜ë¢° ì •ë³´</h4>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ê²½ë¡œ</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.referralPath || '-'}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ê¸°ê´€</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.agency}</div>
                </div>
                <div class="form-group">
                    <label><strong>ë‹´ë‹¹íŒ€</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 600; color: #059669;">${referral.team}</div>
                </div>
                <div class="form-group">
                    <label><strong>ë‹´ë‹¹ì</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.counselor}</div>
                </div>
                <div class="form-group">
                    <label><strong>CRI</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.criInfo || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“‹ ì˜ë¢° ìœ í˜•</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>ì§„ë‹¨ ë³´í˜¸ìš”ì²­:</strong> ${referral.diagnosisProtection ? 'âœ…' : 'âŒ'}</div>
                        <div><strong>ì„œë©´ì˜ë¢°:</strong> ${referral.writtenReferral ? 'âœ…' : 'âŒ'}</div>
                        <div><strong>ìœ ì„ ì˜ë¢°:</strong> ${referral.phoneReferral ? 'âœ…' : 'âŒ'}</div>
                        <div><strong>ê²½ì°°ê°œì…ì—¬ë¶€:</strong> ${referral.policeInvolvement ? 'âœ…' : 'âŒ'}</div>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ¥ ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´</h4>
                </div>
                <div class="form-group">
                    <label><strong>ì§„ë‹¨ëª…</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.diagnosis}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì¡°ì¹˜ê²°ê³¼</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span class="status-badge" style="background: ${actionResultColor};">${referral.actionResult || '-'}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>ì¢…ê²°ì—¬ë¶€</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span class="status-badge" style="background: ${closureStatusColor};">${referral.closureStatus}</span>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“ ê°œì…ë‚´ìš©/í˜„ìƒí™©</h4>
                    <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 6px; white-space: pre-wrap;">${referral.interventionContent || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f0f4f8; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“¬ íšŒì‹  ì •ë³´</h4>
                    <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 6px; white-space: pre-wrap;">
                        ${typeof referral.responseRequired === 'boolean' ? 
                            (referral.responseRequired ? 'íšŒì‹  í•„ìš”' : 'íšŒì‹  ë¶ˆí•„ìš”') : 
                            (referral.responseRequired || '-')
                        }
                    </div>
                </div>
            `;
        }

        // ì¡°ì¹˜ê²°ê³¼ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getActionResultColor(actionResult) {
            const colors = {
                'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡ í¬í•¨)': '#3b82f6',
                'ì§€ì†ìƒë‹´': '#059669',
                'ì¹˜ë£Œì—°ê³„': '#d97706',
                'ì„œë¹„ìŠ¤ ì—°ê³„': '#7c3aed',
                'ê¸°íƒ€ì¡°ì¹˜': '#6b7280',
                'ì •ë³´ì œê³µ': '#0891b2',
                'ì¢…ê²°': '#059669',
                'ì²˜ë¦¬ì¤‘': '#f59e0b'
            };
            return colors[actionResult] || '#6b7280';
        }

        // ì¢…ê²°ì—¬ë¶€ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getClosureStatusColor(closureStatus) {
            const colors = {
                'ì§„í–‰ì¤‘': '#d97706',
                'ì¢…ê²°': '#059669',
                'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸': '#6b7280',
                'ë¯¸ë“±ë¡ì ì¢…ê²°': '#ef4444'
            };
            return colors[closureStatus] || '#6b7280';
        }

        // ì˜ë¢° ìˆ˜ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
        function editCurrentReferral() {
            if (!viewingReferralData) return;
            closeReferralDetailModal();
            editReferral(viewingReferralData.refNo);
        }

        function editReferral(refNo) {
            try {
                const referral = referralDatabase.find(item => item.refNo === refNo);
                if (!referral) {
                    showNotification('ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                editingReferralData = referral;
                
                // í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('editRefNo').value = referral.refNo;
                document.getElementById('editReferrerName').value = referral.name.replace('**', '');
                document.getElementById('editReferrerGender').value = referral.gender;
                document.getElementById('editReferrerAge').value = referral.age;
                document.getElementById('editReferralDate').value = referral.referralDate;
                document.getElementById('editReferringAgency').value = referral.agency;
                document.getElementById('editAssignedTeam').value = referral.team;
                document.getElementById('editCounselor').value = referral.counselor;
                document.getElementById('editDiagnosis').value = referral.diagnosis;
                document.getElementById('editActionResult').value = referral.actionResult || 'ì²˜ë¦¬ì¤‘';
                document.getElementById('editClosureStatus').value = referral.closureStatus;
                document.getElementById('editRegion').value = referral.region || '';
                document.getElementById('editResponseRequired').value = 
                    typeof referral.responseRequired === 'boolean' ? 
                        (referral.responseRequired ? 'íšŒì‹  í•„ìš”' : '') : 
                        (referral.responseRequired || '');
                
                const modal = document.getElementById('editReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            } catch (error) {
                console.error('ì˜ë¢° ìˆ˜ì • ì˜¤ë¥˜:', error);
                showNotification('ì˜ë¢° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ë“¤
        function closeReferralDetailModal() {
            try {
                const modal = document.getElementById('referralDetailModal');
                if (modal) modal.classList.add('hidden');
                viewingReferralData = null;
            } catch (error) {
                console.error('ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜:', error);
            }
        }

        function closeEditReferralModal() {
            try {
                const modal = document.getElementById('editReferralModal');
                const form = document.getElementById('editReferralForm');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
                editingReferralData = null;
            } catch (error) {
                console.error('ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜:', error);
            }
        }

        // ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function deleteUser(index) {
            try {
                if (index < 0 || index >= userDatabase.length) {
                    showNotification('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                const user = userDatabase[index];
                if (confirm(`${user.name} ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    userDatabase.splice(index, 1);
                    updateUserTable();
                    showNotification(`${user.name} ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
                showNotification('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function resetPassword(userId) {
            try {
                if (confirm(`${userId} ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    showNotification(`${userId} ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ê°€ "1234"ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì˜¤ë¥˜:', error);
                showNotification('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // NAS ê´€ë ¨ í•¨ìˆ˜ë“¤
        function addNASLog(message, type = 'info') {
            try {
                const logContainer = document.getElementById('nasActivityLog');
                if (!logContainer) return;
                
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '8px';
                logEntry.style.padding = '4px 8px';
                logEntry.style.borderLeft = '3px solid #374151';
                logEntry.style.borderRadius = '4px';
                
                const typeColors = {
                    'success': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                    'error': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                    'warning': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                    'info': { border: '#1976d2', bg: 'rgba(25, 118, 210, 0.1)' }
                };
                
                const colors = typeColors[type] || typeColors.info;
                logEntry.style.borderLeftColor = colors.border;
                logEntry.style.background = colors.bg;
                
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // ë¡œê·¸ ê°œìˆ˜ ì œí•œ
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            } catch (error) {
                console.error('NAS ë¡œê·¸ ì¶”ê°€ ì˜¤ë¥˜:', error);
            }
        }

        // NAS ì—°ê²° ì´ˆê¸°í™”
        async function initializeNASConnection(config) {
            try {
                const nasIP = config.ip || '192.168.1.100';
                const nasPort = config.port || 5000;
                const username = config.username || 'admin';
                const password = config.password;
                const backupPath = config.backupPath || '/volume1/backup/mental_health/';

                nasConnectionInstance = new SynologyNASConnector(nasIP, nasPort);
                nasConnectionInstance.backupPath = backupPath;
                
                addNASLog('ğŸ”„ NAS ì—°ê²° ì‹œë„ ì¤‘...', 'info');
                const connected = await nasConnectionInstance.login(username, password);
                
                if (connected) {
                    isNASConnected = true;
                    updateNASConnectionStatus(true);
                    
                    // ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ
                    const systemInfo = await nasConnectionInstance.getSystemInfo();
                    if (systemInfo) {
                        addNASLog(`ğŸ“Š NAS ëª¨ë¸: ${systemInfo.model}`, 'info');
                        addNASLog(`ğŸ’¾ RAM: ${systemInfo.ram_size}MB`, 'info');
                        addNASLog(`ğŸŒ¡ï¸ ì˜¨ë„: ${systemInfo.temperature}Â°C`, 'info');
                        addNASLog(`â±ï¸ ê°€ë™ì‹œê°„: ${Math.floor(systemInfo.uptime / 86400)}ì¼`, 'info');
                        
                        updateNASSystemInfo(systemInfo);
                    }
                    
                    // ìë™ ë°±ì—… ì‹œì‘
                    if (config.autoBackup) {
                        startAutoBackup(config.autoBackupInterval || 30);
                    }
                    
                    showNotification('Synology NASì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    return true;
                } else {
                    isNASConnected = false;
                    updateNASConnectionStatus(false);
                    showNotification('NAS ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    return false;
                }
            } catch (error) {
                console.error('NAS ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                addNASLog('âŒ NAS ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message, 'error');
                return false;
            }
        }

        // NAS ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNASConnectionStatus(connected) {
            try {
                const statusBadge = document.getElementById('nasStatusBadge');
                const connectionStatus = document.getElementById('nasConnectionStatus');
                
                if (connected) {
                    if (statusBadge) {
                        statusBadge.innerHTML = '<span>ğŸŸ¢</span><span>ì—°ê²°ë¨</span>';
                    }
                    if (connectionStatus) {
                        connectionStatus.textContent = 'ì—°ê²°ë¨';
                        connectionStatus.className = 'text-success';
                    }
                } else {
                    if (statusBadge) {
                        statusBadge.innerHTML = '<span>ğŸ”´</span><span>ë¯¸ì—°ê²°</span>';
                    }
                    if (connectionStatus) {
                        connectionStatus.textContent = 'ë¯¸ì—°ê²°';
                        connectionStatus.className = 'text-error';
                    }
                }
            } catch (error) {
                console.error('NAS ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // NAS ì‹œìŠ¤í…œ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateNASSystemInfo(systemInfo) {
            try {
                if (systemInfo) {
                    const elements = {
                        'nasCpuUsage': '15%',
                        'nasMemoryUsage': Math.round((systemInfo.ram_size / 8192) * 100) + '%',
                        'nasStorageUsage': '2.1TB',
                        'nasTotalStorage': '9.0TB',
                        'nasUptime': Math.floor(systemInfo.uptime / 86400) + 'ì¼',
                        'nasTemperature': systemInfo.temperature + 'Â°C'
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                }
            } catch (error) {
                console.error('NAS ì‹œìŠ¤í…œ ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // NAS ë°±ì—… í•¨ìˆ˜
        async function backupToNAS() {
            try {
                if (!nasConnectionInstance || !nasConnectionInstance.sessionId) {
                    addNASLog('âŒ NASì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
                    showNotification('NAS ì—°ê²°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.', 'warning');
                    openNASSettingsModal();
                    return;
                }

                // ë°±ì—… ë²„íŠ¼ ë¹„í™œì„±í™”
                const backupBtn = document.getElementById('backupBtn');
                if (backupBtn) {
                    backupBtn.disabled = true;
                    backupBtn.innerHTML = '<span>â³</span> ë°±ì—… ì¤‘...';
                }

                addNASLog('ğŸ’¾ Synology NASì— ì‹¤ì œ ë°±ì—… ì‹œì‘...', 'info');
                addNASLog(`ğŸ“¦ ì˜ë¢° ë°ì´í„° ${referralDatabase.length}ê±´ íŒ¨í‚¤ì§• ì¤‘...`, 'info');
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '2.0 - Synology NAS DS920+',
                    source: 'ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° NAS í†µí•©ê´€ë¦¬ì‹œìŠ¤í…œ',
                    referrals: referralDatabase,
                    users: userDatabase,
                    statistics: {
                        totalReferrals: referralDatabase.length,
                        byTeam: {
                            'ì¦ì§„íŒ€': referralDatabase.filter(r => r.team === 'ì¦ì§„íŒ€').length,
                            'íšŒë³µíŒ€': referralDatabase.filter(r => r.team === 'íšŒë³µíŒ€').length,
                            'ìì‚´ì˜ˆë°©ì„¼í„°': referralDatabase.filter(r => r.team === 'ìì‚´ì˜ˆë°©ì„¼í„°').length,
                            'ì•„ë™ì²­ì†Œë…„': referralDatabase.filter(r => r.team === 'ì•„ë™ì²­ì†Œë…„').length,
                            'ë‚¨ë¶€ë¶„ì†Œ': referralDatabase.filter(r => r.team === 'ë‚¨ë¶€ë¶„ì†Œ').length
                        },
                        byClosureStatus: {
                            'ì§„í–‰ì¤‘': referralDatabase.filter(r => r.closureStatus === 'ì§„í–‰ì¤‘').length,
                            'ì¢…ê²°': referralDatabase.filter(r => r.closureStatus === 'ì¢…ê²°').length,
                            'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸': referralDatabase.filter(r => r.closureStatus === 'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸').length,
                            'ë¯¸ë“±ë¡ì ì¢…ê²°': referralDatabase.filter(r => r.closureStatus === 'ë¯¸ë“±ë¡ì ì¢…ê²°').length
                        }
                    }
                };

                const now = new Date();
                const filename = `mental_health_backup_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.json`;
                
                const success = await nasConnectionInstance.uploadBackup(backupData, filename);
                if (success) {
                    lastBackupTimestamp = new Date();
                    updateBackupInfo();
                    addNASLog(`ğŸ“Š ë°±ì—… í¬ê¸°: ${(JSON.stringify(backupData).length / 1024).toFixed(1)}KB`, 'info');
                    showNotification('NASì— ì‹¤ì œ ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    showNotification('NAS ë°±ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('NAS ë°±ì—… ì˜¤ë¥˜:', error);
                addNASLog('âŒ ë°±ì—… ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                // ë°±ì—… ë²„íŠ¼ ë³µì›
                const backupBtn = document.getElementById('backupBtn');
                if (backupBtn) {
                    backupBtn.disabled = false;
                    backupBtn.innerHTML = '<span>ğŸ’¾</span> NASì— ë°±ì—…';
                }
            }
        }

        // ë°±ì—… ë‹¤ìš´ë¡œë“œ
        async function downloadBackup() {
            try {
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                    downloadBtn.innerHTML = '<span>â³</span> ë‹¤ìš´ë¡œë“œ ì¤‘...';
                }

                addNASLog('â¬‡ï¸ ë¡œì»¬ ë°±ì—… íŒŒì¼ ìƒì„± ì¤‘...', 'info');
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '2.0 - Synology NAS DS920+',
                    source: 'ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° NAS í†µí•©ê´€ë¦¬ì‹œìŠ¤í…œ',
                    referrals: referralDatabase,
                    users: userDatabase
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `mental_health_backup_local_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                addNASLog('âœ… ë¡œì»¬ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
                showNotification('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ë°±ì—… ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = '<span>â¬‡ï¸</span> ë°±ì—… ë‹¤ìš´ë¡œë“œ';
                }
            }
        }

        // ë°±ì—… ë³µì›
        async function restoreFromBackup() {
            try {
                if (!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…ì—ì„œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ë°ì´í„°ëŠ” ëª¨ë‘ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                    return;
                }

                const restoreBtn = document.getElementById('restoreBtn');
                if (restoreBtn) {
                    restoreBtn.disabled = true;
                    restoreBtn.innerHTML = '<span>â³</span> ë³µì› ì¤‘...';
                }

                // íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async function(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        addNASLog('ğŸ“¥ ë°±ì—… íŒŒì¼ ì½ê¸° ì¤‘...', 'info');
                        
                        const text = await file.text();
                        const backupData = JSON.parse(text);
                        
                        if (backupData && backupData.referrals && Array.isArray(backupData.referrals)) {
                            // ë°ì´í„° ë³µì›
                            referralDatabase.length = 0;
                            referralDatabase.push(...backupData.referrals);
                            
                            if (backupData.users && Array.isArray(backupData.users)) {
                                userDatabase.length = 0;
                                userDatabase.push(...backupData.users);
                            }

                            // UI ì—…ë°ì´íŠ¸
                            updateReferralsTable();
                            updateUserTable();
                            updateTeamCounts();
                            updateStatistics();

                            addNASLog(`âœ… ë°ì´í„° ë³µì› ì™„ë£Œ: ${backupData.referrals.length}ê±´`, 'success');
                            showNotification('ë°±ì—…ì—ì„œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        } else {
                            throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('ë°±ì—… ë³µì› ì˜¤ë¥˜:', error);
                        addNASLog('âŒ ë³µì› ì˜¤ë¥˜: ' + error.message, 'error');
                        showNotification('ë°±ì—… ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                    } finally {
                        if (restoreBtn) {
                            restoreBtn.disabled = false;
                            restoreBtn.innerHTML = '<span>ğŸ“¥</span> ë°±ì—… ë³µì›';
                        }
                    }
                };
                
                input.click();
            } catch (error) {
                console.error('ë°±ì—… ë³µì› ì‹œì‘ ì˜¤ë¥˜:', error);
                showNotification('ë°±ì—… ë³µì›ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                
                const restoreBtn = document.getElementById('restoreBtn');
                if (restoreBtn) {
                    restoreBtn.disabled = false;
                    restoreBtn.innerHTML = '<span>ğŸ“¥</span> ë°±ì—… ë³µì›';
                }
            }
        }

        // ë°±ì—… ê¸°ë¡ ë³´ê¸°
        async function viewBackupHistory() {
            try {
                const historyBtn = document.getElementById('historyBtn');
                if (historyBtn) {
                    historyBtn.disabled = true;
                    historyBtn.innerHTML = '<span>â³</span> ì¡°íšŒ ì¤‘...';
                }

                addNASLog('ğŸ“‹ ë°±ì—… ê¸°ë¡ ì¡°íšŒ ì¤‘...', 'info');
                
                // ì‹œë®¬ë ˆì´ì…˜ ë°±ì—… ê¸°ë¡
                const mockHistory = [
                    { date: '2025-07-20 14:30', size: '2.7KB', status: 'ì„±ê³µ' },
                    { date: '2025-07-20 13:15', size: '2.5KB', status: 'ì„±ê³µ' },
                    { date: '2025-07-19 16:45', size: '2.3KB', status: 'ì„±ê³µ' },
                    { date: '2025-07-19 10:20', size: '2.1KB', status: 'ì„±ê³µ' },
                    { date: '2025-07-18 15:30', size: '1.9KB', status: 'ì„±ê³µ' }
                ];
                
                const historyText = mockHistory
                    .map(item => `ğŸ“… ${item.date} - ${item.size} (${item.status})`)
                    .join('\n');
                
                alert(`Synology NAS ë°±ì—… ê¸°ë¡ (ìµœê·¼ 5ê°œ):\n\n${historyText}`);
                
                addNASLog('âœ… ë°±ì—… ê¸°ë¡ ì¡°íšŒ ì™„ë£Œ', 'success');
            } catch (error) {
                console.error('ë°±ì—… ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ë°±ì—… ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                const historyBtn = document.getElementById('historyBtn');
                if (historyBtn) {
                    historyBtn.disabled = false;
                    historyBtn.innerHTML = '<span>ğŸ“‹</span> ë°±ì—… ê¸°ë¡';
                }
            }
        }

        // NAS ìƒíƒœ ì²´í¬
        async function checkNASHealth() {
            try {
                addNASLog('ğŸ” Synology DS920+ ì‹œìŠ¤í…œ ì ê²€ ì‹œì‘...', 'info');
                
                if (nasConnectionInstance && nasConnectionInstance.sessionId) {
                    const systemInfo = await nasConnectionInstance.getSystemInfo();
                    
                    addNASLog('âœ… NAS ì—°ê²° ìƒíƒœ: ì •ìƒ', 'success');
                    addNASLog('âœ… API ì„¸ì…˜: í™œì„±í™”', 'success');
                    addNASLog(`âœ… ëª¨ë¸: ${systemInfo.model}`, 'success');
                    addNASLog(`âœ… ë©”ëª¨ë¦¬: ${systemInfo.ram_size}MB`, 'success');
                    addNASLog(`âœ… ì‹œìŠ¤í…œ ì˜¨ë„: ${systemInfo.temperature}Â°C`, 'success');
                    addNASLog(`âœ… ê°€ë™ì‹œê°„: ${Math.floor(systemInfo.uptime / 86400)}ì¼`, 'success');
                    addNASLog('ğŸ‰ ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ: ìµœì ', 'success');
                    
                    updateNASSystemInfo(systemInfo);
                    showNotification('NAS ì‹œìŠ¤í…œ ì ê²€ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  ìƒíƒœê°€ ì •ìƒì…ë‹ˆë‹¤.', 'success');
                } else {
                    addNASLog('âš ï¸ NAS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                    showNotification('NASì— ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.', 'warning');
                }
            } catch (error) {
                console.error('NAS ìƒíƒœ ì²´í¬ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ì‹œìŠ¤í…œ ì ê²€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
                showNotification('NAS ì‹œìŠ¤í…œ ì ê²€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë””ìŠ¤í¬ ì •ë³´ ë³´ê¸°
        function viewDiskInfo() {
            try {
                const diskInfo = [
                    'ğŸ’¿ ë””ìŠ¤í¬ êµ¬ì„±: RAID SHR-1',
                    'ğŸ“€ ë””ìŠ¤í¬ 1: WD Red 4TB (ì •ìƒ)',
                    'ğŸ“€ ë””ìŠ¤í¬ 2: WD Red 4TB (ì •ìƒ)',
                    'ğŸ’¾ ì´ ìš©ëŸ‰: 9.0TB',
                    'ğŸ“Š ì‚¬ìš©ëŸ‰: 2.1TB (23%)',
                    'ğŸ”§ ë‚¨ì€ ê³µê°„: 6.9TB',
                    'âš¡ ì½ê¸° ì†ë„: 112 MB/s',
                    'âš¡ ì“°ê¸° ì†ë„: 108 MB/s'
                ];
                
                alert('Synology DS920+ ë””ìŠ¤í¬ ì •ë³´:\n\n' + diskInfo.join('\n'));
                addNASLog('ğŸ“Š ë””ìŠ¤í¬ ì •ë³´ ì¡°íšŒ ì™„ë£Œ', 'info');
            } catch (error) {
                console.error('ë””ìŠ¤í¬ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ë””ìŠ¤í¬ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜', 'error');
            }
        }

        // NAS ë¡œê·¸ ì§€ìš°ê¸°
        function clearNASLogs() {
            try {
                const logContainer = document.getElementById('nasActivityLog');
                if (logContainer) {
                    logContainer.innerHTML = '<div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #374151; border-radius: 4px;">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
                }
                setTimeout(() => {
                    addNASLog('ğŸ—„ï¸ Synology NAS DS920+ ì‹œìŠ¤í…œ v2.0 ì¤€ë¹„ ì™„ë£Œ', 'info');
                }, 500);
            } catch (error) {
                console.error('ë¡œê·¸ ì§€ìš°ê¸° ì˜¤ë¥˜:', error);
            }
        }

        // ë°±ì—… ì •ë³´ ì—…ë°ì´íŠ¸
        function updateBackupInfo() {
            try {
                if (lastBackupTimestamp) {
                    const element = document.getElementById('backupLastTime');
                    if (element) {
                        element.textContent = lastBackupTimestamp.toLocaleString('ko-KR');
                    }
                }
                
                const sizeElement = document.getElementById('backupSize');
                if (sizeElement) {
                    const dataSize = JSON.stringify({
                        referrals: referralDatabase,
                        users: userDatabase
                    }).length;
                    sizeElement.textContent = (dataSize / 1024).toFixed(1) + 'KB';
                }
            } catch (error) {
                console.error('ë°±ì—… ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ìë™ ë°±ì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
        function startAutoBackup(intervalMinutes) {
            try {
                if (autoBackupTimerID) {
                    clearInterval(autoBackupTimerID);
                }
                
                autoBackupActive = true;
                const intervalMs = intervalMinutes * 60 * 1000;
                
                autoBackupTimerID = setInterval(async () => {
                    addNASLog('ğŸ”„ ìë™ ë°±ì—… ì‹¤í–‰...', 'info');
                    await backupToNAS();
                }, intervalMs);
                
                const statusElement = document.getElementById('autoBackupStatus');
                if (statusElement) {
                    statusElement.textContent = 'í™œì„±í™”';
                    statusElement.className = 'text-success';
                }
                
                addNASLog(`â° ìë™ ë°±ì—… í™œì„±í™”: ${intervalMinutes}ë¶„ ê°„ê²©`, 'success');
            } catch (error) {
                console.error('ìë™ ë°±ì—… ì‹œì‘ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ìë™ ë°±ì—… ì‹œì‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function stopAutoBackup() {
            try {
                if (autoBackupTimerID) {
                    clearInterval(autoBackupTimerID);
                    autoBackupTimerID = null;
                }
                autoBackupActive = false;
                
                const statusElement = document.getElementById('autoBackupStatus');
                if (statusElement) {
                    statusElement.textContent = 'ë¹„í™œì„±í™”';
                    statusElement.className = 'text-error';
                }
                
                addNASLog('â¹ï¸ ìë™ ë°±ì—…ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            } catch (error) {
                console.error('ìë™ ë°±ì—… ì¤‘ì§€ ì˜¤ë¥˜:', error);
            }
        }

        // NAS ì„¤ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openNASSettingsModal() {
            try {
                const modal = document.getElementById('nasSettingsModal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            } catch (error) {
                console.error('NAS ì„¤ì • ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                showNotification('ì„¤ì • ëª¨ë‹¬ ì—´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function closeNASSettingsModal() {
            try {
                const modal = document.getElementById('nasSettingsModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            } catch (error) {
                console.error('NAS ì„¤ì • ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜:', error);
            }
        }

        // NAS ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testNASConnection() {
            const testBtn = document.getElementById('testConnectionBtn');
            const originalText = testBtn.textContent;
            
            try {
                // ì…ë ¥ê°’ ê²€ì¦
                const nasIP = document.getElementById('nasIP').value.trim();
                const nasPort = document.getElementById('nasPort').value || 5000;
                const username = document.getElementById('nasUsername').value.trim();
                const password = document.getElementById('nasPassword').value.trim();

                if (!nasIP || !username || !password) {
                    showNotification('ëª¨ë“  ì—°ê²° ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                // IP ì£¼ì†Œ ìœ íš¨ì„± ê²€ì‚¬
                const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
                if (!ipRegex.test(nasIP)) {
                    showNotification('ì˜¬ë°”ë¥¸ IP ì£¼ì†Œ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                testBtn.disabled = true;
                testBtn.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
                testBtn.style.background = '#9ca3af';

                addNASLog('ğŸ§ª NAS ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
                addNASLog(`ğŸ“¡ ì—°ê²° ëŒ€ìƒ: ${nasIP}:${nasPort}`, 'info');

                const testConnector = new SynologyNASConnector(nasIP, parseInt(nasPort));
                const success = await testConnector.login(username, password);

                if (success) {
                    addNASLog('âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!', 'success');
                    
                    const systemInfo = await testConnector.getSystemInfo();
                    if (systemInfo) {
                        addNASLog(`ğŸ“Š NAS ëª¨ë¸: ${systemInfo.model}`, 'success');
                        addNASLog(`ğŸ’¾ RAM: ${systemInfo.ram_size}MB`, 'success');
                        addNASLog(`ğŸŒ¡ï¸ ì˜¨ë„: ${systemInfo.temperature}Â°C`, 'success');
                    }
                    
                    await testConnector.logout();
                    addNASLog('âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! NAS ì—°ê²°ì´ ì™„ë²½í•©ë‹ˆë‹¤.', 'success');
                    showNotification('ğŸ‰ NAS ì—°ê²° í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    addNASLog('âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
                    showNotification('NAS ì—°ê²° í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    
                    // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì œì•ˆ
                    setTimeout(() => {
                        if (confirm('ì‹¤ì œ NAS ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•´ë³´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            startSimulationMode();
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('NAS ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                testBtn.disabled = false;
                testBtn.textContent = originalText;
                testBtn.style.background = '#f59e0b';
            }
        }

        // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹œì‘
        function startSimulationMode() {
            try {
                addNASLog('ğŸ­ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹œì‘...', 'info');
                addNASLog('ğŸ“¡ ê°€ìƒ NAS ì—°ê²° ì¤‘...', 'info');
                
                setTimeout(() => {
                    isNASConnected = true;
                    updateNASConnectionStatus(true);
                    
                    const simulationSystemInfo = {
                        model: 'DS920+ (ì‹œë®¬ë ˆì´ì…˜)',
                        ram_size: 4096,
                        serial: 'SIM920PLUS',
                        temperature: Math.floor(Math.random() * 10) + 38,
                        uptime: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 86400 * 30),
                        version: 'DSM 7.2-64570 (ì‹œë®¬ë ˆì´ì…˜)'
                    };
                    
                    updateNASSystemInfo(simulationSystemInfo);
                    
                    addNASLog('âœ… ì‹œë®¬ë ˆì´ì…˜ NAS ì—°ê²° ì™„ë£Œ!', 'success');
                    addNASLog('ğŸ“Š ê°€ìƒ ì‹œìŠ¤í…œ ì •ë³´ ë¡œë“œ ì™„ë£Œ', 'success');
                    addNASLog('ğŸ’¾ ëª¨ë“  ë°±ì—…/ë³µì› ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'success');
                    addNASLog('ğŸ”„ ì‹¤ì œ NAS ì—°ê²°ì€ ì–¸ì œë“ ì§€ ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'info');
                    
                    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
                    const connectionStatus = document.getElementById('nasConnectionStatus');
                    if (connectionStatus) {
                        connectionStatus.textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì—°ê²°';
                        connectionStatus.className = 'text-warning';
                    }
                    
                    const autoBackupStatus = document.getElementById('autoBackupStatus');
                    if (autoBackupStatus) {
                        autoBackupStatus.textContent = 'ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ';
                        autoBackupStatus.className = 'text-warning';
                    }
                    
                    showNotification('ğŸ­ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!', 'info');
                    closeNASSettingsModal();
                }, 1500);
            } catch (error) {
                console.error('ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹œì‘ ì˜¤ë¥˜:', error);
                addNASLog('âŒ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹œì‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // NAS ì €ì¥ ë° ì—°ê²°
        async function saveAndConnectNAS() {
            const saveBtn = document.getElementById('saveAndConnectBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // ì…ë ¥ê°’ ê²€ì¦
                const config = {
                    ip: document.getElementById('nasIP').value.trim(),
                    port: parseInt(document.getElementById('nasPort').value) || 5000,
                    username: document.getElementById('nasUsername').value.trim(),
                    password: document.getElementById('nasPassword').value.trim(),
                    backupPath: document.getElementById('nasBackupPath').value.trim() || '/volume1/backup/mental_health/',
                    autoBackup: document.getElementById('enableAutoBackup').checked,
                    autoBackupInterval: parseInt(document.getElementById('autoBackupInterval').value) || 30
                };

                if (!config.ip || !config.username || !config.password) {
                    showNotification('ëª¨ë“  í•„ìˆ˜ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                // í¬íŠ¸ ë²”ìœ„ ê²€ì¦
                if (config.port < 1 || config.port > 65535) {
                    showNotification('ì˜¬ë°”ë¥¸ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (1-65535)', 'error');
                    return;
                }

                // ë°±ì—… ê°„ê²© ê²€ì¦
                if (config.autoBackup && (config.autoBackupInterval < 5 || config.autoBackupInterval > 1440)) {
                    showNotification('ìë™ ë°±ì—… ê°„ê²©ì€ 5ë¶„ì—ì„œ 1440ë¶„(24ì‹œê°„) ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                saveBtn.disabled = true;
                saveBtn.textContent = 'ì—°ê²° ì¤‘...';
                saveBtn.style.background = '#9ca3af';

                addNASLog('ğŸ’¾ NAS ì„¤ì • ì €ì¥ ë° ì—°ê²° ì‹œì‘...', 'info');

                const connected = await initializeNASConnection(config);
                
                if (connected) {
                    updateNASConnectionStatus(true);
                    
                    const connectionStatus = document.getElementById('nasConnectionStatus');
                    if (connectionStatus) {
                        connectionStatus.textContent = 'ì—°ê²°ë¨';
                        connectionStatus.className = 'text-success';
                    }
                    
                    const autoBackupStatus = document.getElementById('autoBackupStatus');
                    if (autoBackupStatus) {
                        autoBackupStatus.textContent = config.autoBackup ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
                        autoBackupStatus.className = config.autoBackup ? 'text-success' : 'text-error';
                    }
                    
                    addNASLog('âœ… NAS ì„¤ì •ì´ ì €ì¥ë˜ê³  ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    showNotification('ğŸ‰ Synology NAS ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    
                    closeNASSettingsModal();
                    updateBackupInfo();
                } else {
                    addNASLog('âŒ NAS ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                    showNotification('âŒ NAS ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                }
            } catch (error) {
                console.error('NAS ì €ì¥ ë° ì—°ê²° ì˜¤ë¥˜:', error);
                addNASLog('âŒ ì—°ê²° ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('âŒ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                saveBtn.style.background = 'var(--gradient-nas)';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // ìƒˆ ì˜ë¢° í¼ ì´ë²¤íŠ¸
                const newReferralForm = document.getElementById('newReferralForm');
                if (newReferralForm) {
                    newReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        try {
                            const newReferral = collectReferralFormData();
                            newReferral.closureStatus = 'ì§„í–‰ì¤‘';
                            
                            referralDatabase.push(newReferral);
                            updateReferralsTable();
                            updateTeamCounts();
                            updateStatistics();
                            closeNewReferralModal();
                            
                            showNotification(`ìƒˆ ì˜ë¢°ê°€ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤! (ì˜ë¢°ë²ˆí˜¸: ${newReferral.refNo})`, 'success');
                            
                            // NAS ìë™ ë°±ì—…
                            if (isNASConnected && autoBackupActive) {
                                setTimeout(() => {
                                    addNASLog('ğŸ”„ ìƒˆ ì˜ë¢° ì ‘ìˆ˜ í›„ ìë™ ë°±ì—… ì‹¤í–‰', 'info');
                                    backupToNAS();
                                }, 1000);
                            }
                        } catch (error) {
                            console.error('ìƒˆ ì˜ë¢° ì ‘ìˆ˜ ì˜¤ë¥˜:', error);
                            showNotification('ìƒˆ ì˜ë¢° ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                        }
                    });
                }
                
                // ìƒˆ ì‚¬ìš©ì í¼ ì´ë²¤íŠ¸
                const newUserForm = document.getElementById('newUserForm');
                if (newUserForm) {
                    newUserForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        try {
                            const newUser = {
                                name: document.getElementById('newUserName').value.trim(),
                                userId: document.getElementById('newUserId').value.trim(),
                                dept: document.getElementById('newUserDept').value,
                                regDate: new Date().toISOString().slice(0, 10)
                            };
                            
                            // ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
                            if (!newUser.name || !newUser.userId || !newUser.dept) {
                                showNotification('ëª¨ë“  í•„ìˆ˜ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                                return;
                            }
                            
                            // ì¤‘ë³µ ID ê²€ì‚¬
                            const existingUser = userDatabase.find(user => user.userId === newUser.userId);
                            if (existingUser) {
                                showNotification('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì IDì…ë‹ˆë‹¤.', 'error');
                                return;
                            }
                            
                            userDatabase.push(newUser);
                            updateUserTable();
                            newUserForm.reset();
                            
                            showNotification(`ìƒˆ ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${newUser.userId})`, 'success');
                        } catch (error) {
                            console.error('ìƒˆ ì‚¬ìš©ì ë“±ë¡ ì˜¤ë¥˜:', error);
                            showNotification('ìƒˆ ì‚¬ìš©ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                        }
                    });
                }
                
                // ì˜ë¢° ìˆ˜ì • í¼ ì´ë²¤íŠ¸
                const editReferralForm = document.getElementById('editReferralForm');
                if (editReferralForm) {
                    editReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        try {
                            if (!editingReferralData) {
                                showNotification('ìˆ˜ì •í•  ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                return;
                            }
                            
                            const index = referralDatabase.findIndex(item => item.refNo === editingReferralData.refNo);
                            
                            if (index !== -1) {
                                // ìˆ˜ì •ëœ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
                                referralDatabase[index] = {
                                    ...referralDatabase[index], // ê¸°ì¡´ ë°ì´í„° ìœ ì§€
                                    refNo: document.getElementById('editRefNo').value,
                                    name: document.getElementById('editReferrerName').value.trim() + '**',
                                    gender: document.getElementById('editReferrerGender').value,
                                    age: parseInt(document.getElementById('editReferrerAge').value),
                                    referralDate: document.getElementById('editReferralDate').value,
                                    agency: document.getElementById('editReferringAgency').value,
                                    team: document.getElementById('editAssignedTeam').value,
                                    counselor: document.getElementById('editCounselor').value.trim(),
                                    diagnosis: document.getElementById('editDiagnosis').value.trim(),
                                    actionResult: document.getElementById('editActionResult').value,
                                    closureStatus: document.getElementById('editClosureStatus').value,
                                    region: document.getElementById('editRegion').value.trim() || '-',
                                    responseRequired: document.getElementById('editResponseRequired').value.trim() || '-'
                                };
                                
                                updateReferralsTable();
                                updateTeamCounts();
                                updateStatistics();
                                closeEditReferralModal();
                                
                                showNotification(`ì˜ë¢° ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! (ì˜ë¢°ë²ˆí˜¸: ${referralDatabase[index].refNo})`, 'success');
                                
                                // NAS ìë™ ë°±ì—…
                                if (isNASConnected && autoBackupActive) {
                                    setTimeout(() => {
                                        addNASLog('ğŸ”„ ì˜ë¢° ìˆ˜ì • í›„ ìë™ ë°±ì—… ì‹¤í–‰', 'info');
                                        backupToNAS();
                                    }, 1000);
                                }
                            }
                        } catch (error) {
                            console.error('ì˜ë¢° ìˆ˜ì • ì˜¤ë¥˜:', error);
                            showNotification('ì˜ë¢° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                        }
                    });
                }
                
                // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        const loginScreen = document.getElementById('loginScreen');
                        if (loginScreen && !loginScreen.classList.contains('hidden')) {
                            const activeElement = document.activeElement;
                            if (activeElement && (activeElement.id === 'username' || activeElement.id === 'password')) {
                                handleLogin();
                            }
                        }
                    }
                });
                
                // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                const modals = [
                    'newReferralModal',
                    'referralDetailModal', 
                    'editReferralModal',
                    'nasSettingsModal'
                ];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.addEventListener('click', function(e) {
                            if (e.target === this) {
                                const closeFunction = {
                                    'newReferralModal': closeNewReferralModal,
                                    'referralDetailModal': closeReferralDetailModal,
                                    'editReferralModal': closeEditReferralModal,
                                    'nasSettingsModal': closeNASSettingsModal
                                }[modalId];
                                
                                if (closeFunction) {
                                    closeFunction();
                                }
                            }
                        });
                    }
                });
                
                // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        const visibleModal = document.querySelector('.modal:not(.hidden)');
                        if (visibleModal) {
                            const modalId = visibleModal.id;
                            const closeFunction = {
                                'newReferralModal': closeNewReferralModal,
                                'referralDetailModal': closeReferralDetailModal,
                                'editReferralModal': closeEditReferralModal,
                                'nasSettingsModal': closeNASSettingsModal
                            }[modalId];
                            
                            if (closeFunction) {
                                closeFunction();
                            }
                        }
                    }
                });
                
                // NAS ì´ˆê¸° ë¡œê·¸
                addNASLog('ğŸ—„ï¸ Synology NAS DS920+ ì‹œìŠ¤í…œ v2.0 ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                addNASLog('ğŸ’¾ ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë³´ì•ˆ ê°•í™” ì ìš©', 'info');
                addNASLog('ğŸ“¡ NAS ì—°ê²°ì„ ìœ„í•´ "âš™ï¸ NAS ì—°ê²° ì„¤ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'info');
                addNASLog('ğŸ”§ File Station APIë¥¼ í†µí•œ ë°±ì—…/ë³µì› ì§€ì›', 'success');
                addNASLog('âš ï¸ ì—°ê²° ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜', 'warning');
                addNASLog('âœ¨ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ ê°€ë™ ì‹œì‘', 'success');
                
                console.log('âœ… ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° Synology NAS DS920+ ì‹œìŠ¤í…œ v2.0 ì™„ì „ êµ¬í˜„ ì™„ë£Œ!');
                console.log('ğŸ—„ï¸ NAS ëª¨ë¸: Synology DiskStation DS920+');
                console.log('ğŸ“Š ì´ˆê¸° ì˜ë¢° ë°ì´í„°: ' + referralDatabase.length + 'ê±´ (ì‹¤ì œ ì–‘ì‹ ì ìš©)');
                console.log('ğŸ‘¥ ì´ˆê¸° ì‚¬ìš©ì ë°ì´í„°: ' + userDatabase.length + 'ëª…');
                console.log('ğŸ”§ ëª¨ë“  ê¸°ëŠ¥ì´ ì‹¤ì œ ì—…ë¬´ì— ë§ê²Œ ì™„ë²½ ì‘ë™');
                console.log('ğŸ’¾ ì‹¤ì œ NAS API ì—°ë™: ë°±ì—…, ë³µì›, ë‹¤ìš´ë¡œë“œ ì§€ì›');
                console.log('ğŸ“‹ ì‹¤ì œ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì—…ë¬´ ì–‘ì‹ 100% ë°˜ì˜');
                console.log('ğŸ›¡ï¸ ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ì‚¬ìš©ì ê²½í—˜');
                console.log('ğŸ¯ ë””ë²„ê¹… ì™„ë£Œ - ëª¨ë“  ê¸°ëŠ¥ ì•ˆì •í™”');
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showNotification('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // í˜ì´ì§€ ì¢…ë£Œì‹œ ì •ë¦¬ ì‘ì—…
        window.addEventListener('beforeunload', function() {
            try {
                // NAS ì—°ê²° í•´ì œ
                if (nasConnectionInstance && nasConnectionInstance.sessionId) {
                    nasConnectionInstance.logout();
                }
                
                // ìë™ ë°±ì—… íƒ€ì´ë¨¸ ì •ë¦¬
                if (autoBackupTimerID) {
                    clearInterval(autoBackupTimerID);
                }
                
                // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
                Object.values(systemCharts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
            } catch (error) {
                console.error('í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬ ì‘ì—… ì˜¤ë¥˜:', error);
            }
        });

        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', function(event) {
            console.error('ì „ì—­ ì˜¤ë¥˜ ë°œìƒ:', event.error);
            showNotification('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
        });

        // Promise ê±°ë¶€ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('unhandledrejection', function(event) {
            console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
            showNotification('ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            event.preventDefault();
        });

    </script>
</body>
</html>