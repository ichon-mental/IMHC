<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정신건강복지센터 - OneDrive 통합 시스템 v2.1</title>
    
    <!-- Chart.js & SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --nas-color: #1976d2;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-nas: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* 상태바 스타일 */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            font-size: 13px;
            z-index: 9999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 로그인 화면 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--gradient-primary);
        }

        .login-container.hidden {
            display: none !important;
        }

        .login-box {
            background: var(--gradient-card);
            padding: 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 700;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 메인 앱 컨테이너 */
        .app-container {
            display: flex;
            height: 100vh;
            padding-top: 50px;
            background: var(--gradient-primary);
        }

        .app-container.hidden {
            display: none !important;
        }

        /* 사이드바 */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background: var(--gradient-card);
        }

        .sidebar-header h2 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .user-info {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-menu {
            padding: 24px 0;
        }

        .nav-item {
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: white !important;
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        .nav-link .icon {
            margin-right: 16px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            transition: color 0.3s ease;
        }

        /* 메인 콘텐츠 */
        .main-content {
            flex: 1;
            background: rgba(248, 250, 252, 0.8);
            overflow-y: auto;
            min-height: calc(100vh - 50px);
        }

        .page {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - 50px);
            display: block;
        }

        .page.hidden {
            display: none !important;
        }

        .dashboard-container {
            padding: 40px;
            min-height: calc(100vh - 130px);
            background: transparent;
        }

        /* 알림 스타일 */
        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            background: white;
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            z-index: 10001;
            max-width: 450px;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        /* 위젯 스타일 */
        .widget {
            background: var(--gradient-card);
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .widget-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .widget-icon {
            font-size: 28px;
            color: var(--primary-color);
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--gradient-card);
            padding: 32px 28px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1;
        }

        .stat-number.urgent {
            color: var(--danger-color);
        }

        .stat-number.normal {
            color: var(--primary-color);
        }

        .stat-number.completed {
            color: var(--success-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
        }

        /* 새 의뢰 버튼 */
        .new-referral-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            white-space: nowrap;
            min-width: 140px;
        }

        .new-referral-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* 팀 탭 스타일 */
        .team-tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .chart-data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .chart-item {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chart-item-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .chart-item-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .chart-item-percentage {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* 테이블 스타일 */
        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            margin-top: 24px;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }

        .table-container thead tr {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .table-container th {
            padding: 20px 12px;
            border-bottom: 3px solid #e5e7eb;
            text-align: left;
            font-weight: 800;
            color: #1f2937;
            font-size: 13px;
        }

        .table-container td {
            padding: 15px 12px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
        }

        .table-container tbody tr:hover {
            background: #f9fafb;
        }

        .action-btn {
            padding: 6px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .action-btn.view {
            background: #6b7280;
        }

        .action-btn.edit {
            background: #059669;
        }

        .action-btn.delete {
            background: #ef4444;
        }

        /* 상태 배지 스타일 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-badge.processing {
            background: #f59e0b;
        }

        .status-badge.completed {
            background: #059669;
        }

        .status-badge.urgent {
            background: #dc2626;
        }

        .status-badge.excluded {
            background: #6b7280;
        }

        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 폼 섹션 스타일 */
        .form-section {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 700;
        }

        .form-section.basic-info {
            background: #f8f9fa;
        }

        .form-section.referral-info {
            background: #fff7ed;
        }

        .form-section.referral-type {
            background: #f0f9ff;
        }

        .form-section.diagnosis-info {
            background: #fef3c7;
        }

        .form-section.content-info {
            background: #f3f4f6;
        }

        /* 디버깅 패널 스타일 */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10002;
            background: #1f2937;
            color: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 400px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid #374151;
        }

        .debug-panel.hidden {
            display: none;
        }

        .debug-panel h4 {
            color: #10b981;
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 700;
        }

        .debug-info {
            margin-bottom: 8px;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
            border-radius: 4px;
        }

        .debug-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10003;
            background: #374151;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .debug-toggle:hover {
            background: #4b5563;
        }

        /* 숨김 클래스 */
        .hidden {
            display: none !important;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .dashboard-container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 알림 컨테이너 -->
    <div id="notificationContainer" style="position: fixed; top: 80px; right: 24px; z-index: 10001;"></div>
    
    <!-- 상태 바 -->
    <div class="status-bar">
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <span>데이터 관리 시스템 v2.1</span>
            <span style="margin-left: 16px; font-size: 11px; opacity: 0.8;">|</span>
            <span style="margin-left: 8px; font-size: 11px;">
                <span style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>💾</span>
                    <span>로컬 저장 + 디버깅</span>
                </span>
            </span>
        </div>
        <div>
            <span>접속자: <span id="onlineCount">1</span>명 | <span id="currentTime"></span></span>
        </div>
    </div>

    <!-- 디버깅 토글 버튼 -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">🐛 디버그</button>

    <!-- 디버깅 패널 -->
    <div id="debugPanel" class="debug-panel hidden">
        <h4>🔧 시스템 디버그 정보</h4>
        <div id="debugContent">
            <div class="debug-info">시스템 초기화 중...</div>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="debugSystemStatus()" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">상태 체크</button>
            <button onclick="clearDebugLog()" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 4px;">로그 클리어</button>
        </div>
    </div>

    <!-- 로그인 화면 -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>🏥 정신건강복지센터</h1>
                <p>데이터 관리 시스템 v2.1 (디버깅 강화)</p>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label for="username">사용자 ID</label>
                    <input type="text" id="username" placeholder="사용자 ID를 입력하세요" value="admin" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" placeholder="비밀번호를 입력하세요" value="1234" autocomplete="current-password">
                </div>
                <button class="btn" onclick="handleLogin()" id="loginBtn">로그인</button>
                
                <div style="text-align: center; margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                    <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                        🔧 <strong>v2.1 업데이트</strong><br>
                        • 디버깅 시스템 강화<br>
                        • 이벤트 리스너 오류 수정<br>
                        • 실시간 상태 모니터링
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 새 의뢰 모달 -->
    <div id="newReferralModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">🏥 새 의뢰 접수</h2>
                <button class="modal-close" onclick="closeNewReferralModal()">×</button>
            </div>
            
            <form id="newReferralForm">
                <!-- 기본 정보 섹션 -->
                <div class="form-section basic-info">
                    <h3>👤 기본 정보</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>이름 *</label>
                            <input type="text" id="referrerName" required placeholder="예: 김철수" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>성별 *</label>
                            <select id="referrerGender" required>
                                <option value="">선택하세요</option>
                                <option value="남성">남성</option>
                                <option value="여성">여성</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>나이 *</label>
                            <input type="number" id="referrerAge" required min="0" max="120" placeholder="예: 35">
                        </div>
                        <div class="form-group">
                            <label>의뢰날짜 *</label>
                            <input type="date" id="referralDate" required>
                        </div>
                        <div class="form-group">
                            <label>지역</label>
                            <input type="text" id="region" placeholder="예: 이천시 창전동" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>담당자</label>
                            <input type="text" id="assignedCounselor" placeholder="담당 상담사명" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- 의뢰 정보 섹션 -->
                <div class="form-section referral-info">
                    <h3>📋 의뢰 정보</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>의뢰경로</label>
                            <input type="text" id="referralPath" placeholder="의뢰 경로" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>의뢰기관 *</label>
                            <select id="referringAgency" required>
                                <option value="">선택하세요</option>
                                <option value="읍.면.동 행정복지센터">읍.면.동 행정복지센터</option>
                                <option value="이천시청">이천시청</option>
                                <option value="경찰서">경찰서</option>
                                <option value="소방">소방</option>
                                <option value="의료기관">의료기관</option>
                                <option value="정신보건기관">정신보건기관</option>
                                <option value="보건소">보건소</option>
                                <option value="가족">가족</option>
                                <option value="지인">지인</option>
                                <option value="지역사회">지역사회</option>
                                <option value="복지관">복지관</option>
                                <option value="학교">학교</option>
                                <option value="기타">기타</option>
                                <option value="1393/129">1393/129</option>
                                <option value="본인">본인</option>
                                <option value="이동상담">이동상담</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>담당팀 *</label>
                            <select id="assignedTeam" required>
                                <option value="">선택하세요</option>
                                <option value="증진팀">증진팀</option>
                                <option value="회복팀">회복팀</option>
                                <option value="자살예방센터">자살예방센터</option>
                                <option value="아동청소년">아동청소년</option>
                                <option value="남부분소">남부분소</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CRI</label>
                            <input type="text" id="criInfo" placeholder="CRI 정보" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- 의뢰 유형 섹션 -->
                <div class="form-section referral-type">
                    <h3>📋 의뢰 유형</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <input type="checkbox" id="diagnosisProtectionRequest" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">진단 보호요청</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <input type="checkbox" id="writtenReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">서면의뢰</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <input type="checkbox" id="phoneReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">유선의뢰</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <input type="checkbox" id="policeInvolvement" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">경찰개입여부</span>
                        </label>
                    </div>
                </div>

                <!-- 진단 및 조치 정보 섹션 -->
                <div class="form-section diagnosis-info">
                    <h3>🏥 진단 및 조치 정보</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>진단명</label>
                            <input type="text" id="diagnosis" placeholder="예: 우울증, 조현병 등" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>조치결과</label>
                            <select id="actionResult">
                                <option value="">선택하세요</option>
                                <option value="등록관리(기등록포함)">등록관리(기등록포함)</option>
                                <option value="지속상담">지속상담</option>
                                <option value="치료연계">치료연계</option>
                                <option value="서비스 연계">서비스 연계</option>
                                <option value="기타조치">기타조치</option>
                                <option value="정보제공">정보제공</option>
                                <option value="종결">종결</option>
                                <option value="처리중">처리중</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>종결여부</label>
                            <select id="closureStatus">
                                <option value="">선택하세요</option>
                                <option value="진행중">진행중</option>
                                <option value="종결">종결</option>
                                <option value="조치 결과 등록제외">조치 결과 등록제외</option>
                                <option value="미등록자 종결">미등록자 종결</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 상세 내용 섹션 -->
                <div class="form-section content-info">
                    <h3>📝 상세 내용</h3>
                    <div class="form-group">
                        <label>개입내용/현상황 *</label>
                        <textarea id="interventionContent" required style="min-height: 150px; resize: vertical; font-family: 'Malgun Gothic', sans-serif; line-height: 1.6;" placeholder="현재 상황, 개입 내용, 증상의 구체적 내용 등을 상세히 기술해주세요." maxlength="5000"></textarea>
                    </div>
                </div>

                <!-- 회신 정보 섹션 -->
                <div class="form-section" style="background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); border: 2px solid #64748b;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 24px;">📬</span>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 700;">회신 정보</h3>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 700; color: #1f2937; font-size: 15px;">회신여부 및 내용</label>
                        <textarea id="responseRequired" style="min-height: 80px; resize: vertical; border: 2px solid #cbd5e1; font-family: 'Malgun Gothic', sans-serif;" placeholder="회신이 필요한 경우 구체적인 내용을 작성해주세요." maxlength="1000"></textarea>
                    </div>
                </div>
                
                <!-- 버튼 그룹 -->
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" onclick="closeNewReferralModal()" style="padding: 14px 28px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">취소</button>
                    <button type="button" onclick="saveDraftReferral()" style="padding: 14px 28px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">임시저장</button>
                    <button type="submit" style="padding: 14px 28px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">접수 완료</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 의뢰 상세보기 모달 -->
    <div id="referralDetailModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">의뢰 상세보기</h2>
                <button class="modal-close" onclick="closeReferralDetailModal()">×</button>
            </div>
            
            <div id="referralDetailContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <!-- 상세 내용이 여기에 표시됩니다 -->
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px;">
                <button onclick="closeReferralDetailModal()" style="padding: 12px 24px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">닫기</button>
                <button id="editCurrentReferralBtn" onclick="editCurrentReferral()" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">수정</button>
            </div>
        </div>
    </div>

    <!-- 의뢰 수정 모달 -->
    <div id="editReferralModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">✏️ 의뢰 수정</h2>
                <button class="modal-close" onclick="closeEditReferralModal()">×</button>
            </div>
            
            <form id="editReferralForm">
                <!-- 기본 정보 -->
                <div class="form-section basic-info">
                    <h3>👤 기본 정보</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>의뢰번호</label>
                            <input type="text" id="editRefNo" readonly style="background: #f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label>이름 *</label>
                            <input type="text" id="editReferrerName" required maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>성별 *</label>
                            <select id="editReferrerGender" required>
                                <option value="남성">남성</option>
                                <option value="여성">여성</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>나이 *</label>
                            <input type="number" id="editReferrerAge" required min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label>의뢰날짜 *</label>
                            <input type="date" id="editReferralDate" required>
                        </div>
                        <div class="form-group">
                            <label>지역</label>
                            <input type="text" id="editRegion" maxlength="100">
                        </div>
                    </div>
                </div>

                <!-- 의뢰 정보 -->
                <div class="form-section referral-info">
                    <h3>📋 의뢰 정보</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>의뢰경로</label>
                            <input type="text" id="editReferralPath" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>의뢰기관 *</label>
                            <select id="editReferringAgency" required>
                                <option value="읍.면.동 행정복지센터">읍.면.동 행정복지센터</option>
                                <option value="이천시청">이천시청</option>
                                <option value="경찰서">경찰서</option>
                                <option value="소방">소방</option>
                                <option value="의료기관">의료기관</option>
                                <option value="정신보건기관">정신보건기관</option>
                                <option value="보건소">보건소</option>
                                <option value="가족">가족</option>
                                <option value="지인">지인</option>
                                <option value="지역사회">지역사회</option>
                                <option value="복지관">복지관</option>
                                <option value="학교">학교</option>
                                <option value="기타">기타</option>
                                <option value="1393/129">1393/129</option>
                                <option value="본인">본인</option>
                                <option value="이동상담">이동상담</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>담당팀 *</label>
                            <select id="editAssignedTeam" required>
                                <option value="증진팀">증진팀</option>
                                <option value="회복팀">회복팀</option>
                                <option value="자살예방센터">자살예방센터</option>
                                <option value="아동청소년">아동청소년</option>
                                <option value="남부분소">남부분소</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>담당자</label>
                            <input type="text" id="editCounselor" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>CRI</label>
                            <input type="text" id="editCriInfo" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- 진단 및 조치 정보 -->
                <div class="form-section diagnosis-info">
                    <h3>🏥 진단 및 조치 정보</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>진단명</label>
                            <input type="text" id="editDiagnosis" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>조치결과</label>
                            <select id="editActionResult">
                                <option value="등록관리(기등록포함)">등록관리(기등록포함)</option>
                                <option value="지속상담">지속상담</option>
                                <option value="치료연계">치료연계</option>
                                <option value="서비스 연계">서비스 연계</option>
                                <option value="기타조치">기타조치</option>
                                <option value="정보제공">정보제공</option>
                                <option value="종결">종결</option>
                                <option value="처리중">처리중</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>종결여부 *</label>
                            <select id="editClosureStatus" required>
                                <option value="진행중">진행중</option>
                                <option value="종결">종결</option>
                                <option value="조치 결과 등록제외">조치 결과 등록제외</option>
                                <option value="미등록자 종결">미등록자 종결</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 개입내용 섹션 -->
                <div class="form-section content-info">
                    <h3>📝 개입내용/현상황</h3>
                    <div class="form-group">
                        <label>개입내용/현상황 *</label>
                        <textarea id="editInterventionContent" required style="min-height: 150px; resize: vertical; font-family: 'Malgun Gothic', sans-serif; line-height: 1.6;" placeholder="현재 상황, 개입 내용, 증상의 구체적 내용 등을 상세히 기술해주세요." maxlength="5000"></textarea>
                    </div>
                </div>
                
                <!-- 회신 정보 섹션 -->
                <div class="form-section" style="background: #f0f4f8;">
                    <h3>📬 회신 정보</h3>
                    <div class="form-group">
                        <label>회신여부 및 내용</label>
                        <textarea id="editResponseRequired" style="min-height: 80px; resize: vertical; border: 2px solid #cbd5e1; font-family: 'Malgun Gothic', sans-serif;" placeholder="회신이 필요한 경우 구체적인 내용을 작성해주세요." maxlength="1000"></textarea>
                    </div>
                </div>
                
                <!-- 버튼 그룹 -->
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" onclick="closeEditReferralModal()" style="padding: 14px 28px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">취소</button>
                    <button type="button" onclick="handleSaveEditedReferral()" id="saveEditedReferralBtn" style="padding: 14px 28px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">💾 저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div id="mainApp" class="app-container hidden">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>정신건강복지센터</h2>
                <div class="user-info">
                    <div id="currentUserName">시스템관리자</div>
                    <div id="currentUserRole">관리자</div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item">
                    <div class="nav-link active" onclick="showPage('referrals')">
                        <span class="icon">👥</span>
                        의뢰 관리
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('data')">
                        <span class="icon">💾</span>
                        데이터 관리
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('reports')">
                        <span class="icon">📈</span>
                        통계/보고서
                    </div>
                </div>
                <div class="nav-item" style="margin-top: 30px;">
                    <div class="nav-link" onclick="handleLogout()" style="color: var(--danger-color);">
                        <span class="icon">🚪</span>
                        로그아웃
                    </div>
                </div>
            </div>
        </nav>

        <!-- 메인 콘텐츠 영역 -->
        <main class="main-content">
            <!-- 의뢰 관리 페이지 -->
            <div id="referralsPage" class="page">
                <div class="dashboard-container">
                    <!-- 페이지 헤더 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding: 32px 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: var(--shadow); flex-wrap: wrap; gap: 20px;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">의뢰 관리</h1>
                        <button class="new-referral-btn" onclick="openNewReferralModal()">
                            <span>➕</span>
                            새 의뢰 접수
                        </button>
                    </div>
                    
                    <!-- 팀별 탭 시스템 -->
                    <div class="team-management-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 32px; text-align: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">
                        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 800;">🏥 팀별 의뢰 관리 시스템</h2>
                        <p style="margin: 0; font-size: 16px; opacity: 0.9;">각 팀별로 의뢰를 체계적으로 관리하고 추적하세요</p>
                    </div>
                    
                    <!-- 팀 선택 탭 -->
                    <div class="team-tabs-container" style="margin-bottom: 32px;">
                        <div class="team-tabs-wrapper" style="background: white; border-radius: 20px; padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 2px solid #e5e7eb;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 20px; font-weight: 700;">팀 선택</h3>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">보고 싶은 팀을 선택하세요</p>
                            </div>
                            
                            <div id="teamTabsGrid" class="team-tabs-grid">
                                <div class="chart-data-display">
                                    <div class="chart-item" onclick="selectTeam('all')" style="cursor: pointer;" data-team="all">
                                        <div class="chart-item-value">📊</div>
                                        <div class="chart-item-label">전체 팀</div>
                                        <div class="chart-item-percentage" id="allTeamCount">5건</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('증진팀')" style="cursor: pointer;" data-team="증진팀">
                                        <div class="chart-item-value">🎯</div>
                                        <div class="chart-item-label">증진팀</div>
                                        <div class="chart-item-percentage" id="team1Count">1건</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('회복팀')" style="cursor: pointer;" data-team="회복팀">
                                        <div class="chart-item-value">🌱</div>
                                        <div class="chart-item-label">회복팀</div>
                                        <div class="chart-item-percentage" id="team2Count">1건</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('자살예방센터')" style="cursor: pointer;" data-team="자살예방센터">
                                        <div class="chart-item-value">🚨</div>
                                        <div class="chart-item-label">자살예방센터</div>
                                        <div class="chart-item-percentage" id="team3Count">1건</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('아동청소년')" style="cursor: pointer;" data-team="아동청소년">
                                        <div class="chart-item-value">👶</div>
                                        <div class="chart-item-label">아동청소년</div>
                                        <div class="chart-item-percentage" id="team4Count">1건</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('남부분소')" style="cursor: pointer;" data-team="남부분소">
                                        <div class="chart-item-value">🏢</div>
                                        <div class="chart-item-label">남부분소</div>
                                        <div class="chart-item-percentage" id="team5Count">1건</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 현재 팀 정보 -->
                    <div id="currentTeamInfo" class="current-team-info">
                        <div style="background: linear-gradient(135deg, #f9fafb, white); border: 3px solid #6b7280; border-radius: 16px; padding: 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="font-size: 56px;" id="currentTeamIcon">📊</div>
                                <div>
                                    <h3 style="margin: 0; color: #6b7280; font-size: 24px; font-weight: 800;" id="currentTeamTitle">전체 팀 의뢰 목록</h3>
                                    <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 16px;" id="currentTeamDesc">모든 팀의 의뢰를 통합 관리</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 48px; font-weight: 900; color: #6b7280;" id="currentTeamCount">5</div>
                                <div style="font-size: 16px; color: #6b7280; font-weight: 600;">총 의뢰 건수</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 의뢰 목록 위젯 -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">의뢰 목록</h3>
                            <span class="widget-icon">📋</span>
                        </div>
                        <div id="referralsList">
                            <div class="table-container">
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>의뢰번호</th>
                                                <th>이름</th>
                                                <th>성별/나이</th>
                                                <th>의뢰날짜</th>
                                                <th>의뢰기관</th>
                                                <th>담당팀</th>
                                                <th>담당자</th>
                                                <th>진단명</th>
                                                <th>조치결과</th>
                                                <th>종결여부</th>
                                                <th style="text-align: center;">작업</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referralsTableBody">
                                            <!-- 기본 데이터가 여기에 표시됩니다 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 데이터 관리 페이지 -->
            <div id="dataPage" class="page hidden">
                <div class="dashboard-container">
                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow-lg); text-align: center;">
                        <h1 style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 32px; font-weight: 800; margin-bottom: 12px;">💾 데이터 관리</h1>
                        <p style="color: var(--text-secondary); font-size: 16px;">데이터 백업, 엑셀 다운로드 및 파일 관리</p>
                    </div>

                    <!-- 데이터 내보내기 -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">📊 데이터 내보내기</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">📊</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <button onclick="downloadExcel()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: #059669; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>📈</span> 엑셀 다운로드 (.xlsx)
                            </button>
                            <button onclick="downloadJSON()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>💾</span> JSON 백업
                            </button>
                            <button onclick="downloadCSV()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: #d97706; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>📄</span> CSV 다운로드
                            </button>
                        </div>
                    </div>

                    <!-- 데이터 통계 -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">📈 데이터 현황</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">📈</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="totalReferrals">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">총 의뢰 건수</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="completedReferrals">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">종결 건수</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="progressingReferrals">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">진행 중</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="avgAge">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">평균 연령</div>
                            </div>
                        </div>
                    </div>

                    <!-- 활동 로그 -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">📋 시스템 활동 로그</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">📋</span>
                        </div>
                        <div id="activityLog" style="background: #1f2937; color: #f9fafb; border-radius: 12px; padding: 16px; height: 250px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #10b981; border-radius: 4px; background: rgba(16, 185, 129, 0.1);">
                                [시스템] 💾 정신건강복지센터 데이터 관리 시스템 초기화 완료
                            </div>
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #3b82f6; border-radius: 4px; background: rgba(59, 130, 246, 0.1);">
                                [정보] 📊 엑셀, CSV, JSON 다운로드 기능 활성화
                            </div>
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #10b981; border-radius: 4px; background: rgba(16, 185, 129, 0.1);">
                                [성공] 📈 실시간 통계 및 차트 시스템 준비 완료
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 통계/보고서 페이지 -->
            <div id="reportsPage" class="page hidden">
                <div class="dashboard-container">
                    <div style="background: var(--gradient-card); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow); text-align: center;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 16px;">📈 통계 및 보고서</h1>
                        <p style="font-size: 18px; color: var(--text-secondary); font-weight: 500;">의뢰 데이터를 다양한 관점에서 분석한 시각적 통계</p>
                    </div>
                    
                    <!-- 차트 그리드 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 40px;">
                        
                        <!-- 성별 분포 차트 -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">👥 성별 분포</h3>
                            <canvas id="genderChart" width="300" height="200"></canvas>
                        </div>

                        <!-- 연령별 분포 차트 -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">📊 연령별 분포</h3>
                            <canvas id="ageChart" width="300" height="200"></canvas>
                        </div>

                        <!-- 팀별 분포 차트 -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">🏢 팀별 분포</h3>
                            <canvas id="teamChart" width="300" height="200"></canvas>
                        </div>

                        <!-- 지역별 분포 차트 -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">🗺️ 지역별 분포</h3>
                            <canvas id="regionChart" width="300" height="200"></canvas>
                        </div>

                        <!-- 담당자별 분포 차트 -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">👨‍⚕️ 담당자별 분포</h3>
                            <canvas id="counselorChart" width="300" height="200"></canvas>
                        </div>

                        <!-- 조치결과별 분포 차트 -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">📋 조치결과별 분포</h3>
                            <canvas id="actionChart" width="300" height="200"></canvas>
                        </div>
                    </div>

                    <!-- 월별 추이 차트 -->
                    <div style="background: white; padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 40px;">
                        <h3 style="text-align: center; margin-bottom: 24px; color: #1f2937; font-size: 20px; font-weight: 700;">📈 월별 의뢰 추이</h3>
                        <canvas id="monthlyChart" width="800" height="300"></canvas>
                    </div>

                    <!-- 종합 통계 요약 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 32px; border-radius: 20px; box-shadow: var(--shadow);">
                        <h3 style="text-align: center; margin-bottom: 24px; font-size: 24px; font-weight: 700;">📊 종합 통계 요약</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryTotal">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">총 접수 건수</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryMale">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">남성 비율</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryFemale">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">여성 비율</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryCompleted">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">종결률</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 전역 변수 초기화
        let currentUserInfo = null;
        let currentActivePage = 'referrals';
        let selectedTeamFilter = 'all';
        let editingReferralData = null;
        let viewingReferralData = null;
        let charts = {}; // 차트 인스턴스 저장용

        // 🔧 디버깅 시스템
        let debugLog = [];
        
        function debugAddLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLog.push(logEntry);
            
            // 디버그 패널에 실시간 표시
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const logDiv = document.createElement('div');
                logDiv.className = type === 'error' ? 'debug-error' : 'debug-info';
                logDiv.textContent = `[${timestamp}] ${message}`;
                debugContent.appendChild(logDiv);
                
                // 최대 20개 로그만 유지
                while (debugContent.children.length > 20) {
                    debugContent.removeChild(debugContent.firstChild);
                }
                
                // 자동 스크롤
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // 콘솔에도 출력
            console.log(`🔧 [${type.toUpperCase()}] ${message}`);
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                panel.classList.toggle('hidden');
                debugAddLog('디버그 패널 토글', 'info');
            }
        }
        
        function clearDebugLog() {
            debugLog = [];
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = '<div class="debug-info">로그가 클리어되었습니다.</div>';
            }
        }
        
        function debugSystemStatus() {
            debugAddLog('=== 시스템 상태 체크 ===', 'info');
            debugAddLog(`전체 의뢰 데이터: ${referralDatabase.length}건`, 'info');
            debugAddLog(`현재 보고있는 의뢰: ${viewingReferralData ? viewingReferralData.refNo : 'null'}`, 'info');
            debugAddLog(`현재 수정중인 의뢰: ${editingReferralData ? editingReferralData.refNo : 'null'}`, 'info');
            debugAddLog(`현재 활성 페이지: ${currentActivePage}`, 'info');
            debugAddLog(`선택된 팀 필터: ${selectedTeamFilter}`, 'info');
            debugAddLog(`현재 사용자: ${currentUserInfo ? currentUserInfo.name : 'null'}`, 'info');
            
            // DOM 요소 존재 확인
            const criticalElements = [
                'editReferralModal',
                'editReferralForm',
                'editCurrentReferralBtn',
                'saveEditedReferralBtn'
            ];
            
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                debugAddLog(`DOM 요소 ${id}: ${element ? '✅ 존재' : '❌ 없음'}`, element ? 'info' : 'error');
            });
            
            debugAddLog('=== 상태 체크 완료 ===', 'info');
        }

        // 의뢰 데이터 - 실제 정신건강복지센터 양식 적용
        let referralDatabase = [
            { 
                refNo: 'R0001', 
                name: '김**', 
                gender: '남성', 
                age: 35, 
                referralDate: '2025-07-10',
                referralPath: '가족신고',
                agency: '읍.면.동 행정복지센터', 
                team: '회복팀',
                region: '이천시 창전동',
                counselor: '박상담사', 
                diagnosis: '우울증', 
                interventionContent: '최근 2개월간 우울감 심화, 일상생활 어려움. 가족 신고로 상담 의뢰.',
                actionResult: '지속상담',
                closureStatus: '진행중',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-001',
                responseRequired: '처리결과 회신 요청'
            },
            { 
                refNo: 'R0002', 
                name: '이**', 
                gender: '여성', 
                age: 28, 
                referralDate: '2025-07-12',
                referralPath: '경찰신고',
                agency: '경찰서', 
                team: '자살예방센터',
                region: '이천시 부발읍',
                counselor: '김상담사', 
                diagnosis: '조현병', 
                interventionContent: '자해 시도 후 경찰 출동. 즉시 전문상담 필요한 상태.',
                actionResult: '등록관리(기등록포함)',
                closureStatus: '진행중',
                diagnosisProtection: true,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: true,
                criInfo: 'CRI-002',
                responseRequired: '긴급 조치 결과 즉시 회신 필요'
            },
            { 
                refNo: 'R0003', 
                name: '박**', 
                gender: '남성', 
                age: 16, 
                referralDate: '2025-07-13',
                referralPath: '학교의뢰',
                agency: '학교', 
                team: '아동청소년',
                region: '이천시 신둔면',
                counselor: '최상담사', 
                diagnosis: '불안장애', 
                interventionContent: '학교에서 또래관계 어려움 및 불안증상으로 의뢰.',
                actionResult: '치료연계',
                closureStatus: '진행중',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-003',
                responseRequired: '-'
            },
            { 
                refNo: 'R0004', 
                name: '최**', 
                gender: '여성', 
                age: 42, 
                referralDate: '2025-07-14',
                referralPath: '보건소의뢰',
                agency: '보건소', 
                team: '증진팀',
                region: '이천시 호법면',
                counselor: '정상담사', 
                diagnosis: '기타질환', 
                interventionContent: '정신건강 상담 요청. 스트레스 관리 필요.',
                actionResult: '종결',
                closureStatus: '종결',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: false,
                criInfo: 'CRI-004',
                responseRequired: '상담 완료 결과 통보'
            },
            { 
                refNo: 'R0005', 
                name: '정**', 
                gender: '남성', 
                age: 52, 
                referralDate: '2025-07-14',
                referralPath: '본인신청',
                agency: '본인', 
                team: '남부분소',
                region: '이천시 마장면',
                counselor: '송상담사', 
                diagnosis: '알코올사용장애', 
                interventionContent: '본인이 직접 알코올 문제로 상담 신청.',
                actionResult: '처리중',
                closureStatus: '진행중',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-005',
                responseRequired: '-'
            }
        ];

        // 현재 시간 업데이트
        function updateCurrentTime() {
            try {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString('ko-KR');
                }
            } catch (error) {
                debugAddLog('시간 업데이트 오류: ' + error.message, 'error');
            }
        }

        // 알림 표시 함수
        function showNotification(message, type = 'info') {
            try {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                // 기존 알림이 너무 많으면 제거
                while (container.children.length >= 3) {
                    container.removeChild(container.firstChild);
                }

                const notification = document.createElement('div');
                notification.className = 'notification ' + type;
                
                const messageDiv = document.createElement('div');
                messageDiv.style.display = 'flex';
                messageDiv.style.justifyContent = 'space-between';
                messageDiv.style.alignItems = 'center';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '×';
                closeButton.style.cssText = 'background:none;border:none;font-size:18px;cursor:pointer;margin-left:10px;color:inherit;';
                closeButton.onclick = function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                };
                
                messageDiv.appendChild(textSpan);
                messageDiv.appendChild(closeButton);
                notification.appendChild(messageDiv);
                container.appendChild(notification);
                
                // 자동 제거
                setTimeout(function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                debugAddLog('알림 표시 오류: ' + error.message, 'error');
            }
        }

        // 로그인 처리 함수
        function handleLogin() {
            try {
                debugAddLog('로그인 시도 시작', 'info');
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = '로그인 중...';

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!username || !password) {
                    showNotification('사용자 ID와 비밀번호를 입력하세요.', 'error');
                    return;
                }

                if (username === 'admin' && password === '1234') {
                    currentUserInfo = { 
                        name: '시스템관리자', 
                        role: '관리자'
                    };
                    
                    const loginScreen = document.getElementById('loginScreen');
                    const mainApp = document.getElementById('mainApp');
                    
                    if (loginScreen) loginScreen.classList.add('hidden');
                    if (mainApp) mainApp.classList.remove('hidden');
                    
                    // 사용자 정보 업데이트
                    const nameElement = document.getElementById('currentUserName');
                    const roleElement = document.getElementById('currentUserRole');
                    if (nameElement) nameElement.textContent = currentUserInfo.name;
                    if (roleElement) roleElement.textContent = currentUserInfo.role;
                    
                    showNotification(`환영합니다, ${currentUserInfo.name}님! 디버깅 시스템이 활성화되었습니다.`, 'success');
                    debugAddLog('로그인 성공: ' + currentUserInfo.name, 'info');
                    
                    // 시스템 초기화
                    updateReferralsTable();
                    updateTeamCounts();
                    updateDataStats();
                    selectTeam('all');
                } else {
                    showNotification('사용자 ID 또는 비밀번호가 올바르지 않습니다.', 'error');
                    debugAddLog('로그인 실패: 잘못된 자격증명', 'error');
                }
            } catch (error) {
                debugAddLog('로그인 오류: ' + error.message, 'error');
                showNotification('로그인 처리 중 오류가 발생했습니다.', 'error');
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = '로그인';
            }
        }

        // 로그아웃 처리 함수
        function handleLogout() {
            try {
                if (confirm('로그아웃 하시겠습니까?')) {
                    currentUserInfo = null;
                    
                    const mainApp = document.getElementById('mainApp');
                    const loginScreen = document.getElementById('loginScreen');
                    
                    if (mainApp) mainApp.classList.add('hidden');
                    if (loginScreen) loginScreen.classList.remove('hidden');
                    
                    showNotification('로그아웃되었습니다.', 'info');
                    debugAddLog('로그아웃 완료', 'info');
                }
            } catch (error) {
                debugAddLog('로그아웃 오류: ' + error.message, 'error');
            }
        }

        // 페이지 전환 함수
        function showPage(pageId) {
            try {
                debugAddLog('페이지 전환: ' + pageId, 'info');
                
                // 모든 페이지 숨기기
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => page.classList.add('hidden'));

                // 모든 네비게이션 링크 비활성화
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));

                // 선택된 페이지 표시
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }

                // 페이지별 초기화
                if (pageId === 'reports') {
                    // 통계 페이지 진입 시 차트 생성
                    setTimeout(() => createCharts(), 100);
                } else if (pageId === 'data') {
                    // 데이터 관리 페이지 진입 시 통계 업데이트
                    updateDataStats();
                }

                // 선택된 네비게이션 링크 활성화
                const activeNav = document.querySelector(`.nav-link[onclick*="${pageId}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }

                currentActivePage = pageId;
                
                const pageNames = {
                    'referrals': '의뢰 관리',
                    'data': '데이터 관리',
                    'reports': '통계/보고서'
                };
                
                showNotification(`${pageNames[pageId] || pageId} 페이지로 이동했습니다.`, 'info');
            } catch (error) {
                debugAddLog('페이지 전환 오류: ' + error.message, 'error');
            }
        }

        // 팀 선택 함수
        function selectTeam(teamId) {
            try {
                debugAddLog('팀 선택: ' + teamId, 'info');
                selectedTeamFilter = teamId;
                
                // 모든 팀 아이템 스타일 리셋
                const teamItems = document.querySelectorAll('[data-team]');
                teamItems.forEach(item => {
                    item.style.background = '#f8f9fa';
                    item.style.color = '#374151';
                    item.style.transform = 'none';
                    item.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                });
                
                // 선택된 팀 강조 표시
                const selectedTeam = document.querySelector(`[data-team="${teamId}"]`);
                if (selectedTeam) {
                    const teamColors = {
                        'all': '#6b7280',
                        '증진팀': '#3b82f6',
                        '회복팀': '#059669',
                        '자살예방센터': '#dc2626',
                        '아동청소년': '#d97706',
                        '남부분소': '#7c3aed'
                    };
                    
                    const color = teamColors[teamId] || '#6b7280';
                    selectedTeam.style.background = color;
                    selectedTeam.style.color = 'white';
                    selectedTeam.style.transform = 'translateY(-2px) scale(1.05)';
                    selectedTeam.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
                }
                
                updateCurrentTeamDisplay(teamId);
                updateReferralsTable();
                
                const teamNames = {
                    'all': '전체 팀',
                    '증진팀': '증진팀',
                    '회복팀': '회복팀',
                    '자살예방센터': '자살예방센터',
                    '아동청소년': '아동청소년',
                    '남부분소': '남부분소'
                };
                
                showNotification(`${teamNames[teamId]} 선택됨`, 'info');
            } catch (error) {
                debugAddLog('팀 선택 오류: ' + error.message, 'error');
            }
        }

        // 현재 팀 표시 업데이트
        function updateCurrentTeamDisplay(teamId) {
            try {
                const teamInfo = {
                    'all': { icon: '📊', title: '전체 팀 의뢰 목록', desc: '모든 팀의 의뢰를 통합 관리', color: '#6b7280' },
                    '증진팀': { icon: '🎯', title: '증진팀 의뢰 목록', desc: '정신건강 증진사업 관련 의뢰', color: '#3b82f6' },
                    '회복팀': { icon: '🌱', title: '회복팀 의뢰 목록', desc: '정신건강 회복지원 관련 의뢰', color: '#059669' },
                    '자살예방센터': { icon: '🚨', title: '자살예방센터 의뢰 목록', desc: '자살예방 및 위기개입 의뢰', color: '#dc2626' },
                    '아동청소년': { icon: '👶', title: '아동청소년 의뢰 목록', desc: '아동청소년 정신건강 의뢰', color: '#d97706' },
                    '남부분소': { icon: '🏢', title: '남부분소 의뢰 목록', desc: '남부분소 관할 지역 의뢰', color: '#7c3aed' }
                };
                
                const info = teamInfo[teamId] || teamInfo['all'];
                
                const iconElement = document.getElementById('currentTeamIcon');
                const titleElement = document.getElementById('currentTeamTitle');
                const descElement = document.getElementById('currentTeamDesc');
                
                if (iconElement) iconElement.textContent = info.icon;
                if (titleElement) titleElement.textContent = info.title;
                if (descElement) descElement.textContent = info.desc;
                
                const currentTeamInfo = document.getElementById('currentTeamInfo');
                if (currentTeamInfo) {
                    const border = currentTeamInfo.querySelector('div');
                    if (border) border.style.borderColor = info.color;
                    
                    const titles = currentTeamInfo.querySelectorAll('h3, p, div');
                    titles.forEach(element => {
                        element.style.color = info.color;
                    });
                }
            } catch (error) {
                debugAddLog('팀 표시 업데이트 오류: ' + error.message, 'error');
            }
        }

        // 의뢰 테이블 업데이트
        function updateReferralsTable() {
            try {
                debugAddLog('의뢰 테이블 업데이트 시작', 'info');
                const tbody = document.getElementById('referralsTableBody');
                if (!tbody) {
                    debugAddLog('테이블 body 요소를 찾을 수 없음', 'error');
                    return;
                }
                
                tbody.innerHTML = '';
                
                const filteredData = selectedTeamFilter === 'all' ? 
                    referralDatabase : referralDatabase.filter(item => item.team === selectedTeamFilter);
                
                const countElement = document.getElementById('currentTeamCount');
                if (countElement) {
                    countElement.textContent = filteredData.length;
                }
                
                // 상태별 색상 정의
                const actionResultColors = {
                    '등록관리(기등록포함)': '#3b82f6',
                    '지속상담': '#059669',
                    '치료연계': '#d97706',
                    '서비스 연계': '#7c3aed',
                    '기타조치': '#6b7280',
                    '정보제공': '#0891b2',
                    '종결': '#059669',
                    '처리중': '#f59e0b'
                };
                
                const closureStatusColors = {
                    '진행중': '#d97706',
                    '종결': '#059669',
                    '조치 결과 등록제외': '#6b7280',
                    '미등록자 종결': '#ef4444'
                };
                
                const teamColors = {
                    '증진팀': '#3b82f6',
                    '회복팀': '#059669',
                    '자살예방센터': '#dc2626',
                    '아동청소년': '#d97706',
                    '남부분소': '#7c3aed'
                };
                
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f3f4f6';
                    row.onmouseover = function() { this.style.background = '#f9fafb'; };
                    row.onmouseout = function() { this.style.background = 'white'; };
                    
                    row.innerHTML = `
                        <td style="padding: 15px 12px; font-weight: 700; color: #1f2937; font-size: 13px;">${item.refNo}</td>
                        <td style="padding: 15px 12px; font-weight: 600; font-size: 13px;">${item.name}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.gender}<br><small style="color: #6b7280;">${item.age}세</small></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.referralDate}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.agency}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span style="color: ${teamColors[item.team] || '#6b7280'}; font-weight: 600;">${item.team}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.counselor}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.diagnosis}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${actionResultColors[item.actionResult] || '#6b7280'};">${item.actionResult || '-'}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${closureStatusColors[item.closureStatus] || '#6b7280'};">${item.closureStatus}</span></td>
                        <td style="padding: 15px 12px; text-align: center;">
                            <button class="action-btn view" onclick="viewReferralDetail('${item.refNo}')">상세</button>
                            <button class="action-btn edit" onclick="editReferral('${item.refNo}')">수정</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                debugAddLog(`테이블 업데이트 완료: ${filteredData.length}건`, 'info');
            } catch (error) {
                debugAddLog('의뢰 테이블 업데이트 오류: ' + error.message, 'error');
            }
        }

        // 팀별 카운트 업데이트
        function updateTeamCounts() {
            try {
                const teams = ['증진팀', '회복팀', '자살예방센터', '아동청소년', '남부분소'];
                
                const allCountElement = document.getElementById('allTeamCount');
                if (allCountElement) {
                    allCountElement.textContent = referralDatabase.length + '건';
                }
                
                teams.forEach((team, index) => {
                    const count = referralDatabase.filter(item => item.team === team).length;
                    const element = document.getElementById('team' + (index + 1) + 'Count');
                    if (element) {
                        element.textContent = count + '건';
                    }
                });
                
                debugAddLog('팀별 카운트 업데이트 완료', 'info');
            } catch (error) {
                debugAddLog('팀별 카운트 업데이트 오류: ' + error.message, 'error');
            }
        }

        // 새 의뢰 모달 관련 함수들
        function openNewReferralModal() {
            try {
                debugAddLog('새 의뢰 모달 열기', 'info');
                const modal = document.getElementById('newReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    
                    // 의뢰날짜를 오늘 날짜로 기본 설정
                    const today = new Date().toISOString().slice(0, 10);
                    const dateField = document.getElementById('referralDate');
                    if (dateField) {
                        dateField.value = today;
                    }
                }
            } catch (error) {
                debugAddLog('새 의뢰 모달 열기 오류: ' + error.message, 'error');
            }
        }

        function closeNewReferralModal() {
            try {
                debugAddLog('새 의뢰 모달 닫기', 'info');
                const modal = document.getElementById('newReferralModal');
                const form = document.getElementById('newReferralForm');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
            } catch (error) {
                debugAddLog('새 의뢰 모달 닫기 오류: ' + error.message, 'error');
            }
        }

        // 의뢰 폼 데이터 수집 함수
        function collectReferralFormData() {
            try {
                const formData = {
                    refNo: 'R' + String(referralDatabase.length + 1).padStart(4, '0'),
                    name: (document.getElementById('referrerName').value || '').trim() + '**',
                    gender: document.getElementById('referrerGender').value,
                    age: parseInt(document.getElementById('referrerAge').value) || 0,
                    referralDate: document.getElementById('referralDate').value,
                    referralPath: (document.getElementById('referralPath').value || '').trim() || '-',
                    agency: document.getElementById('referringAgency').value,
                    team: document.getElementById('assignedTeam').value,
                    region: (document.getElementById('region').value || '').trim() || '-',
                    counselor: (document.getElementById('assignedCounselor').value || '').trim() || '담당자 배정 중',
                    diagnosis: (document.getElementById('diagnosis').value || '').trim() || '진단 대기',
                    interventionContent: (document.getElementById('interventionContent').value || '').trim(),
                    actionResult: document.getElementById('actionResult').value || '처리중',
                    closureStatus: '진행중', // 기본값
                    diagnosisProtection: document.getElementById('diagnosisProtectionRequest').checked,
                    writtenReferral: document.getElementById('writtenReferral').checked,
                    phoneReferral: document.getElementById('phoneReferral').checked,
                    policeInvolvement: document.getElementById('policeInvolvement').checked,
                    responseRequired: (document.getElementById('responseRequired').value || '').trim() || '-',
                    criInfo: (document.getElementById('criInfo').value || '').trim() || '-'
                };

                // 기본 유효성 검사
                if (!formData.name || formData.name === '**') {
                    throw new Error('이름을 입력해주세요.');
                }
                if (!formData.gender) {
                    throw new Error('성별을 선택해주세요.');
                }
                if (!formData.age || formData.age <= 0) {
                    throw new Error('올바른 나이를 입력해주세요.');
                }
                if (!formData.referralDate) {
                    throw new Error('의뢰날짜를 선택해주세요.');
                }
                if (!formData.agency) {
                    throw new Error('의뢰기관을 선택해주세요.');
                }
                if (!formData.team) {
                    throw new Error('담당팀을 선택해주세요.');
                }
                if (!formData.interventionContent) {
                    throw new Error('개입내용/현상황을 입력해주세요.');
                }

                return formData;
            } catch (error) {
                throw error;
            }
        }

        // 임시저장 함수
        function saveDraftReferral() {
            try {
                debugAddLog('임시저장 시작', 'info');
                const formData = collectReferralFormData();
                formData.closureStatus = '조치 결과 등록제외'; // 임시저장 상태
                formData.actionResult = '처리중';
                
                referralDatabase.push(formData);
                updateReferralsTable();
                updateTeamCounts();
                closeNewReferralModal();
                
                showNotification(`의뢰가 임시저장되었습니다! (의뢰번호: ${formData.refNo})`, 'warning');
                debugAddLog('임시저장 완료: ' + formData.refNo, 'info');
                
                // 통계 및 차트 업데이트
                updateDataStats();
                if (currentActivePage === 'reports') {
                    setTimeout(() => createCharts(), 100);
                }
                
                addLog('💾 임시저장: ' + formData.refNo, 'info');
            } catch (error) {
                debugAddLog('임시저장 오류: ' + error.message, 'error');
                showNotification('임시저장 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // 🔧 의뢰 상세보기 - 디버깅 강화
        function viewReferralDetail(refNo) {
            try {
                debugAddLog('의뢰 상세보기 시작: ' + refNo, 'info');
                const referral = referralDatabase.find(item => item.refNo === refNo);
                if (!referral) {
                    debugAddLog('의뢰를 찾을 수 없음: ' + refNo, 'error');
                    showNotification('의뢰를 찾을 수 없습니다.', 'error');
                    return;
                }
                
                viewingReferralData = referral; // 🔧 중요: 전역 변수에 저장
                debugAddLog('viewingReferralData 설정 완료: ' + referral.refNo, 'info');
                
                const detailContent = document.getElementById('referralDetailContent');
                if (detailContent) {
                    detailContent.innerHTML = generateReferralDetailHTML(referral);
                }
                
                const modal = document.getElementById('referralDetailModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    debugAddLog('상세보기 모달 표시 완료', 'info');
                }
                
                addLog('👀 의뢰 상세보기 열림: ' + refNo, 'info');
            } catch (error) {
                debugAddLog('의뢰 상세보기 오류: ' + error.message, 'error');
                showNotification('의뢰 상세보기 중 오류가 발생했습니다.', 'error');
            }
        }

        // 의뢰 상세보기 HTML 생성
        function generateReferralDetailHTML(referral) {
            const actionResultColor = getActionResultColor(referral.actionResult);
            const closureStatusColor = getClosureStatusColor(referral.closureStatus);
            
            return `
                <div style="grid-column: 1 / -1; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">👤 기본 정보</h4>
                </div>
                <div class="form-group">
                    <label><strong>의뢰번호</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 600;">${referral.refNo}</div>
                </div>
                <div class="form-group">
                    <label><strong>이름</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.name}</div>
                </div>
                <div class="form-group">
                    <label><strong>성별</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.gender}</div>
                </div>
                <div class="form-group">
                    <label><strong>나이</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.age}세</div>
                </div>
                <div class="form-group">
                    <label><strong>의뢰날짜</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.referralDate}</div>
                </div>
                <div class="form-group">
                    <label><strong>지역</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.region || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #fff7ed; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">📋 의뢰 정보</h4>
                </div>
                <div class="form-group">
                    <label><strong>의뢰경로</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.referralPath || '-'}</div>
                </div>
                <div class="form-group">
                    <label><strong>의뢰기관</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.agency}</div>
                </div>
                <div class="form-group">
                    <label><strong>담당팀</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 600; color: #059669;">${referral.team}</div>
                </div>
                <div class="form-group">
                    <label><strong>담당자</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.counselor}</div>
                </div>
                <div class="form-group">
                    <label><strong>CRI</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.criInfo || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">📋 의뢰 유형</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>진단 보호요청:</strong> ${referral.diagnosisProtection ? '✅' : '❌'}</div>
                        <div><strong>서면의뢰:</strong> ${referral.writtenReferral ? '✅' : '❌'}</div>
                        <div><strong>유선의뢰:</strong> ${referral.phoneReferral ? '✅' : '❌'}</div>
                        <div><strong>경찰개입여부:</strong> ${referral.policeInvolvement ? '✅' : '❌'}</div>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">🏥 진단 및 조치 정보</h4>
                </div>
                <div class="form-group">
                    <label><strong>진단명</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.diagnosis}</div>
                </div>
                <div class="form-group">
                    <label><strong>조치결과</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span class="status-badge" style="background: ${actionResultColor};">${referral.actionResult || '-'}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>종결여부</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span class="status-badge" style="background: ${closureStatusColor};">${referral.closureStatus}</span>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">📝 개입내용/현상황</h4>
                    <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 6px; white-space: pre-wrap;">${referral.interventionContent || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f0f4f8; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">📬 회신 정보</h4>
                    <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 6px; white-space: pre-wrap;">
                        ${typeof referral.responseRequired === 'boolean' ? 
                            (referral.responseRequired ? '회신 필요' : '회신 불필요') : 
                            (referral.responseRequired || '-')
                        }
                    </div>
                </div>
            `;
        }

        // 조치결과별 색상 반환
        function getActionResultColor(actionResult) {
            const colors = {
                '등록관리(기등록포함)': '#3b82f6',
                '지속상담': '#059669',
                '치료연계': '#d97706',
                '서비스 연계': '#7c3aed',
                '기타조치': '#6b7280',
                '정보제공': '#0891b2',
                '종결': '#059669',
                '처리중': '#f59e0b'
            };
            return colors[actionResult] || '#6b7280';
        }

        // 종결여부별 색상 반환
        function getClosureStatusColor(closureStatus) {
            const colors = {
                '진행중': '#d97706',
                '종결': '#059669',
                '조치 결과 등록제외': '#6b7280',
                '미등록자 종결': '#ef4444'
            };
            return colors[closureStatus] || '#6b7280';
        }

        // 🔧 현재 의뢰 수정 - 디버깅 강화 및 오류 수정
        function editCurrentReferral() {
            debugAddLog('=== editCurrentReferral 호출됨 ===', 'info');
            debugAddLog('현재 viewingReferralData: ' + (viewingReferralData ? viewingReferralData.refNo : 'null'), 'info');
            
            try {
                if (!viewingReferralData) {
                    debugAddLog('viewingReferralData가 null', 'error');
                    showNotification('수정할 의뢰 데이터를 찾을 수 없습니다.', 'error');
                    return;
                }
                
                debugAddLog('상세보기 데이터 확인됨: ' + viewingReferralData.refNo, 'info');
                
                // 🔧 중요: 데이터를 백업한 후 모달 닫기
                const backupReferralData = viewingReferralData;
                debugAddLog('의뢰 데이터 백업 완료: ' + backupReferralData.refNo, 'info');
                
                // 상세보기 모달 닫기
                closeReferralDetailModal();
                
                // 수정 모달 열기 (백업된 데이터 사용)
                debugAddLog('수정 모달로 전환...', 'info');
                editReferral(backupReferralData.refNo);
                
            } catch (error) {
                debugAddLog('editCurrentReferral 오류: ' + error.message, 'error');
                showNotification('수정 모드 전환 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // 🔧 의뢰 수정 기능 - 완전히 새로 작성
        function editReferral(refNo) {
            debugAddLog('=== 의뢰 수정 시작 ===', 'info');
            debugAddLog('수정 요청 의뢰번호: ' + refNo, 'info');
            
            try {
                // 1. 의뢰 찾기
                const referral = referralDatabase.find(item => item.refNo === refNo);
                debugAddLog('찾은 의뢰 데이터: ' + (referral ? referral.refNo : 'null'), 'info');
                
                if (!referral) {
                    debugAddLog('의뢰를 찾을 수 없음', 'error');
                    showNotification('의뢰를 찾을 수 없습니다.', 'error');
                    return;
                }
                
                // 2. 전역 변수에 저장
                editingReferralData = referral;
                debugAddLog('editingReferralData 설정: ' + editingReferralData.refNo, 'info');
                
                // 3. 폼 필드에 데이터 채우기
                debugAddLog('폼 필드 채우기 시작...', 'info');
                
                const fields = {
                    'editRefNo': referral.refNo,
                    'editReferrerName': referral.name.replace('**', ''),
                    'editReferrerGender': referral.gender,
                    'editReferrerAge': referral.age,
                    'editReferralDate': referral.referralDate,
                    'editReferralPath': referral.referralPath || '',
                    'editReferringAgency': referral.agency,
                    'editAssignedTeam': referral.team,
                    'editCounselor': referral.counselor,
                    'editDiagnosis': referral.diagnosis,
                    'editActionResult': referral.actionResult || '처리중',
                    'editClosureStatus': referral.closureStatus,
                    'editRegion': referral.region || '',
                    'editCriInfo': referral.criInfo || '',
                    'editInterventionContent': referral.interventionContent || '',
                    'editResponseRequired': typeof referral.responseRequired === 'boolean' ? 
                        (referral.responseRequired ? '회신 필요' : '') : 
                        (referral.responseRequired || '')
                };
                
                // 각 필드별로 설정하고 확인
                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                        debugAddLog(`✅ ${fieldId}: "${value}"`, 'info');
                    } else {
                        debugAddLog(`❌ 필드 없음: ${fieldId}`, 'error');
                    }
                }
                
                // 4. 모달 열기
                const modal = document.getElementById('editReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    debugAddLog('수정 모달 열림', 'info');
                    addLog('📝 의뢰 수정 모달 열림: ' + refNo, 'info');
                } else {
                    debugAddLog('수정 모달을 찾을 수 없음', 'error');
                }
                
                debugAddLog('=== 의뢰 수정 준비 완료 ===', 'info');
                
            } catch (error) {
                debugAddLog('의뢰 수정 오류: ' + error.message, 'error');
                addLog('❌ 의뢰 수정 오류: ' + error.message, 'error');
                showNotification('의뢰 수정 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }
        
        // 🔧 저장 버튼 핸들러 - 직접 호출용
        function handleSaveEditedReferral() {
            debugAddLog('=== 저장 버튼 직접 호출됨 ===', 'info');
            
            try {
                // 폼 검증 및 저장 실행
                const success = saveEditedReferral();
                
                if (success) {
                    debugAddLog('저장 성공', 'info');
                } else {
                    debugAddLog('저장 실패', 'error');
                }
            } catch (error) {
                debugAddLog('저장 핸들러 오류: ' + error.message, 'error');
                showNotification('저장 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // 🔧 의뢰 수정 저장 함수 - 완전히 새로 작성
        function saveEditedReferral() {
            debugAddLog('=== 의뢰 수정 저장 시작 ===', 'info');
            debugAddLog('editingReferralData: ' + (editingReferralData ? editingReferralData.refNo : 'null'), 'info');
            
            try {
                // 1. 수정할 데이터 확인
                if (!editingReferralData) {
                    debugAddLog('editingReferralData가 없음', 'error');
                    showNotification('수정할 의뢰 데이터를 찾을 수 없습니다.', 'error');
                    return false;
                }
                
                // 2. 데이터베이스에서 해당 의뢰 찾기
                const index = referralDatabase.findIndex(item => item.refNo === editingReferralData.refNo);
                debugAddLog('데이터베이스 인덱스: ' + index, 'info');
                
                if (index === -1) {
                    debugAddLog('데이터베이스에서 의뢰를 찾을 수 없음', 'error');
                    showNotification('데이터베이스에서 의뢰를 찾을 수 없습니다.', 'error');
                    return false;
                }
                
                // 3. 폼에서 수정된 데이터 수집
                debugAddLog('폼 데이터 수집 중...', 'info');
                
                // 🔧 안전한 폼 요소 접근 함수
                function safeGetElementValue(id, defaultValue = '') {
                    const element = document.getElementById(id);
                    if (!element) {
                        debugAddLog(`폼 요소 '${id}'를 찾을 수 없음`, 'error');
                        return defaultValue;
                    }
                    return element.value || defaultValue;
                }
                
                const updatedData = {
                    ...referralDatabase[index], // 기존 모든 데이터 보존
                    // 수정 가능한 필드들
                    name: (safeGetElementValue('editReferrerName').trim() || '무명') + '**',
                    gender: safeGetElementValue('editReferrerGender', '미상'),
                    age: parseInt(safeGetElementValue('editReferrerAge', '0')) || 0,
                    referralDate: safeGetElementValue('editReferralDate'),
                    referralPath: safeGetElementValue('editReferralPath').trim() || '-',
                    agency: safeGetElementValue('editReferringAgency', '미상'),
                    team: safeGetElementValue('editAssignedTeam', '미배정'),
                    counselor: safeGetElementValue('editCounselor').trim() || '담당자 배정 중',
                    diagnosis: safeGetElementValue('editDiagnosis').trim() || '진단 대기',
                    actionResult: safeGetElementValue('editActionResult', '처리중'),
                    closureStatus: safeGetElementValue('editClosureStatus', '진행중'),
                    region: safeGetElementValue('editRegion').trim() || '-',
                    criInfo: safeGetElementValue('editCriInfo').trim() || '-',
                    interventionContent: safeGetElementValue('editInterventionContent').trim(),
                    responseRequired: safeGetElementValue('editResponseRequired').trim() || '-'
                };
                
                debugAddLog('수집된 업데이트 데이터: ' + updatedData.name, 'info');
                
                // 4. 필수 필드 검증
                debugAddLog('필수 필드 검증 중...', 'info');
                if (!updatedData.name || updatedData.name === '**' || updatedData.name === '무명**') {
                    debugAddLog('이름 필드 검증 실패', 'error');
                    showNotification('이름을 입력해주세요.', 'error');
                    return false;
                }
                if (!updatedData.interventionContent || updatedData.interventionContent.trim() === '') {
                    debugAddLog('개입내용 필드 검증 실패', 'error');
                    showNotification('개입내용/현상황을 입력해주세요.', 'error');
                    return false;
                }
                if (!updatedData.referralDate) {
                    debugAddLog('의뢰날짜 필드 검증 실패', 'error');
                    showNotification('의뢰날짜를 선택해주세요.', 'error');
                    return false;
                }
                debugAddLog('필수 필드 검증 통과', 'info');
                
                // 5. 데이터베이스 업데이트
                debugAddLog('데이터베이스 업데이트 중...', 'info');
                referralDatabase[index] = updatedData;
                debugAddLog('데이터베이스 업데이트 완료', 'info');
                
                // 6. UI 업데이트
                debugAddLog('UI 업데이트 중...', 'info');
                updateReferralsTable();
                updateTeamCounts();
                updateDataStats();
                
                if (currentActivePage === 'reports') {
                    setTimeout(() => createCharts(), 100);
                }
                
                // 7. 모달 닫기
                closeEditReferralModal();
                
                // 8. 성공 알림
                showNotification(`✅ 의뢰가 성공적으로 수정되었습니다!\n의뢰번호: ${updatedData.refNo}`, 'success');
                addLog('✅ 의뢰 수정 완료: ' + updatedData.refNo, 'success');
                debugAddLog('의뢰 수정 저장 성공', 'info');
                
                debugAddLog('=== 의뢰 수정 저장 완료 ===', 'info');
                return true;
                
            } catch (error) {
                debugAddLog('수정 저장 오류: ' + error.message, 'error');
                addLog('❌ 수정 저장 실패: ' + error.message, 'error');
                showNotification('수정 저장 중 오류가 발생했습니다: ' + error.message, 'error');
                return false;
            }
        }

        // 모달 닫기 함수들
        function closeReferralDetailModal() {
            try {
                debugAddLog('상세보기 모달 닫기', 'info');
                const modal = document.getElementById('referralDetailModal');
                if (modal) modal.classList.add('hidden');
                
                viewingReferralData = null;
                debugAddLog('상세보기 데이터 초기화 완료', 'info');
            } catch (error) {
                debugAddLog('상세보기 모달 닫기 오류: ' + error.message, 'error');
            }
        }

        function closeEditReferralModal() {
            try {
                debugAddLog('수정 모달 닫기', 'info');
                const modal = document.getElementById('editReferralModal');
                const form = document.getElementById('editReferralForm');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
                
                editingReferralData = null;
                debugAddLog('수정 데이터 초기화 완료', 'info');
            } catch (error) {
                debugAddLog('수정 모달 닫기 오류: ' + error.message, 'error');
            }
        }

        // 📊 엑셀 다운로드 함수
        function downloadExcel() {
            try {
                addLog('📈 엑셀 파일 생성 중...', 'info');
                debugAddLog('엑셀 다운로드 시작', 'info');
                
                // 워크북 생성
                const wb = XLSX.utils.book_new();
                
                // 의뢰 데이터 시트
                const wsData = referralDatabase.map(item => ({
                    '의뢰번호': item.refNo,
                    '이름': item.name,
                    '성별': item.gender,
                    '나이': item.age,
                    '의뢰날짜': item.referralDate,
                    '의뢰경로': item.referralPath || '-',
                    '의뢰기관': item.agency,
                    '담당팀': item.team,
                    '지역': item.region || '-',
                    '담당자': item.counselor,
                    '진단명': item.diagnosis,
                    '조치결과': item.actionResult || '-',
                    '종결여부': item.closureStatus,
                    '진단보호요청': item.diagnosisProtection ? 'O' : 'X',
                    '서면의뢰': item.writtenReferral ? 'O' : 'X',
                    '유선의뢰': item.phoneReferral ? 'O' : 'X',
                    '경찰개입': item.policeInvolvement ? 'O' : 'X',
                    'CRI': item.criInfo || '-',
                    '회신요청': item.responseRequired || '-',
                    '개입내용': item.interventionContent || '-'
                }));
                
                const ws1 = XLSX.utils.json_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws1, "의뢰목록");
                
                // 통계 시트
                const stats = generateStatistics();
                const statsData = [
                    ['구분', '항목', '건수', '비율'],
                    ['전체', '총 의뢰', stats.total, '100%'],
                    ['성별', '남성', stats.gender.male, Math.round(stats.gender.male/stats.total*100) + '%'],
                    ['성별', '여성', stats.gender.female, Math.round(stats.gender.female/stats.total*100) + '%'],
                    ['상태', '진행중', stats.status.progressing, Math.round(stats.status.progressing/stats.total*100) + '%'],
                    ['상태', '종결', stats.status.completed, Math.round(stats.status.completed/stats.total*100) + '%'],
                    ['연령', '평균연령', Math.round(stats.avgAge) + '세', '-']
                ];
                
                Object.entries(stats.teams).forEach(([team, count]) => {
                    statsData.push(['팀별', team, count, Math.round(count/stats.total*100) + '%']);
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, ws2, "통계");
                
                // 파일 다운로드
                const fileName = `정신건강센터_의뢰데이터_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                addLog('✅ 엑셀 다운로드 완료: ' + fileName, 'success');
                debugAddLog('엑셀 다운로드 성공', 'info');
                showNotification('엑셀 파일이 다운로드되었습니다!', 'success');
            } catch (error) {
                debugAddLog('엑셀 다운로드 오류: ' + error.message, 'error');
                addLog('❌ 엑셀 다운로드 실패: ' + error.message, 'error');
                showNotification('엑셀 다운로드 중 오류가 발생했습니다.', 'error');
            }
        }

        // 💾 JSON 백업 함수
        function downloadJSON() {
            try {
                addLog('💾 JSON 백업 파일 생성 중...', 'info');
                debugAddLog('JSON 백업 시작', 'info');
                
                const backupData = {
                    systemInfo: {
                        name: '정신건강복지센터 데이터 관리 시스템',
                        version: 'v2.1',
                        backupDate: new Date().toISOString(),
                        totalRecords: referralDatabase.length
                    },
                    statistics: generateStatistics(),
                    referralData: referralDatabase
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json; charset=utf-8'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `정신건강센터_백업_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                addLog('✅ JSON 백업 완료: ' + link.download, 'success');
                debugAddLog('JSON 백업 성공', 'info');
                showNotification('백업 파일이 다운로드되었습니다!', 'success');
            } catch (error) {
                debugAddLog('JSON 백업 오류: ' + error.message, 'error');
                addLog('❌ JSON 백업 실패: ' + error.message, 'error');
                showNotification('백업 중 오류가 발생했습니다.', 'error');
            }
        }

        // 📄 CSV 다운로드 함수
        function downloadCSV() {
            try {
                addLog('📄 CSV 파일 생성 중...', 'info');
                debugAddLog('CSV 다운로드 시작', 'info');
                
                const headers = [
                    '의뢰번호', '이름', '성별', '나이', '의뢰날짜', '의뢰기관', '담당팀', 
                    '지역', '담당자', '진단명', '조치결과', '종결여부', '개입내용'
                ];
                
                const csvData = [
                    headers,
                    ...referralDatabase.map(item => [
                        item.refNo,
                        item.name,
                        item.gender,
                        item.age,
                        item.referralDate,
                        item.agency,
                        item.team,
                        item.region || '-',
                        item.counselor,
                        item.diagnosis,
                        item.actionResult || '-',
                        item.closureStatus,
                        item.interventionContent?.replace(/\n/g, ' ').substring(0, 100) || '-'
                    ])
                ];
                
                const csvContent = csvData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                const BOM = '\uFEFF'; // UTF-8 BOM for Korean support
                const blob = new Blob([BOM + csvContent], {type: 'text/csv; charset=utf-8'});
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `정신건강센터_의뢰데이터_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                addLog('✅ CSV 다운로드 완료: ' + link.download, 'success');
                debugAddLog('CSV 다운로드 성공', 'info');
                showNotification('CSV 파일이 다운로드되었습니다!', 'success');
            } catch (error) {
                debugAddLog('CSV 다운로드 오류: ' + error.message, 'error');
                addLog('❌ CSV 다운로드 실패: ' + error.message, 'error');
                showNotification('CSV 다운로드 중 오류가 발생했습니다.', 'error');
            }
        }

        // 📈 통계 데이터 생성 함수
        function generateStatistics() {
            const stats = {
                total: referralDatabase.length,
                gender: { male: 0, female: 0 },
                age: { total: 0, count: 0 },
                teams: {},
                regions: {},
                counselors: {},
                actions: {},
                status: { progressing: 0, completed: 0 }
            };

            referralDatabase.forEach(item => {
                // 성별 통계
                if (item.gender === '남성') stats.gender.male++;
                else if (item.gender === '여성') stats.gender.female++;

                // 나이 통계
                if (item.age > 0) {
                    stats.age.total += item.age;
                    stats.age.count++;
                }

                // 팀별 통계
                stats.teams[item.team] = (stats.teams[item.team] || 0) + 1;

                // 지역별 통계
                const region = item.region || '미지정';
                stats.regions[region] = (stats.regions[region] || 0) + 1;

                // 담당자별 통계
                stats.counselors[item.counselor] = (stats.counselors[item.counselor] || 0) + 1;

                // 조치결과별 통계
                const action = item.actionResult || '미지정';
                stats.actions[action] = (stats.actions[action] || 0) + 1;

                // 종결상태별 통계
                if (item.closureStatus === '종결') stats.status.completed++;
                else stats.status.progressing++;
            });

            stats.avgAge = stats.age.count > 0 ? stats.age.total / stats.age.count : 0;

            return stats;
        }

        // 📊 차트 생성 함수들
        function createCharts() {
            debugAddLog('차트 생성 시작', 'info');
            const stats = generateStatistics();
            
            // 성별 분포 차트
            createGenderChart(stats);
            
            // 연령별 분포 차트
            createAgeChart();
            
            // 팀별 분포 차트
            createTeamChart(stats);
            
            // 지역별 분포 차트
            createRegionChart(stats);
            
            // 담당자별 분포 차트
            createCounselorChart(stats);
            
            // 조치결과별 분포 차트
            createActionChart(stats);
            
            // 월별 추이 차트
            createMonthlyChart();
            
            // 종합 통계 업데이트
            updateSummaryStats(stats);
            
            debugAddLog('차트 생성 완료', 'info');
        }

        function createGenderChart(stats) {
            const ctx = document.getElementById('genderChart').getContext('2d');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['남성', '여성'],
                    datasets: [{
                        data: [stats.gender.male, stats.gender.female],
                        backgroundColor: ['#3b82f6', '#ec4899'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = stats.total;
                                    const value = context.parsed;
                                    const percentage = Math.round(value / total * 100);
                                    return `${context.label}: ${value}명 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAgeChart() {
            const ctx = document.getElementById('ageChart').getContext('2d');
            if (charts.age) charts.age.destroy();
            
            // 연령대별 그룹핑
            const ageGroups = { '10대': 0, '20대': 0, '30대': 0, '40대': 0, '50대': 0, '60대 이상': 0 };
            
            referralDatabase.forEach(item => {
                const age = item.age;
                if (age < 20) ageGroups['10대']++;
                else if (age < 30) ageGroups['20대']++;
                else if (age < 40) ageGroups['30대']++;
                else if (age < 50) ageGroups['40대']++;
                else if (age < 60) ageGroups['50대']++;
                else ageGroups['60대 이상']++;
            });
            
            charts.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        label: '연령별 의뢰 건수',
                        data: Object.values(ageGroups),
                        backgroundColor: '#059669',
                        borderColor: '#047857',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createTeamChart(stats) {
            const ctx = document.getElementById('teamChart').getContext('2d');
            if (charts.team) charts.team.destroy();
            
            const colors = ['#3b82f6', '#059669', '#dc2626', '#d97706', '#7c3aed'];
            
            charts.team = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.teams),
                    datasets: [{
                        data: Object.values(stats.teams),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createRegionChart(stats) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            if (charts.region) charts.region.destroy();
            
            charts.region = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.regions),
                    datasets: [{
                        label: '지역별 의뢰 건수',
                        data: Object.values(stats.regions),
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createCounselorChart(stats) {
            const ctx = document.getElementById('counselorChart').getContext('2d');
            if (charts.counselor) charts.counselor.destroy();
            
            charts.counselor = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.counselors),
                    datasets: [{
                        label: '담당자별 의뢰 건수',
                        data: Object.values(stats.counselors),
                        backgroundColor: '#7c3aed',
                        borderColor: '#6d28d9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createActionChart(stats) {
            const ctx = document.getElementById('actionChart').getContext('2d');
            if (charts.action) charts.action.destroy();
            
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            charts.action = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.actions),
                    datasets: [{
                        data: Object.values(stats.actions),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            
            // 월별 데이터 생성
            const monthlyData = {};
            referralDatabase.forEach(item => {
                const month = item.referralDate.slice(0, 7); // YYYY-MM 형식
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            
            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '월별 의뢰 건수',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateSummaryStats(stats) {
            document.getElementById('summaryTotal').textContent = stats.total;
            document.getElementById('summaryMale').textContent = Math.round(stats.gender.male / stats.total * 100) + '%';
            document.getElementById('summaryFemale').textContent = Math.round(stats.gender.female / stats.total * 100) + '%';
            document.getElementById('summaryCompleted').textContent = Math.round(stats.status.completed / stats.total * 100) + '%';
        }

        // 데이터 관리 페이지 통계 업데이트
        function updateDataStats() {
            try {
                const stats = generateStatistics();
                
                document.getElementById('totalReferrals').textContent = stats.total;
                document.getElementById('completedReferrals').textContent = stats.status.completed;
                document.getElementById('progressingReferrals').textContent = stats.status.progressing;
                document.getElementById('avgAge').textContent = Math.round(stats.avgAge) + '세';
                
                debugAddLog('데이터 통계 업데이트 완료', 'info');
            } catch (error) {
                debugAddLog('데이터 통계 업데이트 오류: ' + error.message, 'error');
            }
        }

        // 로그 추가 함수
        function addLog(message, type = 'info') {
            try {
                const logContainer = document.getElementById('activityLog');
                if (!logContainer) return;
                
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '8px';
                logEntry.style.padding = '4px 8px';
                logEntry.style.borderLeft = '3px solid #374151';
                logEntry.style.borderRadius = '4px';
                
                const typeColors = {
                    'success': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                    'error': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                    'warning': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                    'info': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' }
                };
                
                const colors = typeColors[type] || typeColors.info;
                logEntry.style.borderLeftColor = colors.border;
                logEntry.style.background = colors.bg;
                
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // 로그 개수 제한
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            } catch (error) {
                debugAddLog('로그 추가 오류: ' + error.message, 'error');
            }
        }

        // 이벤트 리스너 설정 및 초기화
        document.addEventListener('DOMContentLoaded', function() {
            try {
                debugAddLog('DOM 로드 완료 - 시스템 초기화 시작', 'info');
                
                // 시간 업데이트 시작
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // 새 의뢰 폼 이벤트
                const newReferralForm = document.getElementById('newReferralForm');
                if (newReferralForm) {
                    newReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        debugAddLog('새 의뢰 폼 제출 이벤트', 'info');
                        
                        try {
                            const newReferral = collectReferralFormData();
                            newReferral.closureStatus = '진행중';
                            
                            referralDatabase.push(newReferral);
                            updateReferralsTable();
                            updateTeamCounts();
                            closeNewReferralModal();
                            
                            showNotification(`새 의뢰가 성공적으로 접수되었습니다! (의뢰번호: ${newReferral.refNo})`, 'success');
                            debugAddLog('새 의뢰 접수 성공: ' + newReferral.refNo, 'info');
                            
                            // 통계 및 차트 업데이트
                            updateDataStats();
                            if (currentActivePage === 'reports') {
                                setTimeout(() => createCharts(), 100);
                            }
                            
                            addLog('📊 새 의뢰 접수: ' + newReferral.refNo, 'success');
                        } catch (error) {
                            debugAddLog('새 의뢰 접수 오류: ' + error.message, 'error');
                            showNotification('새 의뢰 접수 중 오류가 발생했습니다: ' + error.message, 'error');
                        }
                    });
                    debugAddLog('새 의뢰 폼 이벤트 리스너 등록 완료', 'info');
                }
                
                // 🔧 의뢰 수정 폼 이벤트 - 디버깅 강화 및 이중 보안
                const editReferralForm = document.getElementById('editReferralForm');
                if (editReferralForm) {
                    debugAddLog('수정 폼 이벤트 리스너 등록', 'info');
                    
                    // 방법 1: 폼 제출 이벤트
                    editReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        debugAddLog('수정 폼 제출 이벤트 발생 (방법 1)', 'info');
                        handleSaveEditedReferral();
                    });
                    
                    debugAddLog('수정 폼 이벤트 리스너 등록 완료', 'info');
                } else {
                    debugAddLog('editReferralForm을 찾을 수 없음 - 나중에 다시 시도', 'info');
                }

                // 🔧 방법 2: 버튼 직접 이벤트 (백업용)
                setTimeout(() => {
                    const saveBtn = document.getElementById('saveEditedReferralBtn');
                    if (saveBtn && !saveBtn.hasAttribute('onclick-backup')) {
                        saveBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            debugAddLog('저장 버튼 클릭 이벤트 (방법 2)', 'info');
                            handleSaveEditedReferral();
                        });
                        saveBtn.setAttribute('onclick-backup', 'true');
                        debugAddLog('저장 버튼 백업 이벤트 리스너 등록 완료', 'info');
                    }
                }, 2000);
                
                
                // 엔터키로 로그인
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        const loginScreen = document.getElementById('loginScreen');
                        if (loginScreen && !loginScreen.classList.contains('hidden')) {
                            const activeElement = document.activeElement;
                            if (activeElement && (activeElement.id === 'username' || activeElement.id === 'password')) {
                                handleLogin();
                            }
                        }
                    }
                });
                
                // 모달 외부 클릭 시 닫기
                const modals = [
                    'newReferralModal',
                    'referralDetailModal', 
                    'editReferralModal'
                ];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.addEventListener('click', function(e) {
                            if (e.target === this) {
                                const closeFunction = {
                                    'newReferralModal': closeNewReferralModal,
                                    'referralDetailModal': closeReferralDetailModal,
                                    'editReferralModal': closeEditReferralModal
                                }[modalId];
                                
                                if (closeFunction) {
                                    closeFunction();
                                }
                            }
                        });
                    }
                });
                
                // ESC 키로 모달 닫기
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        const visibleModal = document.querySelector('.modal:not(.hidden)');
                        if (visibleModal) {
                            const modalId = visibleModal.id;
                            const closeFunction = {
                                'newReferralModal': closeNewReferralModal,
                                'referralDetailModal': closeReferralDetailModal,
                                'editReferralModal': closeEditReferralModal
                            }[modalId];
                            
                            if (closeFunction) {
                                closeFunction();
                            }
                        }
                    }
                });
                
                debugAddLog('정신건강복지센터 데이터 관리 시스템 v2.1 완전 구현 완료!', 'info');
                debugAddLog('📊 데이터 내보내기: Excel, CSV, JSON 지원', 'info');
                debugAddLog('📈 실시간 통계 차트: 성별, 연령, 팀별, 지역별, 담당자별 분석', 'info');
                debugAddLog('💾 로컬 데이터 관리: 백업 및 복원 기능', 'info');
                debugAddLog('🎯 완전한 오프라인 시스템 - 클라우드 의존성 제거', 'info');
                debugAddLog('🔧 디버깅 시스템 활성화 - 실시간 모니터링', 'info');
                
                // 📝 전역 함수 등록 (onclick 접근용)
                window.debugSystemStatus = debugSystemStatus;
                window.handleSaveEditedReferral = handleSaveEditedReferral;
                window.editCurrentReferral = editCurrentReferral;
                window.viewReferralDetail = viewReferralDetail;
                window.editReferral = editReferral;
                window.selectTeam = selectTeam;
                window.openNewReferralModal = openNewReferralModal;
                window.closeNewReferralModal = closeNewReferralModal;
                window.closeReferralDetailModal = closeReferralDetailModal;
                window.closeEditReferralModal = closeEditReferralModal;
                window.saveDraftReferral = saveDraftReferral;
                window.handleLogin = handleLogin;
                window.handleLogout = handleLogout;
                window.showPage = showPage;
                window.downloadExcel = downloadExcel;
                window.downloadJSON = downloadJSON;
                window.downloadCSV = downloadCSV;
                window.toggleDebugPanel = toggleDebugPanel;
                window.clearDebugLog = clearDebugLog;
                
                debugAddLog('모든 전역 함수 등록 완료', 'info');
                debugAddLog('디버깅 함수 등록됨 - 브라우저 콘솔에서 debugSystemStatus() 실행 가능', 'info');
                
                // 📝 초기 시스템 상태 확인
                setTimeout(() => {
                    debugAddLog('=== 초기 시스템 상태 ===', 'info');
                    debugAddLog('의뢰 데이터 개수: ' + referralDatabase.length, 'info');
                    debugAddLog('현재 활성 페이지: ' + currentActivePage, 'info');
                    debugSystemStatus();
                }, 1000);
                
            } catch (error) {
                debugAddLog('시스템 초기화 오류: ' + error.message, 'error');
                showNotification('시스템 초기화 중 오류가 발생했습니다.', 'error');
            }
        });

        // 전역 오류 처리
        window.addEventListener('error', function(event) {
            debugAddLog('전역 오류 발생: ' + event.error.message, 'error');
            showNotification('시스템 오류가 발생했습니다. 페이지를 새로고침해주세요.', 'error');
        });

        // Promise 거부 오류 처리
        window.addEventListener('unhandledrejection', function(event) {
            debugAddLog('처리되지 않은 Promise 거부: ' + event.reason, 'error');
            showNotification('비동기 작업 중 오류가 발생했습니다.', 'error');
            event.preventDefault();
        });

    </script>
</body>
</html>