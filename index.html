<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° - OneDrive í†µí•© ì‹œìŠ¤í…œ v2.2</title>
    <!-- Chart.js & SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --nas-color: #1976d2;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-nas: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            font-size: 13px;
            z-index: 9999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--gradient-primary);
        }

        .login-container.hidden {
            display: none !important;
        }

        .login-box {
            background: var(--gradient-card);
            padding: 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 700;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .app-container {
            display: flex;
            height: 100vh;
            padding-top: 50px;
            background: var(--gradient-primary);
        }

        .app-container.hidden {
            display: none !important;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background: var(--gradient-card);
        }

        .sidebar-header h2 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .user-info {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-menu {
            padding: 24px 0;
        }

        .nav-item {
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: white !important;
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        .nav-link .icon {
            margin-right: 16px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            transition: color 0.3s ease;
        }

        .main-content {
            flex: 1;
            background: rgba(248, 250, 252, 0.8);
            overflow-y: auto;
            min-height: calc(100vh - 50px);
        }

        .page {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - 50px);
            display: block;
        }

        .page.hidden {
            display: none !important;
        }

        .dashboard-container {
            padding: 40px;
            min-height: calc(100vh - 130px);
            background: transparent;
        }

        .notification {
            position: fixed;
            bottom: 100px;
            right: 24px;
            background: white;
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            z-index: 10001;
            max-width: 450px;
            animation: slideInFromBottom 0.4s ease-out;
        }

        @keyframes slideInFromBottom {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .widget {
            background: var(--gradient-card);
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .widget-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .widget-icon {
            font-size: 28px;
            color: var(--primary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--gradient-card);
            padding: 32px 28px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1;
        }

        .stat-number.urgent {
            color: var(--danger-color);
        }

        .stat-number.normal {
            color: var(--primary-color);
        }

        .stat-number.completed {
            color: var(--success-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
        }

        .new-referral-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            white-space: nowrap;
            min-width: 140px;
        }

        .new-referral-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .team-tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .chart-data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .chart-item {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chart-item-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .chart-item-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .chart-item-percentage {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            margin-top: 24px;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }

        .table-container thead tr {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .table-container th {
            padding: 20px 12px;
            border-bottom: 3px solid #e5e7eb;
            text-align: left;
            font-weight: 800;
            color: #1f2937;
            font-size: 13px;
        }

        .table-container td {
            padding: 15px 12px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
        }

        .table-container tbody tr:hover {
            background: #f9fafb;
        }

        .action-btn {
            padding: 6px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .action-btn.view {
            background: #6b7280;
        }

        .action-btn.edit {
            background: #059669;
        }

        .action-btn.delete {
            background: #ef4444;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-badge.processing {
            background: #f59e0b;
        }

        .status-badge.completed {
            background: #059669;
        }

        .status-badge.urgent {
            background: #dc2626;
        }

        .status-badge.excluded {
            background: #6b7280;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-section {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 700;
        }

        .form-section.basic-info {
            background: #f8f9fa;
        }

        .form-section.referral-info {
            background: #fff7ed;
        }

        .form-section.referral-type {
            background: #f0f9ff;
        }

        .form-section.diagnosis-info {
            background: #fef3c7;
        }

        .form-section.content-info {
            background: #f3f4f6;
        }

        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10002;
            background: #1f2937;
            color: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 400px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid #374151;
        }

        .debug-panel.hidden {
            display: none;
        }

        .debug-panel h4 {
            color: #10b981;
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 700;
        }

        .debug-info {
            margin-bottom: 8px;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
            border-radius: 4px;
        }

        .debug-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10003;
            background: #374151;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .debug-toggle:hover {
            background: #4b5563;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .dashboard-container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .user-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .user-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
        }

        .user-table td {
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .user-table tbody tr:hover {
            background: #f9fafb;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-badge.admin {
            background: #dc2626;
            color: white;
        }

        .role-badge.manager {
            background: #059669;
            color: white;
        }

        .role-badge.user {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="notificationContainer" style="position: fixed; top: 80px; right: 24px; z-index: 10001;"></div>
    
    <!-- ìƒíƒœ ë°” -->
    <div class="status-bar">
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <span>ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ v2.2</span>
            <span style="margin-left: 16px; font-size: 11px; opacity: 0.8;">|</span>
            <span style="margin-left: 8px; font-size: 11px;">
                <span style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>ğŸ’¾</span>
                    <span>ë¡œì»¬ ì €ì¥ + ê°œì„ ëœ ë””ë²„ê¹…</span>
                </span>
            </span>
        </div>
        <div>
            <span>ì ‘ì†ì: <span id="onlineCount">1</span>ëª… | <span id="currentTime"></span></span>
        </div>
    </div>
    
    <!-- ë””ë²„ê·¸ í† ê¸€ ë²„íŠ¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
    <button class="debug-toggle hidden" id="debugToggleBtn" onclick="toggleDebugPanel()">ğŸ›  ë””ë²„ê·¸</button>
    
    <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
    <div class="debug-panel hidden" id="debugPanel">
        <h4>ğŸ”§ ì‹œìŠ¤í…œ ë””ë²„ê·¸ ì •ë³´</h4>
        <div id="debugContent">
            <div class="debug-info">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="debugSystemStatus()" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">ìƒíƒœ ì²´í¬</button>
            <button onclick="clearDebugLog()" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 4px;">ë¡œê·¸ í´ë¦¬ì–´</button>
        </div>
    </div>
    
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸ¥ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</h1>
                <p>ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ v2.2 (ë””ë²„ê¹… ê°œì„ )</p>
            </div>
            <div id="loginForm">
                <div id="loginErrors" style="display: none;"></div>
                <div class="form-group">
                    <label for="username">ì‚¬ìš©ì ID</label>
                    <input type="text" id="username" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password">
                </div>
                <button class="btn" id="loginBtn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                <div style="text-align: center; margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                    <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                        ğŸ”§ <strong>v2.2 ì—…ë°ì´íŠ¸</strong><br>
                        â€¢ ë¡œê·¸ì¸ ì˜¤ë¥˜ ìˆ˜ì •<br>
                        â€¢ ë””ë²„ê¹… ì‹œìŠ¤í…œ ê°œì„ <br>
                        â€¢ ê³„ì • ê´€ë¦¬ ì‹œìŠ¤í…œ ì¶”ê°€
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ìƒˆ ì˜ë¢° ëª¨ë‹¬ -->
    <div class="modal hidden" id="newReferralModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ¥ ìƒˆ ì˜ë¢° ì ‘ìˆ˜</h2>
                <button class="modal-close" onclick="closeNewReferralModal()">Ã—</button>
            </div>
            <div id="formErrors" style="display: none;"></div>
            <form id="newReferralForm">
                <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section basic-info">
                    <h3>ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì´ë¦„ *</label>
                            <input type="text" id="referrerName" required maxlength="50" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜">
                        </div>
                        <div class="form-group">
                            <label>ì„±ë³„ *</label>
                            <select id="referrerGender" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ì´ *</label>
                            <input type="number" id="referrerAge" required min="0" max="120" placeholder="ì˜ˆ: 35">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ë‚ ì§œ *</label>
                            <input type="date" id="referralDate" required>
                        </div>
                        <div class="form-group">
                            <label>ì§€ì—­</label>
                            <select id="region">
                                <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì´ì²œì‹œ ì¤‘ë¦¬ë™">ì¤‘ë¦¬ë™</option>
                                <option value="ì´ì²œì‹œ ì¦í¬ë™">ì¦í¬ë™</option>
                                <option value="ì´ì²œì‹œ ê´€ê³ ë™">ê´€ê³ ë™</option>
                                <option value="ì´ì²œì‹œ ì°½ì „ë™">ì°½ì „ë™</option>
                                <option value="ì´ì²œì‹œ ë¶€ë°œì">ë¶€ë°œì</option>
                                <option value="ì´ì²œì‹œ ë§ˆì¥ë©´">ë§ˆì¥ë©´</option>
                                <option value="ì´ì²œì‹œ ë°±ì‚¬ë©´">ë°±ì‚¬ë©´</option>
                                <option value="ì´ì²œì‹œ ì‹ ë‘”ë©´">ì‹ ë‘”ë©´</option>
                                <option value="ì´ì²œì‹œ í˜¸ë²•ë©´">í˜¸ë²•ë©´</option>
                                <option value="ì´ì²œì‹œ ì„¤ì„±ë©´">ì„¤ì„±ë©´</option>
                                <option value="ì´ì²œì‹œ ëŒ€ì›”ë©´">ëŒ€ì›”ë©´</option>
                                <option value="ì´ì²œì‹œ ìœ¨ë©´">ìœ¨ë©´</option>
                                <option value="ì´ì²œì‹œ ëª¨ê°€ë©´">ëª¨ê°€ë©´</option>
                                <option value="ì´ì²œì‹œ ì¥í˜¸ì›ì">ì¥í˜¸ì›ì</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹ì</label>
                            <input type="text" id="assignedCounselor" maxlength="50" placeholder="ë‹´ë‹¹ ìƒë‹´ì‚¬ëª…">
                        </div>
                    </div>
                </div>
                
                <!-- ì˜ë¢° ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section referral-info">
                    <h3>ğŸ“‹ ì˜ë¢° ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì˜ë¢°ê²½ë¡œ</label>
                            <input type="text" id="referralPath" maxlength="100" placeholder="ì˜ë¢° ê²½ë¡œ">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ê¸°ê´€ *</label>
                            <select id="referringAgency" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°">ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°</option>
                                <option value="ì´ì²œì‹œì²­">ì´ì²œì‹œì²­</option>
                                <option value="ê²½ì°°ì„œ">ê²½ì°°ì„œ</option>
                                <option value="ì†Œë°©">ì†Œë°©</option>
                                <option value="ì˜ë£Œê¸°ê´€">ì˜ë£Œê¸°ê´€</option>
                                <option value="ì •ì‹ ë³´ê±´ê¸°ê´€">ì •ì‹ ë³´ê±´ê¸°ê´€</option>
                                <option value="ë³´ê±´ì†Œ">ë³´ê±´ì†Œ</option>
                                <option value="ê°€ì¡±">ê°€ì¡±</option>
                                <option value="ì§€ì¸">ì§€ì¸</option>
                                <option value="ì§€ì—­ì‚¬íšŒ">ì§€ì—­ì‚¬íšŒ</option>
                                <option value="ë³µì§€ê´€">ë³µì§€ê´€</option>
                                <option value="í•™êµ">í•™êµ</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                <option value="1393/129">1393/129</option>
                                <option value="ë³¸ì¸">ë³¸ì¸</option>
                                <option value="ì´ë™ìƒë‹´">ì´ë™ìƒë‹´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹íŒ€ *</label>
                            <select id="assignedTeam" required onchange="handleTeamSelection()">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                                <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                                <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                                <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                            </select>
                        </div>
                        <div class="form-group" id="subTeamContainer" style="display: none;">
                            <label>ë‚¨ë¶€ë¶„ì†Œ ì„¸ë¶€íŒ€ *</label>
                            <select id="subTeam">
                                <option value="">ì„¸ë¶€íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="íšŒë³µ">íšŒë³µ</option>
                                <option value="ìì‚´">ìì‚´</option>
                                <option value="ì¦ì§„">ì¦ì§„</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CRI</label>
                            <input type="text" id="criInfo" maxlength="50" placeholder="CRI ì •ë³´">
                        </div>
                    </div>
                </div>
                
                <!-- ì˜ë¢° ìœ í˜• ì„¹ì…˜ -->
                <div class="form-section referral-type">
                    <h3>ğŸ“‹ ì˜ë¢° ìœ í˜•</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <input type="checkbox" id="diagnosisProtectionRequest" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ì§„ë‹¨ ë³´í˜¸ìš”ì²­</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <input type="checkbox" id="writtenReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ì„œë©´ì˜ë¢°</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <input type="checkbox" id="phoneReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ìœ ì„ ì˜ë¢°</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <input type="checkbox" id="policeInvolvement" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ê²½ì°°ê°œì…ì—¬ë¶€</span>
                        </label>
                    </div>
                </div>
                
                <!-- ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section diagnosis-info">
                    <h3>ğŸ¥ ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì§„ë‹¨ëª…</label>
                            <input type="text" id="diagnosis" maxlength="100" placeholder="ì˜ˆ: ìš°ìš¸ì¦, ì¡°í˜„ë³‘ ë“±">
                        </div>
                        <div class="form-group">
                            <label>ì¡°ì¹˜ê²°ê³¼</label>
                            <select id="actionResult">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)">ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)</option>
                                <option value="ì§€ì†ìƒë‹´">ì§€ì†ìƒë‹´</option>
                                <option value="ì¹˜ë£Œì—°ê³„">ì¹˜ë£Œì—°ê³„</option>
                                <option value="ì„œë¹„ìŠ¤ ì—°ê³„">ì„œë¹„ìŠ¤ ì—°ê³„</option>
                                <option value="ê¸°íƒ€ì¡°ì¹˜">ê¸°íƒ€ì¡°ì¹˜</option>
                                <option value="ì •ë³´ì œê³µ">ì •ë³´ì œê³µ</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì²˜ë¦¬ì¤‘">ì²˜ë¦¬ì¤‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì¢…ê²°ì—¬ë¶€</label>
                            <select id="closureStatus">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸">ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸</option>
                                <option value="ë¯¸ë“±ë¡ì ì¢…ê²°">ë¯¸ë“±ë¡ì ì¢…ê²°</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ìƒì„¸ ë‚´ìš© ì„¹ì…˜ -->
                <div class="form-section content-info">
                    <h3>ğŸ“ ìƒì„¸ ë‚´ìš©</h3>
                    <div class="form-group">
                        <label>ê°œì…ë‚´ìš©/í˜„ìƒí™© *</label>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div></div>
                            <button type="button" onclick="insertSampleText()" style="background: #059669; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">ğŸ“ ìƒ˜í”Œ í…ìŠ¤íŠ¸ ì‚½ì…</button>
                        </div>
                        <textarea id="interventionContent" required maxlength="5000" placeholder="í˜„ì¬ ìƒí™©, ê°œì… ë‚´ìš©, ì¦ìƒì˜ êµ¬ì²´ì  ë‚´ìš© ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ í•´ì£¼ì„¸ìš”." style="min-height: 150px; resize: vertical; font-family: 'Malgun Gothic', sans-serif; line-height: 1.6;"></textarea>
                    </div>
                </div>
                
                <!-- íšŒì‹  ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section" style="background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); border: 2px solid #64748b;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 24px;">ğŸ“¬</span>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 700;">íšŒì‹  ì •ë³´</h3>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 700; color: #1f2937; font-size: 15px;">íšŒì‹ ì—¬ë¶€ ë° ë‚´ìš©</label>
                        <textarea id="responseRequired" maxlength="1000" placeholder="íšŒì‹ ì´ í•„ìš”í•œ ê²½ìš° êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." style="min-height: 80px; resize: vertical; border: 2px solid #cbd5e1; font-family: 'Malgun Gothic', sans-serif;"></textarea>
                    </div>
                </div>
                
                <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" onclick="closeNewReferralModal()" style="padding: 14px 28px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì·¨ì†Œ</button>
                    <button type="button" onclick="saveDraftReferral()" style="padding: 14px 28px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì„ì‹œì €ì¥</button>
                    <button type="submit" id="submitNewReferralBtn" style="padding: 14px 28px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì ‘ìˆ˜ ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ì˜ë¢° ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal hidden" id="referralDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì˜ë¢° ìƒì„¸ë³´ê¸°</h2>
                <button class="modal-close" onclick="closeReferralDetailModal()">Ã—</button>
            </div>
            <div id="referralDetailContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px;">
                <button onclick="closeReferralDetailModal()" style="padding: 12px 24px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
                <button id="editCurrentReferralBtn" onclick="editCurrentReferral()" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ìˆ˜ì •</button>
            </div>
        </div>
    </div>
    
    <!-- ê³„ì • ê´€ë¦¬ ëª¨ë‹¬ -->
    <div class="modal hidden" id="accountManagementModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ‘¥ ê³„ì • ê´€ë¦¬</h2>
                <button class="modal-close" onclick="closeAccountModal()">Ã—</button>
            </div>
            <div style="margin-bottom: 20px;">
                <button onclick="showNewAccountForm()" style="background: var(--gradient-primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">â• ìƒˆ ê³„ì • ì¶”ê°€</button>
            </div>
            
            <!-- ìƒˆ ê³„ì • ì¶”ê°€ í¼ -->
            <div id="newAccountForm" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">ìƒˆ ê³„ì • ì¶”ê°€</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ì‚¬ìš©ì ID *</label>
                        <input type="text" id="newUserId" maxlength="20" placeholder="ì˜ë¬¸, ìˆ«ì ì¡°í•©">
                    </div>
                    <div class="form-group">
                        <label>ë¹„ë°€ë²ˆí˜¸ *</label>
                        <input type="password" id="newUserPassword" maxlength="50" placeholder="ìµœì†Œ 4ì ì´ìƒ">
                    </div>
                    <div class="form-group">
                        <label>ì´ë¦„ *</label>
                        <input type="text" id="newUserName" maxlength="20" placeholder="ì‹¤ì œ ì´ë¦„">
                    </div>
                    <div class="form-group">
                        <label>ê¶Œí•œ *</label>
                        <select id="newUserRole">
                            <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                            <option value="manager">ê´€ë¦¬ì</option>
                            <option value="admin">ìµœê³ ê´€ë¦¬ì</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="createAccount()" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">ì¶”ê°€</button>
                    <button onclick="hideNewAccountForm()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <!-- ê³„ì • ëª©ë¡ í…Œì´ë¸” -->
            <div class="user-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ìš©ì ID</th>
                            <th>ì´ë¦„</th>
                            <th>ê¶Œí•œ</th>
                            <th>ìƒì„±ì¼</th>
                            <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- ê³„ì • ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="app-container hidden" id="mainApp">
        <!-- ì‚¬ì´ë“œë°” -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</h2>
                <div class="user-info">
                    <div id="currentUserName">ì‹œìŠ¤í…œê´€ë¦¬ì</div>
                    <div id="currentUserRole">ê´€ë¦¬ì</div>
                </div>
            </div>
            <div class="nav-menu">
                <div class="nav-item">
                    <div class="nav-link active" onclick="showPage('referrals')">
                        <span class="icon">ğŸ‘¥</span>
                        ì˜ë¢° ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('data')">
                        <span class="icon">ğŸ’¾</span>
                        ë°ì´í„° ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('reports')">
                        <span class="icon">ğŸ“ˆ</span>
                        í†µê³„/ë³´ê³ ì„œ
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('accounts')">
                        <span class="icon">ğŸ‘¥</span>
                        ê³„ì • ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item" style="margin-top: 30px;">
                    <div class="nav-link" onclick="handleLogout()" style="color: var(--danger-color);">
                        <span class="icon">ğŸšª</span>
                        ë¡œê·¸ì•„ì›ƒ
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- ë©”ì¸ ì»¨í…íŠ¸ ì˜ì—­ -->
        <main class="main-content">
            <!-- ì˜ë¢° ê´€ë¦¬ í˜ì´ì§€ -->
            <div class="page" id="referralsPage">
                <div class="dashboard-container">
                    <!-- í˜ì´ì§€ í—¤ë” -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding: 32px 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: var(--shadow); flex-wrap: wrap; gap: 20px;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">ì˜ë¢° ê´€ë¦¬</h1>
                        <button class="new-referral-btn" onclick="openNewReferralModal()">
                            <span>â•</span>
                            ìƒˆ ì˜ë¢° ì ‘ìˆ˜
                        </button>
                    </div>
                    
                    <!-- íŒ€ë³„ íƒ­ ì‹œìŠ¤í…œ -->
                    <div class="team-management-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 32px; text-align: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">
                        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 800;">ğŸ¥ íŒ€ë³„ ì˜ë¢° ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                        <p style="margin: 0; font-size: 16px; opacity: 0.9;">ê° íŒ€ë³„ë¡œ ì˜ë¢°ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ì¶”ì í•˜ì„¸ìš”</p>
                    </div>
                    
                    <!-- íŒ€ ì„ íƒ íƒ­ -->
                    <div class="team-tabs-container" style="margin-bottom: 32px;">
                        <div class="team-tabs-wrapper" style="background: white; border-radius: 20px; padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 2px solid #e5e7eb;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 20px; font-weight: 700;">íŒ€ ì„ íƒ</h3>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">ë³´ê³  ì‹¶ì€ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            </div>
                            <div class="team-tabs-grid" id="teamTabsGrid">
                                <div class="chart-data-display">
                                    <div class="chart-item" data-team="all" onclick="selectTeam('all')" style="cursor: pointer;">
                                        <div class="chart-item-value">ğŸ“Š</div>
                                        <div class="chart-item-label">ì „ì²´ íŒ€</div>
                                        <div class="chart-item-percentage" id="allTeamCount">5ê±´</div>
                                    </div>
                                    <div class="chart-item" data-team="ì¦ì§„íŒ€" onclick="selectTeam('ì¦ì§„íŒ€')" style="cursor: pointer;">
                                        <div class="chart-item-value">ğŸ¯</div>
                                        <div class="chart-item-label">ì¦ì§„íŒ€</div>
                                        <div class="chart-item-percentage" id="team1Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" data-team="íšŒë³µíŒ€" onclick="selectTeam('íšŒë³µíŒ€')" style="cursor: pointer;">
                                        <div class="chart-item-value">ğŸŒ±</div>
                                        <div class="chart-item-label">íšŒë³µíŒ€</div>
                                        <div class="chart-item-percentage" id="team2Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" data-team="ìì‚´ì˜ˆë°©ì„¼í„°" onclick="selectTeam('ìì‚´ì˜ˆë°©ì„¼í„°')" style="cursor: pointer;">
                                        <div class="chart-item-value">ğŸš¨</div>
                                        <div class="chart-item-label">ìì‚´ì˜ˆë°©ì„¼í„°</div>
                                        <div class="chart-item-percentage" id="team3Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" data-team="ì•„ë™ì²­ì†Œë…„" onclick="selectTeam('ì•„ë™ì²­ì†Œë…„')" style="cursor: pointer;">
                                        <div class="chart-item-value">ğŸ‘¶</div>
                                        <div class="chart-item-label">ì•„ë™ì²­ì†Œë…„</div>
                                        <div class="chart-item-percentage" id="team4Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" data-team="ë‚¨ë¶€ë¶„ì†Œ" onclick="selectTeam('ë‚¨ë¶€ë¶„ì†Œ')" style="cursor: pointer;">
                                        <div class="chart-item-value">ğŸ¢</div>
                                        <div class="chart-item-label">ë‚¨ë¶€ë¶„ì†Œ</div>
                                        <div class="chart-item-percentage" id="team5Count">1ê±´</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í˜„ì¬ íŒ€ ì •ë³´ -->
                    <div class="current-team-info" id="currentTeamInfo">
                        <div style="background: linear-gradient(135deg, #f9fafb, white); border: 3px solid #6b7280; border-radius: 16px; padding: 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div id="currentTeamIcon" style="font-size: 56px;">ğŸ“Š</div>
                                <div>
                                    <h3 id="currentTeamTitle" style="margin: 0; color: #6b7280; font-size: 24px; font-weight: 800;">ì „ì²´ íŒ€ ì˜ë¢° ëª©ë¡</h3>
                                    <p id="currentTeamDesc" style="margin: 6px 0 0 0; color: #6b7280; font-size: 16px;">ëª¨ë“  íŒ€ì˜ ì˜ë¢°ë¥¼ í†µí•© ê´€ë¦¬</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div id="currentTeamCount" style="font-size: 48px; font-weight: 900; color: #6b7280;">5</div>
                                <div style="font-size: 16px; color: #6b7280; font-weight: 600;">ì´ ì˜ë¢° ê±´ìˆ˜</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì˜ë¢° ëª©ë¡ ìœ„ì ¯ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ì˜ë¢° ëª©ë¡</h3>
                            <span class="widget-icon">ğŸ“‹</span>
                        </div>
                        <div id="referralsList">
                            <div class="table-container">
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ì˜ë¢°ë²ˆí˜¸</th>
                                                <th>ì´ë¦„</th>
                                                <th>ì„±ë³„/ë‚˜ì´</th>
                                                <th>ì˜ë¢°ë‚ ì§œ</th>
                                                <th>ì˜ë¢°ê¸°ê´€</th>
                                                <th>ë‹´ë‹¹íŒ€</th>
                                                <th>ë‹´ë‹¹ì</th>
                                                <th>ì§„ë‹¨ëª…</th>
                                                <th>ì¡°ì¹˜ê²°ê³¼</th>
                                                <th>ì¢…ê²°ì—¬ë¶€</th>
                                                <th style="text-align: center;">ì‘ì—…</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referralsTableBody">
                                            <!-- ê¸°ë³¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë°ì´í„° ê´€ë¦¬ í˜ì´ì§€ -->
            <div class="page hidden" id="dataPage">
                <div class="dashboard-container">
                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow-lg); text-align: center;">
                        <h1 style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 32px; font-weight: 800; margin-bottom: 12px;">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h1>
                        <p style="color: var(--text-secondary); font-size: 16px;">ë°ì´í„° ë°±ì—…, ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë° íŒŒì¼ ê´€ë¦¬</p>
                    </div>
                    
                    <!-- ë°ì´í„° ë‚´ë³´ë‚´ê¸° -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">ğŸ“Š</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <button onclick="downloadExcel()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: #059669; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>ğŸ“ˆ</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (.xlsx)
                            </button>
                            <button onclick="downloadJSON()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>ğŸ’¾</span> JSON ë°±ì—…
                            </button>
                            <button onclick="downloadCSV()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: #d97706; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>ğŸ“„</span> CSV ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                    
                    <!-- ë°ì´í„° í†µê³„ -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">ğŸ“ˆ ë°ì´í„° í˜„í™©</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">ğŸ“ˆ</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px;">
                                <div id="totalReferrals" style="font-size: 36px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">ì´ ì˜ë¢° ê±´ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 16px;">
                                <div id="completedReferrals" style="font-size: 36px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">ì¢…ê²° ê±´ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 16px;">
                                <div id="progressingReferrals" style="font-size: 36px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">ì§„í–‰ ì¤‘</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 16px;">
                                <div id="avgAge" style="font-size: 36px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">í‰ê·  ì—°ë ¹</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í™œë™ ë¡œê·¸ -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">ğŸ“‹ ì‹œìŠ¤í…œ í™œë™ ë¡œê·¸</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">ğŸ“‹</span>
                        </div>
                        <div id="activityLog" style="background: #1f2937; color: #f9fafb; border-radius: 12px; padding: 16px; height: 250px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #10b981; border-radius: 4px; background: rgba(16, 185, 129, 0.1);">
                                [ì‹œìŠ¤í…œ] ğŸ’¾ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ
                            </div>
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #3b82f6; border-radius: 4px; background: rgba(59, 130, 246, 0.1);">
                                [ì •ë³´] ğŸ“Š ì—‘ì…€, CSV, JSON ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ í™œì„±í™”
                            </div>
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #10b981; border-radius: 4px; background: rgba(16, 185, 129, 0.1);">
                                [ì„±ê³µ] ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„ ë° ì°¨íŠ¸ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- í†µê³„/ë³´ê³ ì„œ í˜ì´ì§€ -->
            <div class="page hidden" id="reportsPage">
                <div class="dashboard-container">
                    <div style="background: var(--gradient-card); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow); text-align: center;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 16px;">ğŸ“ˆ í†µê³„ ë° ë³´ê³ ì„œ</h1>
                        <p style="font-size: 18px; color: var(--text-secondary); font-weight: 500;">ì˜ë¢° ë°ì´í„°ë¥¼ ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¶„ì„í•œ ì‹œê°ì  í†µê³„</p>
                    </div>
                    
                    <div id="reportsFilterBar" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; background: #ffffff; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 24px;">
                        <div class="form-group">
                            <label style="display:block; font-weight:600; margin-bottom:6px;">íŒ€ ì„ íƒ</label>
                            <select id="reportsTeamSelect" onchange="onReportsTeamChange()" style="width:100%; padding:10px 12px; border:1px solid var(--border-color); border-radius:8px;">
                                <option value="all">ëª¨ë“  íŒ€</option>
                                <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                                <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                                <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                                <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                            </select>
                        </div>
                        <div class="form-group" id="reportsSubTeamContainer" style="display:none;">
                            <label style="display:block; font-weight:600; margin-bottom:6px;">ë‚¨ë¶€ë¶„ì†Œ ì„¸ë¶€íŒ€</label>
                            <select id="reportsSubTeamSelect" onchange="onReportsTeamChange()" style="width:100%; padding:10px 12px; border:1px solid var(--border-color); border-radius:8px;">
                                <option value="">ì„¸ë¶€íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="íšŒë³µ">íšŒë³µ</option>
                                <option value="ìì‚´">ìì‚´</option>
                                <option value="ì¦ì§„">ì¦ì§„</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 40px;">
                        <!-- ì„±ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ‘¥ ì„±ë³„ ë¶„í¬</h3>
                            <canvas id="genderChart" width="300" height="200"></canvas>
                        </div>
                        
                        <!-- ì—°ë ¹ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ“Š ì—°ë ¹ë³„ ë¶„í¬</h3>
                            <canvas id="ageChart" width="300" height="200"></canvas>
                        </div>
                        
                        <!-- íŒ€ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ¢ íŒ€ë³„ ë¶„í¬</h3>
                            <canvas id="teamChart" width="300" height="200"></canvas>
                        </div>
                        
                        <!-- ì§€ì—­ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ—ºï¸ ì§€ì—­ë³„ ë¶„í¬</h3>
                            <canvas id="regionChart" width="300" height="200"></canvas>
                        </div>
                        
                        <!-- ë‹´ë‹¹ìë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ‘¨â€âš•ï¸ ë‹´ë‹¹ìë³„ ë¶„í¬</h3>
                            <canvas id="counselorChart" width="300" height="200"></canvas>
                        </div>
                        
                        <!-- ì¡°ì¹˜ê²°ê³¼ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ“‹ ì¡°ì¹˜ê²°ê³¼ë³„ ë¶„í¬</h3>
                            <canvas id="actionChart" width="300" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- ì›”ë³„ ì¶”ì´ ì°¨íŠ¸ -->
                    <div style="background: white; padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 40px;">
                        <h3 style="text-align: center; margin-bottom: 24px; color: #1f2937; font-size: 20px; font-weight: 700;">ğŸ“ˆ ì›”ë³„ ì˜ë¢° ì¶”ì´</h3>
                        <canvas id="monthlyChart" width="800" height="300"></canvas>
                    </div>
                    
                    <!-- ì¢…í•© í†µê³„ ìš”ì•½ -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 32px; border-radius: 20px; box-shadow: var(--shadow);">
                        <h3 style="text-align: center; margin-bottom: 24px; font-size: 24px; font-weight: 700;">ğŸ“Š ì¢…í•© í†µê³„ ìš”ì•½</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div id="summaryTotal" style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ì´ ì ‘ìˆ˜ ê±´ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div id="summaryMale" style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ë‚¨ì„± ë¹„ìœ¨</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div id="summaryFemale" style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ì—¬ì„± ë¹„ìœ¨</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div id="summaryCompleted" style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ì¢…ê²°ë¥ </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ê³„ì • ê´€ë¦¬ í˜ì´ì§€ -->
            <div class="page hidden" id="accountsPage">
                <div class="dashboard-container">
                    <div style="background: var(--gradient-card); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow); text-align: center;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 16px;">ğŸ‘¥ ê³„ì • ê´€ë¦¬</h1>
                        <p style="font-size: 18px; color: var(--text-secondary); font-weight: 500;">ì‹œìŠ¤í…œ ì‚¬ìš©ì ê³„ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="font-size: 24px; font-weight: 700;">ê³„ì • ëª©ë¡</h2>
                        <button onclick="openAccountModal()" style="background: var(--gradient-primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">â• ìƒˆ ê³„ì • ì¶”ê°€</button>
                    </div>
                    
                    <!-- ê³„ì • ëª©ë¡ í…Œì´ë¸” -->
                    <div class="user-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì‚¬ìš©ì ID</th>
                                    <th>ì´ë¦„</th>
                                    <th>ê¶Œí•œ</th>
                                    <th>ìƒì„±ì¼</th>
                                    <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody">
                                <!-- ê³„ì • ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ë””ë²„ê·¸ í™œì„±í™” ì„¤ì • (ê´€ë¦¬ìë§Œ) -->
                    <div class="widget" id="debugSettings" style="margin-top: 40px;">
                        <div class="widget-header">
                            <h3 class="widget-title">ğŸ”§ ë””ë²„ê·¸ ì„¤ì •</h3>
                            <span class="widget-icon">âš™ï¸</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="debugModeToggle" onchange="toggleDebugMode(this.checked)" style="transform: scale(1.2);">
                                <span style="font-weight: 600;">ê°œë°œì ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”</span>
                            </label>
                            <span style="color: var(--text-secondary); font-size: 14px;">
                                (ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥, ì‹œìŠ¤í…œ ë¡œê·¸ ë° ì§„ë‹¨ ë„êµ¬ í™œì„±í™”)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        let currentUserInfo = null;
        let currentActivePage = 'referrals';
        let selectedTeamFilter = 'all';
        let editingReferralData = null;
        let viewingReferralData = null;
        let charts = {};
        let debugMode = false;

        // ë””ë²„ê¹… ì‹œìŠ¤í…œ
        let debugLog = [];
        
        function debugAddLog(message, type = 'info') {
            if (!debugMode) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLog.push(logEntry);
            
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const logDiv = document.createElement('div');
                logDiv.className = type === 'error' ? 'debug-error' : 'debug-info';
                logDiv.textContent = `[${timestamp}] ${message}`;
                debugContent.appendChild(logDiv);
                
                while (debugContent.children.length > 20) {
                    debugContent.removeChild(debugContent.firstChild);
                }
                
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.log(`ğŸ”§ [${type.toUpperCase()}] ${message}`);
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                panel.classList.toggle('hidden');
                debugAddLog('ë””ë²„ê·¸ íŒ¨ë„ í† ê¸€', 'info');
            }
        }
        
        function clearDebugLog() {
            debugLog = [];
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = '<div class="debug-info">ë¡œê·¸ê°€ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        function debugSystemStatus() {
            debugAddLog('=== ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ===', 'info');
            debugAddLog(`ì „ì²´ ì˜ë¢° ë°ì´í„°: ${referralDatabase.length}ê±´`, 'info');
            debugAddLog(`í˜„ì¬ ë³´ê³ ìˆëŠ” ì˜ë¢°: ${viewingReferralData ? viewingReferralData.refNo : 'null'}`, 'info');
            debugAddLog(`í˜„ì¬ ìˆ˜ì •ì¤‘ì¸ ì˜ë¢°: ${editingReferralData ? editingReferralData.refNo : 'null'}`, 'info');
            debugAddLog(`í˜„ì¬ í™œì„± í˜ì´ì§€: ${currentActivePage}`, 'info');
            debugAddLog(`ì„ íƒëœ íŒ€ í•„í„°: ${selectedTeamFilter}`, 'info');
            debugAddLog(`í˜„ì¬ ì‚¬ìš©ì: ${currentUserInfo ? currentUserInfo.name : 'null'}`, 'info');
            debugAddLog('=== ìƒíƒœ ì²´í¬ ì™„ë£Œ ===', 'info');
        }

        function toggleDebugMode(enabled) {
            debugMode = enabled;
            const debugToggleBtn = document.getElementById('debugToggleBtn');
            
            if (enabled) {
                debugToggleBtn.classList.remove('hidden');
                debugAddLog('ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”ë¨', 'info');
            } else {
                debugToggleBtn.classList.add('hidden');
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.classList.add('hidden');
                console.log('ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™”ë¨');
            }
        }

        // ì˜ë¢° ë°ì´í„°ë² ì´ìŠ¤ - ì‹¤ì œ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì–‘ì‹ ì ìš©
        let referralDatabase = [
            { 
                refNo: 'R0001', 
                name: 'ê¹€**', 
                gender: 'ë‚¨ì„±', 
                age: 35, 
                referralDate: '2025-07-10',
                referralPath: 'ê°€ì¡±ì‹ ê³ ',
                agency: 'ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°', 
                team: 'íšŒë³µíŒ€',
                region: 'ì´ì²œì‹œ ì°½ì „ë™',
                counselor: 'ë°•ìƒë‹´ì‚¬', 
                diagnosis: 'ìš°ìš¸ì¦', 
                interventionContent: 'ìµœê·¼ 2ê°œì›”ê°„ ìš°ìš¸ê° ì‹¬í™”, ì¼ìƒìƒí™œ ì–´ë ¤ì›€. ê°€ì¡± ì‹ ê³ ë¡œ ìƒë‹´ ì˜ë¢°.',
                actionResult: 'ì§€ì†ìƒë‹´',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-001',
                responseRequired: 'ì²˜ë¦¬ê²°ê³¼ íšŒì‹  ìš”ì²­'
            },
            { 
                refNo: 'R0002', 
                name: 'ì´**', 
                gender: 'ì—¬ì„±', 
                age: 28, 
                referralDate: '2025-07-12',
                referralPath: 'ê²½ì°°ì‹ ê³ ',
                agency: 'ê²½ì°°ì„œ', 
                team: 'ìì‚´ì˜ˆë°©ì„¼í„°',
                region: 'ì´ì²œì‹œ ë¶€ë°œì',
                counselor: 'ê¹€ìƒë‹´ì‚¬', 
                diagnosis: 'ì¡°í˜„ë³‘', 
                interventionContent: 'ìí•´ ì‹œë„ í›„ ê²½ì°° ì¶œë™. ì¦‰ì‹œ ì „ë¬¸ìƒë‹´ í•„ìš”í•œ ìƒíƒœ.',
                actionResult: 'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: true,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: true,
                criInfo: 'CRI-002',
                responseRequired: 'ê¸´ê¸‰ ì¡°ì¹˜ ê²°ê³¼ ì¦‰ì‹œ íšŒì‹  í•„ìš”'
            },
            { 
                refNo: 'R0003', 
                name: 'ë°•**', 
                gender: 'ë‚¨ì„±', 
                age: 16, 
                referralDate: '2025-07-13',
                referralPath: 'í•™êµì˜ë¢°',
                agency: 'í•™êµ', 
                team: 'ì•„ë™ì²­ì†Œë…„',
                region: 'ì´ì²œì‹œ ì‹ ë‘”ë©´',
                counselor: 'ìµœìƒë‹´ì‚¬', 
                diagnosis: 'ë¶ˆì•ˆì¥ì• ', 
                interventionContent: 'í•™êµì—ì„œ ë˜ë˜ê´€ê³„ ì–´ë ¤ì›€ ë° ë¶ˆì•ˆì¦ìƒìœ¼ë¡œ ì˜ë¢°.',
                actionResult: 'ì¹˜ë£Œì—°ê³„',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-003',
                responseRequired: '-'
            },
            { 
                refNo: 'R0004', 
                name: 'ìµœ**', 
                gender: 'ì—¬ì„±', 
                age: 42, 
                referralDate: '2025-07-14',
                referralPath: 'ë³´ê±´ì†Œì˜ë¢°',
                agency: 'ë³´ê±´ì†Œ', 
                team: 'ì¦ì§„íŒ€',
                region: 'ì´ì²œì‹œ í˜¸ë²•ë©´',
                counselor: 'ì •ìƒë‹´ì‚¬', 
                diagnosis: 'ê¸°íƒ€ì§ˆí™˜', 
                interventionContent: 'ì •ì‹ ê±´ê°• ìƒë‹´ ìš”ì²­. ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ í•„ìš”.',
                actionResult: 'ì¢…ê²°',
                closureStatus: 'ì¢…ê²°',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: false,
                criInfo: 'CRI-004',
                responseRequired: 'ìƒë‹´ ì™„ë£Œ ê²°ê³¼ í†µë³´'
            },
            { 
                refNo: 'R0005', 
                name: 'ì •**', 
                gender: 'ë‚¨ì„±', 
                age: 52, 
                referralDate: '2025-07-14',
                referralPath: 'ë³¸ì¸ì‹ ì²­',
                agency: 'ë³¸ì¸', 
                team: 'ë‚¨ë¶€ë¶„ì†Œ',
                region: 'ì´ì²œì‹œ ë§ˆì¥ë©´',
                counselor: 'ì†¡ìƒë‹´ì‚¬', 
                diagnosis: 'ì•Œì½”ì˜¬ì‚¬ìš©ì¥ì• ', 
                interventionContent: 'ë³¸ì¸ì´ ì§ì ‘ ì•Œì½”ì˜¬ ë¬¸ì œë¡œ ìƒë‹´ ì‹ ì²­.',
                actionResult: 'ì²˜ë¦¬ì¤‘',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-005',
                responseRequired: '-'
            }
        ];

        // ì‚¬ìš©ì ê³„ì • ë°ì´í„°ë² ì´ìŠ¤
        let userDatabase = [
            {
                id: 'admin',
                password: '1234',
                name: 'ì‹œìŠ¤í…œê´€ë¦¬ì',
                role: 'admin',
                createdDate: '2025-01-01',
                lastLogin: '2025-09-11 14:30:00',
                active: true
            },
            {
                id: 'manager1',
                password: 'manager123',
                name: 'ê¹€ê´€ë¦¬ì',
                role: 'manager', 
                createdDate: '2025-01-15',
                lastLogin: '2025-09-10 16:20:00',
                active: true
            },
            {
                id: 'user1',
                password: 'user123',
                name: 'ë°•ìƒë‹´ì‚¬',
                role: 'user',
                createdDate: '2025-02-01',
                lastLogin: '2025-09-09 09:15:00',
                active: true
            }
        ];

        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateCurrentTime() {
            try {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString('ko-KR');
                }
            } catch (error) {
                debugAddLog('ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            try {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                while (container.children.length >= 3) {
                    container.removeChild(container.firstChild);
                }

                const notification = document.createElement('div');
                notification.className = 'notification ' + type;
                
                const messageDiv = document.createElement('div');
                messageDiv.style.display = 'flex';
                messageDiv.style.justifyContent = 'space-between';
                messageDiv.style.alignItems = 'center';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = 'Ã—';
                closeButton.style.cssText = 'background:none;border:none;font-size:18px;cursor:pointer;margin-left:10px;color:inherit;';
                closeButton.onclick = function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                };
                
                messageDiv.appendChild(textSpan);
                messageDiv.appendChild(closeButton);
                notification.appendChild(messageDiv);
                container.appendChild(notification);
                
                setTimeout(function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                debugAddLog('ì•Œë¦¼ í‘œì‹œ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogin() {
            try {
                const loginBtn = document.getElementById('loginBtn');
                const loginErrors = document.getElementById('loginErrors');
                
                loginErrors.style.display = 'none';
                loginErrors.innerHTML = '';
                
                loginBtn.disabled = true;
                loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!username || !password) {
                    showLoginError('ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }

                const user = userDatabase.find(u => u.id === username && u.password === password && u.active);
                
                if (user) {
                    currentUserInfo = {
                        id: user.id,
                        name: user.name,
                        role: user.role
                    };
                    
                    user.lastLogin = new Date().toLocaleString('ko-KR');
                    
                    const loginScreen = document.getElementById('loginScreen');
                    const mainApp = document.getElementById('mainApp');
                    
                    if (loginScreen) loginScreen.classList.add('hidden');
                    if (mainApp) mainApp.classList.remove('hidden');
                    
                    updateUserInfo();
                    initializeSystem();
                    
                    showNotification(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUserInfo.name}ë‹˜!`, 'success');
                    debugAddLog('ë¡œê·¸ì¸ ì„±ê³µ: ' + currentUserInfo.name + ' (' + currentUserInfo.role + ')', 'info');
                    
                } else {
                    showLoginError('ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    debugAddLog('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì˜ëª»ëœ ìê²©ì¦ëª… - ' + username, 'error');
                }
            } catch (error) {
                debugAddLog('ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜: ' + error.message, 'error');
                showLoginError('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ë¡œê·¸ì¸';
                }
            }
        }

        function showLoginError(message) {
            const loginErrors = document.getElementById('loginErrors');
            if (loginErrors) {
                loginErrors.innerHTML = `<div class="error-message">${message}</div>`;
                loginErrors.style.display = 'block';
            }
        }

        function updateUserInfo() {
            const nameElement = document.getElementById('currentUserName');
            const roleElement = document.getElementById('currentUserRole');
            if (nameElement && currentUserInfo) nameElement.textContent = currentUserInfo.name;
            if (roleElement && currentUserInfo) {
                const roleNames = {
                    'admin': 'ìµœê³ ê´€ë¦¬ì',
                    'manager': 'ê´€ë¦¬ì', 
                    'user': 'ì¼ë°˜ì‚¬ìš©ì'
                };
                roleElement.textContent = roleNames[currentUserInfo.role] || currentUserInfo.role;
            }
        }

        function initializeSystem() {
            try {
                updateReferralsTable();
                updateTeamCounts();
                updateDataStats();
                selectTeam('all');
                updateAccountsTable();
                
                if (currentUserInfo.role === 'admin') {
                    document.getElementById('debugSettings').style.display = 'block';
                } else {
                    document.getElementById('debugSettings').style.display = 'none';
                }
                
                debugAddLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        function handleLogout() {
            try {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    currentUserInfo = null;
                    
                    const mainApp = document.getElementById('mainApp');
                    const loginScreen = document.getElementById('loginScreen');
                    
                    if (mainApp) mainApp.classList.add('hidden');
                    if (loginScreen) loginScreen.classList.remove('hidden');
                    
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    
                    toggleDebugMode(false);
                    
                    showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    debugAddLog('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
                }
            } catch (error) {
                debugAddLog('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜
        function showPage(pageId) {
            try {
                debugAddLog('í˜ì´ì§€ ì „í™˜: ' + pageId, 'info');
                
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => page.classList.add('hidden'));

                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));

                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }

                if (pageId === 'reports') {
                    setTimeout(() => createCharts(), 100);
                } else if (pageId === 'data') {
                    updateDataStats();
                } else if (pageId === 'accounts') {
                    updateAccountsTable();
                }

                const activeNav = document.querySelector(`.nav-link[onclick*="${pageId}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }

                currentActivePage = pageId;
                
                const pageNames = {
                    'referrals': 'ì˜ë¢° ê´€ë¦¬',
                    'data': 'ë°ì´í„° ê´€ë¦¬',
                    'reports': 'í†µê³„/ë³´ê³ ì„œ',
                    'accounts': 'ê³„ì • ê´€ë¦¬'
                };
                
                showNotification(`${pageNames[pageId] || pageId} í˜ì´ì§€ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`, 'info');
            } catch (error) {
                debugAddLog('í˜ì´ì§€ ì „í™˜ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // íŒ€ ì„ íƒ í•¨ìˆ˜
        function selectTeam(teamId) {
            try {
                debugAddLog('íŒ€ ì„ íƒ: ' + teamId, 'info');
                selectedTeamFilter = teamId;
                
                const teamItems = document.querySelectorAll('[data-team]');
                teamItems.forEach(item => {
                    item.style.background = '#f8f9fa';
                    item.style.color = '#374151';
                    item.style.transform = 'none';
                    item.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                });
                
                const selectedTeam = document.querySelector(`[data-team="${teamId}"]`);
                if (selectedTeam) {
                    const teamColors = {
                        'all': '#6b7280',
                        'ì¦ì§„íŒ€': '#3b82f6',
                        'íšŒë³µíŒ€': '#059669',
                        'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                        'ì•„ë™ì²­ì†Œë…„': '#d97706',
                        'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                    };
                    
                    const color = teamColors[teamId] || '#6b7280';
                    selectedTeam.style.background = color;
                    selectedTeam.style.color = 'white';
                    selectedTeam.style.transform = 'translateY(-2px) scale(1.05)';
                    selectedTeam.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
                }
                
                updateCurrentTeamDisplay(teamId);
                updateReferralsTable();
                
                const teamNames = {
                    'all': 'ì „ì²´ íŒ€',
                    'ì¦ì§„íŒ€': 'ì¦ì§„íŒ€',
                    'íšŒë³µíŒ€': 'íšŒë³µíŒ€',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': 'ìì‚´ì˜ˆë°©ì„¼í„°',
                    'ì•„ë™ì²­ì†Œë…„': 'ì•„ë™ì²­ì†Œë…„',
                    'ë‚¨ë¶€ë¶„ì†Œ': 'ë‚¨ë¶€ë¶„ì†Œ'
                };
                
                showNotification(`${teamNames[teamId]} ì„ íƒë¨`, 'info');
            } catch (error) {
                debugAddLog('íŒ€ ì„ íƒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function updateCurrentTeamDisplay(teamId) {
            try {
                const teamInfo = {
                    'all': { icon: 'ğŸ“Š', title: 'ì „ì²´ íŒ€ ì˜ë¢° ëª©ë¡', desc: 'ëª¨ë“  íŒ€ì˜ ì˜ë¢°ë¥¼ í†µí•© ê´€ë¦¬', color: '#6b7280' },
                    'ì¦ì§„íŒ€': { icon: 'ğŸ¯', title: 'ì¦ì§„íŒ€ ì˜ë¢° ëª©ë¡', desc: 'ì •ì‹ ê±´ê°• ì¦ì§„ì‚¬ì—… ê´€ë ¨ ì˜ë¢°', color: '#3b82f6' },
                    'íšŒë³µíŒ€': { icon: 'ğŸŒ±', title: 'íšŒë³µíŒ€ ì˜ë¢° ëª©ë¡', desc: 'ì •ì‹ ê±´ê°• íšŒë³µì§€ì› ê´€ë ¨ ì˜ë¢°', color: '#059669' },
                    'ìì‚´ì˜ˆë°©ì„¼í„°': { icon: 'ğŸš¨', title: 'ìì‚´ì˜ˆë°©ì„¼í„° ì˜ë¢° ëª©ë¡', desc: 'ìì‚´ì˜ˆë°© ë° ìœ„ê¸°ê°œì… ì˜ë¢°', color: '#dc2626' },
                    'ì•„ë™ì²­ì†Œë…„': { icon: 'ğŸ‘¶', title: 'ì•„ë™ì²­ì†Œë…„ ì˜ë¢° ëª©ë¡', desc: 'ì•„ë™ì²­ì†Œë…„ ì •ì‹ ê±´ê°• ì˜ë¢°', color: '#d97706' },
                    'ë‚¨ë¶€ë¶„ì†Œ': { icon: 'ğŸ¢', title: 'ë‚¨ë¶€ë¶„ì†Œ ì˜ë¢° ëª©ë¡', desc: 'ë‚¨ë¶€ë¶„ì†Œ ê´€í•  ì§€ì—­ ì˜ë¢°', color: '#7c3aed' }
                };
                
                const info = teamInfo[teamId] || teamInfo['all'];
                
                const iconElement = document.getElementById('currentTeamIcon');
                const titleElement = document.getElementById('currentTeamTitle');
                const descElement = document.getElementById('currentTeamDesc');
                
                if (iconElement) iconElement.textContent = info.icon;
                if (titleElement) titleElement.textContent = info.title;
                if (descElement) descElement.textContent = info.desc;
                
                const currentTeamInfo = document.getElementById('currentTeamInfo');
                if (currentTeamInfo) {
                    const border = currentTeamInfo.querySelector('div');
                    if (border) border.style.borderColor = info.color;
                    
                    const titles = currentTeamInfo.querySelectorAll('h3, p, div');
                    titles.forEach(element => {
                        element.style.color = info.color;
                    });
                }
            } catch (error) {
                debugAddLog('íŒ€ í‘œì‹œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function updateReferralsTable() {
            try {
                debugAddLog('ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹œì‘', 'info');
                const tbody = document.getElementById('referralsTableBody');
                if (!tbody) {
                    debugAddLog('í…Œì´ë¸” body ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                    return;
                }
                
                tbody.innerHTML = '';
                
                let filteredData = referralDatabase;
                if (selectedTeamFilter !== 'all') {
                    filteredData = referralDatabase.filter(item => item.team === selectedTeamFilter);
                }
                
                const countElement = document.getElementById('currentTeamCount');
                if (countElement) {
                    countElement.textContent = filteredData.length;
                }
                
                const actionResultColors = {
                    'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)': '#3b82f6',
                    'ì§€ì†ìƒë‹´': '#059669',
                    'ì¹˜ë£Œì—°ê³„': '#d97706',
                    'ì„œë¹„ìŠ¤ ì—°ê³„': '#7c3aed',
                    'ê¸°íƒ€ì¡°ì¹˜': '#6b7280',
                    'ì •ë³´ì œê³µ': '#0891b2',
                    'ì¢…ê²°': '#059669',
                    'ì²˜ë¦¬ì¤‘': '#f59e0b'
                };
                
                const closureStatusColors = {
                    'ì§„í–‰ì¤‘': '#d97706',
                    'ì¢…ê²°': '#059669',
                    'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸': '#6b7280',
                    'ë¯¸ë“±ë¡ì ì¢…ê²°': '#ef4444'
                };
                
                const teamColors = {
                    'ì¦ì§„íŒ€': '#3b82f6',
                    'íšŒë³µíŒ€': '#059669',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                    'ì•„ë™ì²­ì†Œë…„': '#d97706',
                    'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                };
                
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f3f4f6';
                    row.onmouseover = function() { this.style.background = '#f9fafb'; };
                    row.onmouseout = function() { this.style.background = 'white'; };
                    
                    const teamColor = teamColors[item.team] || '#6b7280';
                    
                    row.innerHTML = `
                        <td style="padding: 15px 12px; font-weight: 700; color: #1f2937; font-size: 13px;">${item.refNo}</td>
                        <td style="padding: 15px 12px; font-weight: 600; font-size: 13px;">${item.name}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.gender}<br><small style="color: #6b7280;">${item.age}ì„¸</small></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.referralDate}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.agency}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span style="color: ${teamColor}; font-weight: 600;">${item.team}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.counselor}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.diagnosis}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${actionResultColors[item.actionResult] || '#6b7280'};">${item.actionResult || '-'}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${closureStatusColors[item.closureStatus] || '#6b7280'};">${item.closureStatus}</span></td>
                        <td style="padding: 15px 12px; text-align: center;">
                            <button class="action-btn view" onclick="viewReferralDetail('${item.refNo}')">ìƒì„¸</button>
                            <button class="action-btn edit" onclick="editReferral('${item.refNo}')">ìˆ˜ì •</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                debugAddLog(`í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${filteredData.length}ê±´`, 'info');
            } catch (error) {
                debugAddLog('ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function updateTeamCounts() {
            try {
                const teams = ['ì¦ì§„íŒ€', 'íšŒë³µíŒ€', 'ìì‚´ì˜ˆë°©ì„¼í„°', 'ì•„ë™ì²­ì†Œë…„', 'ë‚¨ë¶€ë¶„ì†Œ'];
                
                const allCountElement = document.getElementById('allTeamCount');
                if (allCountElement) {
                    allCountElement.textContent = referralDatabase.length + 'ê±´';
                }
                
                teams.forEach((team, index) => {
                    const count = referralDatabase.filter(item => item.team === team).length;
                    const element = document.getElementById('team' + (index + 1) + 'Count');
                    if (element) {
                        element.textContent = count + 'ê±´';
                    }
                });
                
                debugAddLog('íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ìƒˆ ì˜ë¢° ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openNewReferralModal() {
            try {
                debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ì—´ê¸°', 'info');
                const modal = document.getElementById('newReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    
                    const today = new Date().toISOString().slice(0, 10);
                    const dateField = document.getElementById('referralDate');
                    if (dateField) {
                        dateField.value = today;
                    }
                    
                    const errorsDiv = document.getElementById('formErrors');
                    if (errorsDiv) {
                        errorsDiv.style.display = 'none';
                        errorsDiv.innerHTML = '';
                    }
                }
            } catch (error) {
                debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function closeNewReferralModal() {
            try {
                debugAddLog('ìƒˆ ì˜ë¢°/ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°', 'info');
                
                const isEditMode = editingReferralData !== null;
                
                if (isEditMode) {
                    debugAddLog('ìˆ˜ì • ëª¨ë“œì—ì„œ ëª¨ë‹¬ ë‹«ê¸°', 'info');
                    closeEditModal();
                } else {
                    debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë“œì—ì„œ ëª¨ë‹¬ ë‹«ê¸°', 'info');
                    
                    const modal = document.getElementById('newReferralModal');
                    const form = document.getElementById('newReferralForm');
                    
                    if (modal) modal.classList.add('hidden');
                    if (form) form.reset();
                    
                    const subTeamContainer = document.getElementById('subTeamContainer');
                    if (subTeamContainer) {
                        subTeamContainer.style.display = 'none';
                        const subTeamSelect = document.getElementById('subTeam');
                        if (subTeamSelect) {
                            subTeamSelect.required = false;
                            subTeamSelect.value = '';
                        }
                    }
                    
                    const errorsDiv = document.getElementById('formErrors');
                    if (errorsDiv) {
                        errorsDiv.style.display = 'none';
                        errorsDiv.innerHTML = '';
                    }
                }
                
            } catch (error) {
                debugAddLog('ìƒˆ ì˜ë¢°/ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function handleTeamSelection() {
            const teamSelect = document.getElementById('assignedTeam');
            const subTeamContainer = document.getElementById('subTeamContainer');
            
            if (teamSelect && teamSelect.value === 'ë‚¨ë¶€ë¶„ì†Œ') {
                if (subTeamContainer) {
                    subTeamContainer.style.display = 'block';
                    const subTeamSelect = document.getElementById('subTeam');
                    if (subTeamSelect) {
                        subTeamSelect.required = true;
                    }
                }
            } else {
                if (subTeamContainer) {
                    subTeamContainer.style.display = 'none';
                    const subTeamSelect = document.getElementById('subTeam');
                    if (subTeamSelect) {
                        subTeamSelect.required = false;
                        subTeamSelect.value = '';
                    }
                }
            }
        }

        function insertSampleText() {
            const sampleText = `ìì‚´ì‹œë„ë ¥ : (+) 1st 2022ë…„ 1ì›” Wrist cutting, 2nd 2022ë…„ 2ì›” ë†ì•½ìŒë…, 3rd 2022ë…„ 7ì›” íˆ¬ì‹  í•˜ë ¤ë‹¤ê°€ ê²½ì°°ì‹ ê³  

ì •ì‹ ê³¼ ì•½ë¬¼ë³µìš© ë° ì¹˜ë£Œì—¬ë¶€: 2022ë…„ 1ì›” ìˆ˜ì›ì•„ì£¼ëŒ€ë‚¨ë³‘ì› ì‘ê¸‰ì…ì› í›„ í‡´ì›, 2022ë…„ ì›ì£¼ê¸°ë…ë³‘ì› ìœ„ì„¸ì²™ í›„ ê·€ê°€. ì…ì›ì— ê±°ë¶€ì ì´ë©° 2ì›”ê¹Œì§€ ì •ì‹ ê³¼ ì•½ë¬¼ ë³µìš©í–ˆìœ¼ë‚˜ 2022ë…„ 6ì›” ì„ì˜ ì¤‘ë‹¨

ìŒì£¼ì—¬ë¶€ : ë§¤ì¼ ì†Œì£¼ 2ë³‘ì”©

ì‹ì‚¬ ë° ìˆ˜ë©´ : 2~3ì‹œê°„ ì¤ë‹¤ê°€ ê¹¨ì–´ë‚¨

ì§„ë‹¨ëª… : ì–‘ê·¹ì„± ì •ë™ì¥ì•  

ì•½ë¬¼ : (ì•„ì¹¨) ì•„ë¦¬í”¼ì¡¸ì • 2mg, ëª…ì¸ë²¤ì¦ˆíŠ¸ë¡œí•€ë©”ì‹¤ë ˆì´íŠ¸ì • 1mg, ë°œíŒŒí‚¨í¬ë¡œë…¸ì • 300mg, ë¦¬ë³´íŠ¸ë¦´ì •, ìŠ¤ë¦¬ë°˜ì • 0.5mg
(ì €ë…) ë°œíŒŒí‚¨í¬ë¡œë…¸ì • 300mg, íŒ”ë¦¬ìŠ¤íœì„œë°©ì • 3mg, ë¦¬ë³´íŠ¸ë¦´ì •, ìŠ¤ë¦¬ë°˜ì • 0.5mg

ì™¸ë˜ë³‘ì› : í•˜ì€ì •ì‹ ì˜í•™ê³¼ì˜ì›

ë³´í˜¸ìš”ì¸ : ê±°ë¶ì´ / ì§€ì§€ì²´ê³„ : ì´ˆë“±í•™êµ ë™ì°½ìƒ

ì£¼í˜¸ì†Œ ë° ê°œì…ë‚´ìš© : 1ì¸ ê°€êµ¬ì´ë©° ê³ ë“±í•™êµ ì¡¸ì—… í›„ ì´ì²œìœ¼ë¡œ ì™”ìœ¼ë‚˜ ëšœë ·í•œ ì§ì¥ì—†ì´ ì§‘ì—ì„œ ì€ë‘”. ìµœê·¼ 2ê°œì›”ê°„ ë¬´ë¶„ë³„í•œ ì§€ì¶œê³¼ í­ìŒ ì¦ê°€. ì •ì‹ ê³¼ì  ë¬¸ì œê°€ ìˆìœ¼ë‚˜ ì•½ë¬¼ì„ ì„ì˜ ì¤‘ë‹¨í•˜ì—¬ í•˜ì€ì •ì‹ ì˜í•™ê³¼ì˜ì›ì— ì—°ê³„í•˜ì˜€ìœ¼ë©° ì£¼ 1íšŒ ì™¸ë˜ë™í–‰í•˜ì—¬ ìƒë‹´ ë° ì•½ë¬¼ ì²˜ë°© ì¤‘, ê²½ì œì  ë¬¸ì œë¡œ ì´ì²œì‹œì²­ì—ì„œ ê²½ê¸°ë„í˜• ê¸´ê¸‰ìƒê³„ë¹„ ì§€ì›, ì‹ ì²´ì¹˜ë£Œ(ì–´ê¹¨ íƒˆê³¨)ë¥¼ ìœ„í•´ ì´ì²œì˜ë£Œì› ê³µê³µì‚¬ì—…ê³¼ ìì› ì—°ê³„

í˜„ìƒí™© : ë“±ë¡ì„ ìœ„í•´ ì´ˆê¸° ìƒë‹´ ì¤‘`;

            const textarea = document.getElementById('interventionContent');
            if (textarea) {
                textarea.value = sampleText;
                showNotification('ìƒ˜í”Œ í…ìŠ¤íŠ¸ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.', 'success');
                debugAddLog('ìƒ˜í”Œ í…ìŠ¤íŠ¸ ì‚½ì… ì™„ë£Œ', 'info');
            } else {
                debugAddLog('ê°œì…ë‚´ìš© textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                showNotification('í…ìŠ¤íŠ¸ ì‚½ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
        let selectedReportTeam = 'all';
        let selectedReportSubTeam = '';

        function onReportsTeamChange() {
            try {
                const teamSel = document.getElementById('reportsTeamSelect');
                const subWrap = document.getElementById('reportsSubTeamContainer');
                const subSel = document.getElementById('reportsSubTeamSelect');
                if (!teamSel) return;
                const teamVal = teamSel.value;
                if (teamVal === 'ë‚¨ë¶€ë¶„ì†Œ') {
                    if (subWrap) subWrap.style.display = 'block';
                } else {
                    if (subWrap) subWrap.style.display = 'none';
                    if (subSel) subSel.value = '';
                }
                selectedReportTeam = teamVal;
                selectedReportSubTeam = subSel ? subSel.value : '';
                createCharts();
            } catch (e) {
                debugAddLog('íŒ€ í•„í„° ë³€ê²½ ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        function getFilteredReportData() {
            let data = referralDatabase.slice();
            if (selectedReportTeam === 'all' || !selectedReportTeam) return data;
            if (selectedReportTeam === 'ë‚¨ë¶€ë¶„ì†Œ') {
                if (selectedReportSubTeam) {
                    const target = 'ë‚¨ë¶€ë¶„ì†Œ-' + selectedReportSubTeam;
                    return data.filter(it => it.team === target);
                } else {
                    return data.filter(it => typeof it.team === 'string' && it.team.startsWith('ë‚¨ë¶€ë¶„ì†Œ'));
                }
            }
            return data.filter(it => it.team === selectedReportTeam);
        }

        function createCharts() {
            try {
                debugAddLog('ì°¨íŠ¸ ìƒì„± ì‹œì‘', 'info');
                const data = getFilteredReportData();
                updateReportSummary(data);
                
                // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
                const chartIds = ['genderChart', 'ageChart', 'teamChart', 'regionChart', 'counselorChart', 'actionChart', 'monthlyChart'];
                chartIds.forEach(id => {
                    const el = document.getElementById(id);
                    const existing = el ? Chart.getChart(el) : null;
                    if (existing) existing.destroy();
                });

                // ì„±ë³„ ì°¨íŠ¸
                const genderCounts = countBy(data, item => normalizeGender(item.gender));
                renderDoughnut('genderChart', ['ë‚¨ì„±', 'ì—¬ì„±', 'ê¸°íƒ€/ë¯¸ìƒ'], [
                    genderCounts['ë‚¨ì„±'] || 0,
                    genderCounts['ì—¬ì„±'] || 0,
                    Object.keys(genderCounts).filter(k => !['ë‚¨ì„±','ì—¬ì„±'].includes(k)).reduce((s,k)=>s+(genderCounts[k]||0),0)
                ], ['#60a5fa','#f472b6','#a8a29e']);

                // ì—°ë ¹ ì°¨íŠ¸
                const ageBuckets = ['0â€”17','18â€”29','30â€”44','45â€”64','65+','ë¯¸ìƒ'];
                const ageCounts = [0,0,0,0,0,0];
                data.forEach(it => {
                    const a = parseInt(it.age);
                    if (!isFinite(a)) { ageCounts[5]++; return; }
                    if (a<=17) ageCounts[0]++; else if (a<=29) ageCounts[1]++; else if (a<=44) ageCounts[2]++; else if (a<=64) ageCounts[3]++; else ageCounts[4]++;
                });
                renderBar('ageChart', ageBuckets, ageCounts, '#34d399');

                // íŒ€ë³„ ì°¨íŠ¸
                const teamCounts = countBy(data, it => it.team || 'ë¯¸ì§€ì •');
                const sortedTeams = Object.entries(teamCounts).sort((a,b)=>b[1]-a[1]).slice(0,12);
                renderBar('teamChart', sortedTeams.map(x=>x[0]), sortedTeams.map(x=>x[1]), '#6366f1');

                // ì§€ì—­ë³„ ì°¨íŠ¸
                const regionCounts = countBy(data, it => it.region || 'ë¯¸ì§€ì •');
                const sortedRegions = Object.entries(regionCounts).sort((a,b)=>b[1]-a[1]).slice(0,12);
                renderBar('regionChart', sortedRegions.map(x=>x[0]), sortedRegions.map(x=>x[1]), '#f59e0b');

                // ë‹´ë‹¹ìë³„ ì°¨íŠ¸
                const counselorCounts = countBy(data, it => it.counselor || 'ë¯¸ì§€ì •');
                const sortedCounselors = Object.entries(counselorCounts).sort((a,b)=>b[1]-a[1]).slice(0,12);
                renderBar('counselorChart', sortedCounselors.map(x=>x[0]), sortedCounselors.map(x=>x[1]), '#10b981');

                // ì¡°ì¹˜ê²°ê³¼ë³„ ì°¨íŠ¸
                const actionCounts = countBy(data, it => it.actionResult || 'ë¯¸ì§€ì •');
                const sortedActions = Object.entries(actionCounts).sort((a,b)=>b[1]-a[1]).slice(0,12);
                renderBar('actionChart', sortedActions.map(x=>x[0]), sortedActions.map(x=>x[1]), '#ef4444');

                // ì›”ë³„ ì°¨íŠ¸
                const monthCounts = countBy(data, it => toMonth(it.referralDate));
                const months = Object.keys(monthCounts).sort();
                renderLine('monthlyChart', months, months.map(m => monthCounts[m] || 0), '#3b82f6');

                showNotification('í†µê³„ ì°¨íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (e) {
                debugAddLog('ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜: ' + e.message, 'error');
                showNotification('ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message, 'error');
            }
        }

        function normalizeGender(g) {
            if (!g) return 'ê¸°íƒ€/ë¯¸ìƒ';
            const s = String(g).trim();
            if (['ë‚¨','ë‚¨ì„±','M','m','male','Male'].includes(s)) return 'ë‚¨ì„±';
            if (['ì—¬','ì—¬ì„±','F','f','female','Female'].includes(s)) return 'ì—¬ì„±';
            return s;
        }

        function countBy(arr, keyFn) {
            const map = {};
            arr.forEach(item => {
                const k = keyFn(item);
                map[k] = (map[k] || 0) + 1;
            });
            return map;
        }

        function toMonth(d) {
            if (!d) return 'ë¯¸ìƒ';
            const s = String(d).slice(0,10);
            const parts = s.split('-');
            if (parts.length >= 2) {
                const y = parts[0];
                const m = parts[1];
                if (y && m) return y + '-' + m;
            }
            if (/^\d{6,8}$/.test(s)) {
                return s.slice(0,4) + '-' + s.slice(4,6);
            }
            return 'ë¯¸ìƒ';
        }

        function updateReportSummary(data) {
            const total = data.length;
            const g = countBy(data, it => normalizeGender(it.gender));
            const male = g['ë‚¨ì„±'] || 0;
            const female = g['ì—¬ì„±'] || 0;
            const completed = data.filter(it => (it.closureStatus === 'ì¢…ê²°')).length;
            const pct = (n, d) => d ? Math.round(n * 1000 / d)/10 : 0;
            const el = id => document.getElementById(id);
            if (el('summaryTotal')) el('summaryTotal').textContent = String(total);
            if (el('summaryMale')) el('summaryMale').textContent = pct(male, total) + '%';
            if (el('summaryFemale')) el('summaryFemale').textContent = pct(female, total) + '%';
            if (el('summaryCompleted')) el('summaryCompleted').textContent = pct(completed, total) + '%';
        }

        function renderBar(canvasId, labels, data, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: '', data: data, backgroundColor: color }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }

        function renderDoughnut(canvasId, labels, data, colors) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderLine(canvasId, labels, data, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '', data: data, fill: false, borderColor: color, backgroundColor: color, tension: 0.2 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }

        // ë°ì´í„° ê´€ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function updateDataStats() {
            try {
                const stats = generateStatistics();
                
                const totalEl = document.getElementById('totalReferrals');
                const completedEl = document.getElementById('completedReferrals');
                const progressingEl = document.getElementById('progressingReferrals');
                const avgAgeEl = document.getElementById('avgAge');
                
                if (totalEl) totalEl.textContent = stats.total;
                if (completedEl) completedEl.textContent = stats.status.completed;
                if (progressingEl) progressingEl.textContent = stats.status.progressing;
                if (avgAgeEl) avgAgeEl.textContent = Math.round(stats.avgAge) + 'ì„¸';
                
                debugAddLog('ë°ì´í„° í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('ë°ì´í„° í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function generateStatistics() {
            const stats = {
                total: referralDatabase.length,
                gender: { male: 0, female: 0 },
                age: { total: 0, count: 0 },
                teams: {},
                regions: {},
                counselors: {},
                actions: {},
                status: { progressing: 0, completed: 0 }
            };

            referralDatabase.forEach(item => {
                if (item.gender === 'ë‚¨ì„±') stats.gender.male++;
                else if (item.gender === 'ì—¬ì„±') stats.gender.female++;

                if (item.age > 0) {
                    stats.age.total += item.age;
                    stats.age.count++;
                }

                stats.teams[item.team] = (stats.teams[item.team] || 0) + 1;

                const region = item.region || 'ë¯¸ì§€ì •';
                stats.regions[region] = (stats.regions[region] || 0) + 1;

                stats.counselors[item.counselor] = (stats.counselors[item.counselor] || 0) + 1;

                const action = item.actionResult || 'ë¯¸ì§€ì •';
                stats.actions[action] = (stats.actions[action] || 0) + 1;

                if (item.closureStatus === 'ì¢…ê²°') stats.status.completed++;
                else stats.status.progressing++;
            });

            stats.avgAge = stats.age.count > 0 ? stats.age.total / stats.age.count : 0;

            return stats;
        }

        function downloadExcel() {
            try {
                debugAddLog('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘', 'info');
                showNotification('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                addLog('ğŸ“ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ìš”ì²­', 'info');
            } catch (error) {
                debugAddLog('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function downloadJSON() {
            try {
                debugAddLog('JSON ë°±ì—… ì‹œì‘', 'info');
                const backupData = {
                    systemInfo: {
                        name: 'ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ',
                        version: 'v2.2',
                        backupDate: new Date().toISOString(),
                        totalRecords: referralDatabase.length
                    },
                    statistics: generateStatistics(),
                    referralData: referralDatabase
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json; charset=utf-8'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `ì •ì‹ ê±´ê°•ì„¼í„°_ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                showNotification('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                debugAddLog('JSON ë°±ì—… ì„±ê³µ', 'info');
                addLog('ğŸ’¾ JSON ë°±ì—… ì™„ë£Œ: ' + link.download, 'success');
            } catch (error) {
                debugAddLog('JSON ë°±ì—… ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function downloadCSV() {
            try {
                debugAddLog('CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘', 'info');
                showNotification('CSV ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                addLog('ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ ìš”ì²­', 'info');
            } catch (error) {
                debugAddLog('CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê³„ì • ê´€ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function updateAccountsTable() {
            try {
                const tbody = document.getElementById('accountsTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                userDatabase.forEach(user => {
                    const row = document.createElement('tr');
                    
                    const roleNames = {
                        'admin': 'ìµœê³ ê´€ë¦¬ì',
                        'manager': 'ê´€ë¦¬ì',
                        'user': 'ì¼ë°˜ì‚¬ìš©ì'
                    };

                    const roleName = roleNames[user.role] || user.role;
                    const roleClass = user.role;

                    row.innerHTML = `
                        <td style="font-weight: 600;">${user.id}</td>
                        <td>${user.name}</td>
                        <td><span class="role-badge ${roleClass}">${roleName}</span></td>
                        <td>${user.createdDate}</td>
                        <td>${user.lastLogin}</td>
                        <td><span style="color: ${user.active ? '#059669' : '#ef4444'};">${user.active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
                        <td>
                            ${user.id !== 'admin' ? `
                                <button class="action-btn ${user.active ? 'delete' : 'edit'}" onclick="toggleUserStatus('${user.id}')">${user.active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}</button>
                                <button class="action-btn delete" onclick="deleteUser('${user.id}')">ì‚­ì œ</button>
                            ` : '<span style="color: #6b7280;">ì‹œìŠ¤í…œ ê³„ì •</span>'}
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                debugAddLog('ê³„ì • í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('ê³„ì • í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
        function addLog(message, type = 'info') {
            try {
                const logContainer = document.getElementById('activityLog');
                if (!logContainer) return;
                
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '8px';
                logEntry.style.padding = '4px 8px';
                logEntry.style.borderLeft = '3px solid #374151';
                logEntry.style.borderRadius = '4px';
                
                const typeColors = {
                    'success': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                    'error': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                    'warning': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                    'info': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' }
                };
                
                const colors = typeColors[type] || typeColors.info;
                logEntry.style.borderLeftColor = colors.border;
                logEntry.style.background = colors.bg;
                
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            } catch (error) {
                debugAddLog('ë¡œê·¸ ì¶”ê°€ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // DOM ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            try {
                debugAddLog('DOM ë¡œë“œ ì™„ë£Œ - ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘', 'info');
                
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // ìƒˆ ì˜ë¢°/ìˆ˜ì • í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const newReferralForm = document.getElementById('newReferralForm');
                if (newReferralForm) {
                    newReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        debugAddLog('ìƒˆ ì˜ë¢°/ìˆ˜ì • í¼ ì œì¶œ ì´ë²¤íŠ¸', 'info');
                        
                        if (editingReferralData) {
                            debugAddLog('ìˆ˜ì • ëª¨ë“œë¡œ í¼ ì œì¶œ', 'info');
                            // updateReferral();
                        } else {
                            debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë“œë¡œ í¼ ì œì¶œ', 'info');
                            // submitNewReferral();
                        }
                    });
                    debugAddLog('ìƒˆ ì˜ë¢°/ìˆ˜ì • í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ', 'info');
                }
                
                // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        const loginScreen = document.getElementById('loginScreen');
                        if (loginScreen && !loginScreen.classList.contains('hidden')) {
                            const activeElement = document.activeElement;
                            if (activeElement && (activeElement.id === 'username' || activeElement.id === 'password')) {
                                handleLogin();
                            }
                        }
                    }
                });
                
                debugAddLog('ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ v2.2 ì™„ì „ êµ¬í˜„ ì™„ë£Œ!', 'info');
                debugAddLog('âœ… ë¡œê·¸ì¸ ì˜¤ë¥˜ ìˆ˜ì •, ë””ë²„ê¹… ì‹œìŠ¤í…œ ê°œì„ , ê³„ì • ê´€ë¦¬ ì¶”ê°€', 'info');
                debugAddLog('ğŸ”§ ë””ë²„ê·¸ ì‹œìŠ¤í…œ ê°œì„  - ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€, ê´€ë¦¬ìë§Œ í™œì„±í™” ê°€ëŠ¥', 'info');
                
                setTimeout(() => {
                    debugAddLog('=== ì´ˆê¸° ì‹œìŠ¤í…œ ìƒíƒœ ===', 'info');
                    debugAddLog('ì˜ë¢° ë°ì´í„° ê°œìˆ˜: ' + referralDatabase.length, 'info');
                    debugAddLog('ì‚¬ìš©ì ê³„ì • ê°œìˆ˜: ' + userDatabase.length, 'info');
                    debugAddLog('í˜„ì¬ í™œì„± í˜ì´ì§€: ' + currentActivePage, 'info');
                }, 1000);
                
            } catch (error) {
                debugAddLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', function(event) {
            debugAddLog('ì „ì—­ ì˜¤ë¥˜ ë°œìƒ: ' + event.error.message, 'error');
            showNotification('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            debugAddLog('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€: ' + event.reason, 'error');
            showNotification('ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            event.preventDefault();
        });
    </script>
</body>
</html> 