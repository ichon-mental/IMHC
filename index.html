<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>의뢰 관리 대장 · OneDrive OAuth 연동 (MSAL.js)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #0b1220; color: #e6e8ee;}
    header { padding: 16px 20px; border-bottom: 1px solid #1b2746; position: sticky; top: 0; background: #0b1220; z-index: 10;}
    h1 { margin: 0; font-size: 18px; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .card { background: #0f1a36; border: 1px solid #1b2746; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    button, input[type=file]::file-selector-button {
      background: #2153f3; color: white; border: 0; padding: 10px 14px; border-radius: 10px; cursor: pointer;
    }
    button.secondary { background:#1b2746; color:#cfe1ff; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    code { background:#091126; padding:2px 6px; border-radius:6px; border:1px solid #1b2746;}
    a { color: #9ec1ff; }
    #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#081024; border-radius:10px; padding:10px; border:1px solid #1b2746; max-height: 240px; overflow:auto;}
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #1b2746; padding: 8px; font-size: 14px; }
    th { text-align: left; color:#a7b7df; }
    .muted { color:#94a3b8; font-size: 13px; }
    .pill { display:inline-block; background:#13214b; border:1px solid #1b2746; padding: 2px 8px; border-radius: 999px; font-size: 12px;}
  </style>
  <!-- MSAL Browser (supports Auth Code Flow with PKCE) -->
  <script src="https://alcdn.msauth.net/browser/2.38.4/js/msal-browser.min.js" integrity="sha384-Zr1hGhTuD86I1I3xT4d5wgk6DZzK2KuqKM1eXarAM8i8Y4b2cK8m3Mxi1q+0qYgU" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1>의뢰 관리 대장 · OneDrive OAuth 연동 (서버 없음)</h1>
  </header>

  <div class="container">

    <div class="card">
      <div class="row">
        <div class="col">
          <h3 style="margin-top:0">1) 앱 설정 (필수)</h3>
          <div class="muted">
            아래 설정에서 <b>CLIENT_ID</b>와 <b>TENANT</b>, <b>REDIRECT_URI</b>를 채우세요.<br/>
            Azure Portal → App registrations → SPA → Redirect URI에 <code>이 파일의 배포 URL</code>을 추가해야 합니다.<br/>
            권한: Microsoft Graph <code>Files.ReadWrite</code>, <code>offline_access</code>.
          </div>
          <div class="pill" id="configuredFlag">미설정</div>
          <div style="margin-top:10px">
            <div>CLIENT_ID: <code id="cidDisplay"></code></div>
            <div>TENANT: <code id="tenantDisplay"></code></div>
            <div>REDIRECT_URI: <code id="redirectDisplay"></code></div>
          </div>
        </div>
        <div class="col">
          <h3 style="margin-top:0">2) 로그인</h3>
          <button id="btnLogin">Microsoft 로그인</button>
          <button id="btnLogout" class="secondary" disabled>로그아웃</button>
          <div style="margin-top:10px" class="muted">로그인 후 OneDrive 파일 목록/업로드 기능 활성화</div>
          <div id="acct" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">OneDrive 작업</h3>
      <div class="row">
        <div class="col">
          <button id="btnList" disabled>루트 파일 목록</button>
          <div style="margin-top:10px">
            <table id="filesTable" style="display:none">
              <thead><tr><th>이름</th><th>크기</th><th>웹 링크</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="col">
          <div style="margin-bottom:8px" class="muted">/data/requests.json (업무 데이터) 관리</div>
          <button id="btnDownload" disabled>download requests.json</button>
          <div style="margin-top:8px">
            <input type="file" id="fileInput" accept=".json" />
            <button id="btnUpload" disabled>upload/replace requests.json</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">로그</h3>
      <div id="log"></div>
    </div>

  </div>

<script>
/** ====== 0) 여기를 설정하세요 ====== */
// 필수: Azure AD App Registration에서 발급받은 Application (client) ID
const CLIENT_ID = "PUT-YOUR-CLIENT-ID-HERE";

// 선택: 특정 테넌트만 허용하려면 테넌트 ID 또는 도메인 사용. 누구나 허용은 "common".
const TENANT = "common"; // 예: "organizations", "consumers", "YOUR-TENANT-ID-GUID", "common"

// SPA Redirect URI (Azure의 앱 등록에 추가되어 있어야 함). 기본은 현재 페이지 URL.
const REDIRECT_URI = window.location.origin + window.location.pathname;

/** =================================== */

const scopes = ["Files.ReadWrite", "offline_access"];
const logging = (msg, obj) => {
  const el = document.getElementById("log");
  const time = new Date().toLocaleTimeString();
  el.textContent += `[${time}] ${msg}` + (obj ? " " + JSON.stringify(obj, null, 2) : "") + "\\n";
  el.scrollTop = el.scrollHeight;
};

const configured = CLIENT_ID && CLIENT_ID !== "PUT-YOUR-CLIENT-ID-HERE";
document.getElementById("cidDisplay").textContent = CLIENT_ID;
document.getElementById("tenantDisplay").textContent = TENANT;
document.getElementById("redirectDisplay").textContent = REDIRECT_URI;
document.getElementById("configuredFlag").textContent = configured ? "설정됨" : "미설정";
if (configured) { document.getElementById("configuredFlag").style.background = "#0b3"; }

const msalConfig = {
  auth: {
    clientId: CLIENT_ID,
    authority: `https://login.microsoftonline.com/${TENANT}`,
    redirectUri: REDIRECT_URI,
    navigateToLoginRequestUrl: true
  },
  cache: {
    cacheLocation: "localStorage", // 토큰 캐시
    storeAuthStateInCookie: false
  },
  system: { loggerOptions: { loggerCallback: (level, message) => {} } }
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
let account = null;

// Redirect 처리 (Auth Code Flow)
msalInstance.handleRedirectPromise().then((resp) => {
  if (resp && resp.account) {
    account = resp.account;
    msalInstance.setActiveAccount(account);
    onLoginStateChanged();
    logging("Redirect 로그인 완료", { username: account.username });
  } else {
    const saved = msalInstance.getActiveAccount();
    if (saved) {
      account = saved;
      onLoginStateChanged();
      logging("세션 복원", { username: account.username });
    }
  }
}).catch((err) => {
  logging("Redirect 처리 오류", err);
});

function onLoginStateChanged() {
  const loggedIn = !!account;
  document.getElementById("btnLogout").disabled = !loggedIn;
  document.getElementById("btnList").disabled = !loggedIn;
  document.getElementById("btnDownload").disabled = !loggedIn;
  document.getElementById("btnUpload").disabled = !loggedIn;
  const acctEl = document.getElementById("acct");
  acctEl.innerHTML = loggedIn
    ? `<div class="pill">로그인됨</div><div class="muted" style="margin-top:6px">${account.username}</div>`
    : `<div class="pill" style="background:#6b0000">로그아웃됨</div>`;
}

async function login() {
  if (!configured) { alert("CLIENT_ID를 설정하세요."); return; }
  try {
    // 팝업 로그인 (Redirect 원하면 loginRedirect 사용)
    const resp = await msalInstance.loginPopup({ scopes });
    account = resp.account;
    msalInstance.setActiveAccount(account);
    onLoginStateChanged();
    logging("로그인 성공", { username: account.username });
  } catch (e) {
    logging("로그인 실패", e);
    alert("로그인 실패: " + (e.errorMessage || e.message || e));
  }
}

async function logout() {
  try {
    await msalInstance.logoutPopup({ account });
    account = null;
    onLoginStateChanged();
    logging("로그아웃 완료");
  } catch (e) {
    logging("로그아웃 오류", e);
  }
}

async function acquireToken() {
  if (!account) throw new Error("로그인 필요");
  try {
    const resp = await msalInstance.acquireTokenSilent({ scopes, account });
    return resp.accessToken;
  } catch (e) {
    logging("Silent 토큰 실패, popup 시도", e);
    const resp = await msalInstance.acquireTokenPopup({ scopes });
    return resp.accessToken;
  }
}

async function graphFetch(endpoint, init = {}) {
  const token = await acquireToken();
  const headers = Object.assign({}, init.headers || {}, {
    "Authorization": "Bearer " + token
  });
  const res = await fetch("https://graph.microsoft.com/v1.0" + endpoint, { ...init, headers });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`Graph 오류 ${res.status}: ${text}`);
  }
  // JSON 응답 아닌 경우도 있으니 content-type 확인
  const ct = res.headers.get("content-type") || "";
  return ct.includes("application/json") ? res.json() : res.blob();
}

// 파일 목록
async function listRoot() {
  try {
    const data = await graphFetch("/me/drive/root/children?$top=50");
    const tbody = document.querySelector("#filesTable tbody");
    tbody.innerHTML = "";
    (data.value || []).forEach(it => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.name}</td>
        <td>${(it.size || 0).toLocaleString()} B</td>
        <td>${it.webUrl ? `<a href="${it.webUrl}" target="_blank">열기</a>` : ""}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById("filesTable").style.display = "table";
    logging("루트 파일 목록 로드", { count: (data.value || []).length });
  } catch (e) {
    logging("파일 목록 오류", e);
    alert("파일 목록 실패: " + e.message);
  }
}

// requests.json 다운로드 (없으면 404)
async function downloadRequests() {
  try {
    // /root:/data/requests.json:/content 로 직접 바이너리 GET
    const token = await acquireToken();
    const url = "https://graph.microsoft.com/v1.0/me/drive/root:/data/requests.json:/content";
    const res = await fetch(url, { headers: { Authorization: "Bearer " + token } });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`다운로드 실패 ${res.status}: ${text}`);
    }
    const blob = await res.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "requests.json";
    a.click();
    logging("requests.json 다운로드 완료");
  } catch (e) {
    logging("다운로드 오류", e);
    alert("다운로드 실패: " + e.message);
  }
}

// requests.json 업로드/교체
async function uploadRequests() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) { alert("업로드할 JSON 파일을 선택하세요."); return; }
  try {
    const token = await acquireToken();
    const url = "https://graph.microsoft.com/v1.0/me/drive/root:/data/requests.json:/content";
    // PUT으로 업로드 (폴더 data가 없으면 자동 생성되지 않을 수 있어 사전 생성 절차 권장)
    // 여기서는 그대로 시도하고, 실패하면 폴더 생성 후 재시도
    let res = await fetch(url, {
      method: "PUT",
      headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
      body: await file.text()
    });
    if (res.status === 404) {
      // data 폴더 없으면 생성
      logging("data 폴더 없음 → 생성 시도");
      await graphFetch("/me/drive/root/children", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: "data", folder: {}, "@microsoft.graph.conflictBehavior": "fail" })
      }).catch(() => {});
      // 재시도
      res = await fetch(url, {
        method: "PUT",
        headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
        body: await file.text()
      });
    }
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`업로드 실패 ${res.status}: ${text}`);
    }
    logging("requests.json 업로드/교체 완료");
    alert("업로드 완료");
  } catch (e) {
    logging("업로드 오류", e);
    alert("업로드 실패: " + e.message);
  }
}

document.getElementById("btnLogin").addEventListener("click", login);
document.getElementById("btnLogout").addEventListener("click", logout);
document.getElementById("btnList").addEventListener("click", listRoot);
document.getElementById("btnDownload").addEventListener("click", downloadRequests);
document.getElementById("btnUpload").addEventListener("click", uploadRequests);

</script>
</body>
</html>
