<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° - OneDrive í†µí•© ì‹œìŠ¤í…œ v2.1</title>
    
    <!-- Chart.js & SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --nas-color: #1976d2;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-nas: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ìƒíƒœë°” ìŠ¤íƒ€ì¼ */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            font-size: 13px;
            z-index: 9999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--gradient-primary);
        }

        .login-container.hidden {
            display: none !important;
        }

        .login-box {
            background: var(--gradient-card);
            padding: 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 700;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ */
        .app-container {
            display: flex;
            height: 100vh;
            padding-top: 50px;
            background: var(--gradient-primary);
        }

        .app-container.hidden {
            display: none !important;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background: var(--gradient-card);
        }

        .sidebar-header h2 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .user-info {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-menu {
            padding: 24px 0;
        }

        .nav-item {
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: white !important;
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        .nav-link .icon {
            margin-right: 16px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            transition: color 0.3s ease;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            background: rgba(248, 250, 252, 0.8);
            overflow-y: auto;
            min-height: calc(100vh - 50px);
        }

        .page {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - 50px);
            display: block;
        }

        .page.hidden {
            display: none !important;
        }

        .dashboard-container {
            padding: 40px;
            min-height: calc(100vh - 130px);
            background: transparent;
        }

        /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            background: white;
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            z-index: 10001;
            max-width: 450px;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        /* ìœ„ì ¯ ìŠ¤íƒ€ì¼ */
        .widget {
            background: var(--gradient-card);
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .widget-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .widget-icon {
            font-size: 28px;
            color: var(--primary-color);
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--gradient-card);
            padding: 32px 28px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1;
        }

        .stat-number.urgent {
            color: var(--danger-color);
        }

        .stat-number.normal {
            color: var(--primary-color);
        }

        .stat-number.completed {
            color: var(--success-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
        }

        /* ìƒˆ ì˜ë¢° ë²„íŠ¼ */
        .new-referral-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            white-space: nowrap;
            min-width: 140px;
        }

        .new-referral-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* íŒ€ íƒ­ ìŠ¤íƒ€ì¼ */
        .team-tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .chart-data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .chart-item {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chart-item-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .chart-item-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .chart-item-percentage {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            margin-top: 24px;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }

        .table-container thead tr {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .table-container th {
            padding: 20px 12px;
            border-bottom: 3px solid #e5e7eb;
            text-align: left;
            font-weight: 800;
            color: #1f2937;
            font-size: 13px;
        }

        .table-container td {
            padding: 15px 12px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
        }

        .table-container tbody tr:hover {
            background: #f9fafb;
        }

        .action-btn {
            padding: 6px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .action-btn.view {
            background: #6b7280;
        }

        .action-btn.edit {
            background: #059669;
        }

        .action-btn.delete {
            background: #ef4444;
        }

        /* ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-badge.processing {
            background: #f59e0b;
        }

        .status-badge.completed {
            background: #059669;
        }

        .status-badge.urgent {
            background: #dc2626;
        }

        .status-badge.excluded {
            background: #6b7280;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* í¼ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .form-section {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 700;
        }

        .form-section.basic-info {
            background: #f8f9fa;
        }

        .form-section.referral-info {
            background: #fff7ed;
        }

        .form-section.referral-type {
            background: #f0f9ff;
        }

        .form-section.diagnosis-info {
            background: #fef3c7;
        }

        .form-section.content-info {
            background: #f3f4f6;
        }

        /* ë””ë²„ê¹… íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10002;
            background: #1f2937;
            color: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 400px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid #374151;
        }

        .debug-panel.hidden {
            display: none;
        }

        .debug-panel h4 {
            color: #10b981;
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 700;
        }

        .debug-info {
            margin-bottom: 8px;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
            border-radius: 4px;
        }

        .debug-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10003;
            background: #374151;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .debug-toggle:hover {
            background: #4b5563;
        }

        /* ìˆ¨ê¹€ í´ë˜ìŠ¤ */
        .hidden {
            display: none !important;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .dashboard-container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="notificationContainer" style="position: fixed; top: 80px; right: 24px; z-index: 10001;"></div>
    
    <!-- ìƒíƒœ ë°” -->
    <div class="status-bar">
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <span>ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ v2.1</span>
            <span style="margin-left: 16px; font-size: 11px; opacity: 0.8;">|</span>
            <span style="margin-left: 8px; font-size: 11px;">
                <span style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>ğŸ’¾</span>
                    <span>ë¡œì»¬ ì €ì¥ + ë””ë²„ê¹…</span>
                </span>
            </span>
        </div>
        <div>
            <span>ì ‘ì†ì: <span id="onlineCount">1</span>ëª… | <span id="currentTime"></span></span>
        </div>
    </div>

    <!-- ë””ë²„ê¹… í† ê¸€ ë²„íŠ¼ -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">ğŸ› ë””ë²„ê·¸</button>

    <!-- ë””ë²„ê¹… íŒ¨ë„ -->
    <div id="debugPanel" class="debug-panel hidden">
        <h4>ğŸ”§ ì‹œìŠ¤í…œ ë””ë²„ê·¸ ì •ë³´</h4>
        <div id="debugContent">
            <div class="debug-info">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="debugSystemStatus()" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">ìƒíƒœ ì²´í¬</button>
            <button onclick="clearDebugLog()" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 4px;">ë¡œê·¸ í´ë¦¬ì–´</button>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸ¥ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</h1>
                <p>ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ v2.1 (ë””ë²„ê¹… ê°•í™”)</p>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label for="username">ì‚¬ìš©ì ID</label>
                    <input type="text" id="username" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="admin" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="1234" autocomplete="current-password">
                </div>
                <button class="btn" onclick="handleLogin()" id="loginBtn">ë¡œê·¸ì¸</button>
                
                <div style="text-align: center; margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                    <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                        ğŸ”§ <strong>v2.1 ì—…ë°ì´íŠ¸</strong><br>
                        â€¢ ë””ë²„ê¹… ì‹œìŠ¤í…œ ê°•í™”<br>
                        â€¢ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ ìˆ˜ì •<br>
                        â€¢ ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ì˜ë¢° ëª¨ë‹¬ -->
    <div id="newReferralModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ¥ ìƒˆ ì˜ë¢° ì ‘ìˆ˜</h2>
                <button class="modal-close" onclick="closeNewReferralModal()">Ã—</button>
            </div>
            
            <form id="newReferralForm">
                <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section basic-info">
                    <h3>ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì´ë¦„ *</label>
                            <input type="text" id="referrerName" required placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>ì„±ë³„ *</label>
                            <select id="referrerGender" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ì´ *</label>
                            <input type="number" id="referrerAge" required min="0" max="120" placeholder="ì˜ˆ: 35">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ë‚ ì§œ *</label>
                            <input type="date" id="referralDate" required>
                        </div>
                        <div class="form-group">
                            <label>ì§€ì—­</label>
                            <input type="text" id="region" placeholder="ì˜ˆ: ì´ì²œì‹œ ì°½ì „ë™" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹ì</label>
                            <input type="text" id="assignedCounselor" placeholder="ë‹´ë‹¹ ìƒë‹´ì‚¬ëª…" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- ì˜ë¢° ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section referral-info">
                    <h3>ğŸ“‹ ì˜ë¢° ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì˜ë¢°ê²½ë¡œ</label>
                            <input type="text" id="referralPath" placeholder="ì˜ë¢° ê²½ë¡œ" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ê¸°ê´€ *</label>
                            <select id="referringAgency" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°">ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°</option>
                                <option value="ì´ì²œì‹œì²­">ì´ì²œì‹œì²­</option>
                                <option value="ê²½ì°°ì„œ">ê²½ì°°ì„œ</option>
                                <option value="ì†Œë°©">ì†Œë°©</option>
                                <option value="ì˜ë£Œê¸°ê´€">ì˜ë£Œê¸°ê´€</option>
                                <option value="ì •ì‹ ë³´ê±´ê¸°ê´€">ì •ì‹ ë³´ê±´ê¸°ê´€</option>
                                <option value="ë³´ê±´ì†Œ">ë³´ê±´ì†Œ</option>
                                <option value="ê°€ì¡±">ê°€ì¡±</option>
                                <option value="ì§€ì¸">ì§€ì¸</option>
                                <option value="ì§€ì—­ì‚¬íšŒ">ì§€ì—­ì‚¬íšŒ</option>
                                <option value="ë³µì§€ê´€">ë³µì§€ê´€</option>
                                <option value="í•™êµ">í•™êµ</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                <option value="1393/129">1393/129</option>
                                <option value="ë³¸ì¸">ë³¸ì¸</option>
                                <option value="ì´ë™ìƒë‹´">ì´ë™ìƒë‹´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹íŒ€ *</label>
                            <select id="assignedTeam" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                                <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                                <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                                <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CRI</label>
                            <input type="text" id="criInfo" placeholder="CRI ì •ë³´" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- ì˜ë¢° ìœ í˜• ì„¹ì…˜ -->
                <div class="form-section referral-type">
                    <h3>ğŸ“‹ ì˜ë¢° ìœ í˜•</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <input type="checkbox" id="diagnosisProtectionRequest" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ì§„ë‹¨ ë³´í˜¸ìš”ì²­</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <input type="checkbox" id="writtenReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ì„œë©´ì˜ë¢°</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <input type="checkbox" id="phoneReferral" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ìœ ì„ ì˜ë¢°</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <input type="checkbox" id="policeInvolvement" style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: #1f2937;">ê²½ì°°ê°œì…ì—¬ë¶€</span>
                        </label>
                    </div>
                </div>

                <!-- ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section diagnosis-info">
                    <h3>ğŸ¥ ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì§„ë‹¨ëª…</label>
                            <input type="text" id="diagnosis" placeholder="ì˜ˆ: ìš°ìš¸ì¦, ì¡°í˜„ë³‘ ë“±" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ì¡°ì¹˜ê²°ê³¼</label>
                            <select id="actionResult">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)">ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)</option>
                                <option value="ì§€ì†ìƒë‹´">ì§€ì†ìƒë‹´</option>
                                <option value="ì¹˜ë£Œì—°ê³„">ì¹˜ë£Œì—°ê³„</option>
                                <option value="ì„œë¹„ìŠ¤ ì—°ê³„">ì„œë¹„ìŠ¤ ì—°ê³„</option>
                                <option value="ê¸°íƒ€ì¡°ì¹˜">ê¸°íƒ€ì¡°ì¹˜</option>
                                <option value="ì •ë³´ì œê³µ">ì •ë³´ì œê³µ</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì²˜ë¦¬ì¤‘">ì²˜ë¦¬ì¤‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì¢…ê²°ì—¬ë¶€</label>
                            <select id="closureStatus">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸">ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸</option>
                                <option value="ë¯¸ë“±ë¡ì ì¢…ê²°">ë¯¸ë“±ë¡ì ì¢…ê²°</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ìƒì„¸ ë‚´ìš© ì„¹ì…˜ -->
                <div class="form-section content-info">
                    <h3>ğŸ“ ìƒì„¸ ë‚´ìš©</h3>
                    <div class="form-group">
                        <label>ê°œì…ë‚´ìš©/í˜„ìƒí™© *</label>
                        <textarea id="interventionContent" required style="min-height: 150px; resize: vertical; font-family: 'Malgun Gothic', sans-serif; line-height: 1.6;" placeholder="í˜„ì¬ ìƒí™©, ê°œì… ë‚´ìš©, ì¦ìƒì˜ êµ¬ì²´ì  ë‚´ìš© ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ í•´ì£¼ì„¸ìš”." maxlength="5000"></textarea>
                    </div>
                </div>

                <!-- íšŒì‹  ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section" style="background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); border: 2px solid #64748b;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 24px;">ğŸ“¬</span>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 700;">íšŒì‹  ì •ë³´</h3>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 700; color: #1f2937; font-size: 15px;">íšŒì‹ ì—¬ë¶€ ë° ë‚´ìš©</label>
                        <textarea id="responseRequired" style="min-height: 80px; resize: vertical; border: 2px solid #cbd5e1; font-family: 'Malgun Gothic', sans-serif;" placeholder="íšŒì‹ ì´ í•„ìš”í•œ ê²½ìš° êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." maxlength="1000"></textarea>
                    </div>
                </div>
                
                <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" onclick="closeNewReferralModal()" style="padding: 14px 28px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì·¨ì†Œ</button>
                    <button type="button" onclick="saveDraftReferral()" style="padding: 14px 28px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì„ì‹œì €ì¥</button>
                    <button type="submit" style="padding: 14px 28px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì ‘ìˆ˜ ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì˜ë¢° ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="referralDetailModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì˜ë¢° ìƒì„¸ë³´ê¸°</h2>
                <button class="modal-close" onclick="closeReferralDetailModal()">Ã—</button>
            </div>
            
            <div id="referralDetailContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px;">
                <button onclick="closeReferralDetailModal()" style="padding: 12px 24px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
                <button id="editCurrentReferralBtn" onclick="editCurrentReferral()" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <!-- ì˜ë¢° ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editReferralModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">âœï¸ ì˜ë¢° ìˆ˜ì •</h2>
                <button class="modal-close" onclick="closeEditReferralModal()">Ã—</button>
            </div>
            
            <form id="editReferralForm">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="form-section basic-info">
                    <h3>ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì˜ë¢°ë²ˆí˜¸</label>
                            <input type="text" id="editRefNo" readonly style="background: #f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label>ì´ë¦„ *</label>
                            <input type="text" id="editReferrerName" required maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>ì„±ë³„ *</label>
                            <select id="editReferrerGender" required>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ì´ *</label>
                            <input type="number" id="editReferrerAge" required min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ë‚ ì§œ *</label>
                            <input type="date" id="editReferralDate" required>
                        </div>
                        <div class="form-group">
                            <label>ì§€ì—­</label>
                            <input type="text" id="editRegion" maxlength="100">
                        </div>
                    </div>
                </div>

                <!-- ì˜ë¢° ì •ë³´ -->
                <div class="form-section referral-info">
                    <h3>ğŸ“‹ ì˜ë¢° ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì˜ë¢°ê²½ë¡œ</label>
                            <input type="text" id="editReferralPath" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ì˜ë¢°ê¸°ê´€ *</label>
                            <select id="editReferringAgency" required>
                                <option value="ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°">ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°</option>
                                <option value="ì´ì²œì‹œì²­">ì´ì²œì‹œì²­</option>
                                <option value="ê²½ì°°ì„œ">ê²½ì°°ì„œ</option>
                                <option value="ì†Œë°©">ì†Œë°©</option>
                                <option value="ì˜ë£Œê¸°ê´€">ì˜ë£Œê¸°ê´€</option>
                                <option value="ì •ì‹ ë³´ê±´ê¸°ê´€">ì •ì‹ ë³´ê±´ê¸°ê´€</option>
                                <option value="ë³´ê±´ì†Œ">ë³´ê±´ì†Œ</option>
                                <option value="ê°€ì¡±">ê°€ì¡±</option>
                                <option value="ì§€ì¸">ì§€ì¸</option>
                                <option value="ì§€ì—­ì‚¬íšŒ">ì§€ì—­ì‚¬íšŒ</option>
                                <option value="ë³µì§€ê´€">ë³µì§€ê´€</option>
                                <option value="í•™êµ">í•™êµ</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                <option value="1393/129">1393/129</option>
                                <option value="ë³¸ì¸">ë³¸ì¸</option>
                                <option value="ì´ë™ìƒë‹´">ì´ë™ìƒë‹´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹íŒ€ *</label>
                            <select id="editAssignedTeam" required>
                                <option value="ì¦ì§„íŒ€">ì¦ì§„íŒ€</option>
                                <option value="íšŒë³µíŒ€">íšŒë³µíŒ€</option>
                                <option value="ìì‚´ì˜ˆë°©ì„¼í„°">ìì‚´ì˜ˆë°©ì„¼í„°</option>
                                <option value="ì•„ë™ì²­ì†Œë…„">ì•„ë™ì²­ì†Œë…„</option>
                                <option value="ë‚¨ë¶€ë¶„ì†Œ">ë‚¨ë¶€ë¶„ì†Œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹ì</label>
                            <input type="text" id="editCounselor" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>CRI</label>
                            <input type="text" id="editCriInfo" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´ -->
                <div class="form-section diagnosis-info">
                    <h3>ğŸ¥ ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>ì§„ë‹¨ëª…</label>
                            <input type="text" id="editDiagnosis" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>ì¡°ì¹˜ê²°ê³¼</label>
                            <select id="editActionResult">
                                <option value="ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)">ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)</option>
                                <option value="ì§€ì†ìƒë‹´">ì§€ì†ìƒë‹´</option>
                                <option value="ì¹˜ë£Œì—°ê³„">ì¹˜ë£Œì—°ê³„</option>
                                <option value="ì„œë¹„ìŠ¤ ì—°ê³„">ì„œë¹„ìŠ¤ ì—°ê³„</option>
                                <option value="ê¸°íƒ€ì¡°ì¹˜">ê¸°íƒ€ì¡°ì¹˜</option>
                                <option value="ì •ë³´ì œê³µ">ì •ë³´ì œê³µ</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì²˜ë¦¬ì¤‘">ì²˜ë¦¬ì¤‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì¢…ê²°ì—¬ë¶€ *</label>
                            <select id="editClosureStatus" required>
                                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                                <option value="ì¢…ê²°">ì¢…ê²°</option>
                                <option value="ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸">ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸</option>
                                <option value="ë¯¸ë“±ë¡ì ì¢…ê²°">ë¯¸ë“±ë¡ì ì¢…ê²°</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ê°œì…ë‚´ìš© ì„¹ì…˜ -->
                <div class="form-section content-info">
                    <h3>ğŸ“ ê°œì…ë‚´ìš©/í˜„ìƒí™©</h3>
                    <div class="form-group">
                        <label>ê°œì…ë‚´ìš©/í˜„ìƒí™© *</label>
                        <textarea id="editInterventionContent" required style="min-height: 150px; resize: vertical; font-family: 'Malgun Gothic', sans-serif; line-height: 1.6;" placeholder="í˜„ì¬ ìƒí™©, ê°œì… ë‚´ìš©, ì¦ìƒì˜ êµ¬ì²´ì  ë‚´ìš© ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ í•´ì£¼ì„¸ìš”." maxlength="5000"></textarea>
                    </div>
                </div>
                
                <!-- íšŒì‹  ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section" style="background: #f0f4f8;">
                    <h3>ğŸ“¬ íšŒì‹  ì •ë³´</h3>
                    <div class="form-group">
                        <label>íšŒì‹ ì—¬ë¶€ ë° ë‚´ìš©</label>
                        <textarea id="editResponseRequired" style="min-height: 80px; resize: vertical; border: 2px solid #cbd5e1; font-family: 'Malgun Gothic', sans-serif;" placeholder="íšŒì‹ ì´ í•„ìš”í•œ ê²½ìš° êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." maxlength="1000"></textarea>
                    </div>
                </div>
                
                <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                <div style="display: flex; gap: 12px; justify-content: end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" onclick="closeEditReferralModal()" style="padding: 14px 28px; background: #f3f4f6; color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ì·¨ì†Œ</button>
                    <button type="button" onclick="handleSaveEditedReferral()" id="saveEditedReferralBtn" style="padding: 14px 28px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">ğŸ’¾ ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div id="mainApp" class="app-container hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</h2>
                <div class="user-info">
                    <div id="currentUserName">ì‹œìŠ¤í…œê´€ë¦¬ì</div>
                    <div id="currentUserRole">ê´€ë¦¬ì</div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item">
                    <div class="nav-link active" onclick="showPage('referrals')">
                        <span class="icon">ğŸ‘¥</span>
                        ì˜ë¢° ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('data')">
                        <span class="icon">ğŸ’¾</span>
                        ë°ì´í„° ê´€ë¦¬
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-link" onclick="showPage('reports')">
                        <span class="icon">ğŸ“ˆ</span>
                        í†µê³„/ë³´ê³ ì„œ
                    </div>
                </div>
                <div class="nav-item" style="margin-top: 30px;">
                    <div class="nav-link" onclick="handleLogout()" style="color: var(--danger-color);">
                        <span class="icon">ğŸšª</span>
                        ë¡œê·¸ì•„ì›ƒ
                    </div>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <main class="main-content">
            <!-- ì˜ë¢° ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="referralsPage" class="page">
                <div class="dashboard-container">
                    <!-- í˜ì´ì§€ í—¤ë” -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding: 32px 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: var(--shadow); flex-wrap: wrap; gap: 20px;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">ì˜ë¢° ê´€ë¦¬</h1>
                        <button class="new-referral-btn" onclick="openNewReferralModal()">
                            <span>â•</span>
                            ìƒˆ ì˜ë¢° ì ‘ìˆ˜
                        </button>
                    </div>
                    
                    <!-- íŒ€ë³„ íƒ­ ì‹œìŠ¤í…œ -->
                    <div class="team-management-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 32px; text-align: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">
                        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 800;">ğŸ¥ íŒ€ë³„ ì˜ë¢° ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                        <p style="margin: 0; font-size: 16px; opacity: 0.9;">ê° íŒ€ë³„ë¡œ ì˜ë¢°ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ì¶”ì í•˜ì„¸ìš”</p>
                    </div>
                    
                    <!-- íŒ€ ì„ íƒ íƒ­ -->
                    <div class="team-tabs-container" style="margin-bottom: 32px;">
                        <div class="team-tabs-wrapper" style="background: white; border-radius: 20px; padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 2px solid #e5e7eb;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 20px; font-weight: 700;">íŒ€ ì„ íƒ</h3>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">ë³´ê³  ì‹¶ì€ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            </div>
                            
                            <div id="teamTabsGrid" class="team-tabs-grid">
                                <div class="chart-data-display">
                                    <div class="chart-item" onclick="selectTeam('all')" style="cursor: pointer;" data-team="all">
                                        <div class="chart-item-value">ğŸ“Š</div>
                                        <div class="chart-item-label">ì „ì²´ íŒ€</div>
                                        <div class="chart-item-percentage" id="allTeamCount">5ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ì¦ì§„íŒ€')" style="cursor: pointer;" data-team="ì¦ì§„íŒ€">
                                        <div class="chart-item-value">ğŸ¯</div>
                                        <div class="chart-item-label">ì¦ì§„íŒ€</div>
                                        <div class="chart-item-percentage" id="team1Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('íšŒë³µíŒ€')" style="cursor: pointer;" data-team="íšŒë³µíŒ€">
                                        <div class="chart-item-value">ğŸŒ±</div>
                                        <div class="chart-item-label">íšŒë³µíŒ€</div>
                                        <div class="chart-item-percentage" id="team2Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ìì‚´ì˜ˆë°©ì„¼í„°')" style="cursor: pointer;" data-team="ìì‚´ì˜ˆë°©ì„¼í„°">
                                        <div class="chart-item-value">ğŸš¨</div>
                                        <div class="chart-item-label">ìì‚´ì˜ˆë°©ì„¼í„°</div>
                                        <div class="chart-item-percentage" id="team3Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ì•„ë™ì²­ì†Œë…„')" style="cursor: pointer;" data-team="ì•„ë™ì²­ì†Œë…„">
                                        <div class="chart-item-value">ğŸ‘¶</div>
                                        <div class="chart-item-label">ì•„ë™ì²­ì†Œë…„</div>
                                        <div class="chart-item-percentage" id="team4Count">1ê±´</div>
                                    </div>
                                    <div class="chart-item" onclick="selectTeam('ë‚¨ë¶€ë¶„ì†Œ')" style="cursor: pointer;" data-team="ë‚¨ë¶€ë¶„ì†Œ">
                                        <div class="chart-item-value">ğŸ¢</div>
                                        <div class="chart-item-label">ë‚¨ë¶€ë¶„ì†Œ</div>
                                        <div class="chart-item-percentage" id="team5Count">1ê±´</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í˜„ì¬ íŒ€ ì •ë³´ -->
                    <div id="currentTeamInfo" class="current-team-info">
                        <div style="background: linear-gradient(135deg, #f9fafb, white); border: 3px solid #6b7280; border-radius: 16px; padding: 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="font-size: 56px;" id="currentTeamIcon">ğŸ“Š</div>
                                <div>
                                    <h3 style="margin: 0; color: #6b7280; font-size: 24px; font-weight: 800;" id="currentTeamTitle">ì „ì²´ íŒ€ ì˜ë¢° ëª©ë¡</h3>
                                    <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 16px;" id="currentTeamDesc">ëª¨ë“  íŒ€ì˜ ì˜ë¢°ë¥¼ í†µí•© ê´€ë¦¬</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 48px; font-weight: 900; color: #6b7280;" id="currentTeamCount">5</div>
                                <div style="font-size: 16px; color: #6b7280; font-weight: 600;">ì´ ì˜ë¢° ê±´ìˆ˜</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì˜ë¢° ëª©ë¡ ìœ„ì ¯ -->
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ì˜ë¢° ëª©ë¡</h3>
                            <span class="widget-icon">ğŸ“‹</span>
                        </div>
                        <div id="referralsList">
                            <div class="table-container">
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ì˜ë¢°ë²ˆí˜¸</th>
                                                <th>ì´ë¦„</th>
                                                <th>ì„±ë³„/ë‚˜ì´</th>
                                                <th>ì˜ë¢°ë‚ ì§œ</th>
                                                <th>ì˜ë¢°ê¸°ê´€</th>
                                                <th>ë‹´ë‹¹íŒ€</th>
                                                <th>ë‹´ë‹¹ì</th>
                                                <th>ì§„ë‹¨ëª…</th>
                                                <th>ì¡°ì¹˜ê²°ê³¼</th>
                                                <th>ì¢…ê²°ì—¬ë¶€</th>
                                                <th style="text-align: center;">ì‘ì—…</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referralsTableBody">
                                            <!-- ê¸°ë³¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°ì´í„° ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="dataPage" class="page hidden">
                <div class="dashboard-container">
                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow-lg); text-align: center;">
                        <h1 style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 32px; font-weight: 800; margin-bottom: 12px;">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h1>
                        <p style="color: var(--text-secondary); font-size: 16px;">ë°ì´í„° ë°±ì—…, ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë° íŒŒì¼ ê´€ë¦¬</p>
                    </div>

                    <!-- ë°ì´í„° ë‚´ë³´ë‚´ê¸° -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">ğŸ“Š</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <button onclick="downloadExcel()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: #059669; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>ğŸ“ˆ</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (.xlsx)
                            </button>
                            <button onclick="downloadJSON()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>ğŸ’¾</span> JSON ë°±ì—…
                            </button>
                            <button onclick="downloadCSV()" style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: #d97706; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow);">
                                <span>ğŸ“„</span> CSV ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>

                    <!-- ë°ì´í„° í†µê³„ -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">ğŸ“ˆ ë°ì´í„° í˜„í™©</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">ğŸ“ˆ</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="totalReferrals">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">ì´ ì˜ë¢° ê±´ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="completedReferrals">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">ì¢…ê²° ê±´ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="progressingReferrals">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">ì§„í–‰ ì¤‘</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 16px;">
                                <div style="font-size: 36px; font-weight: 800; margin-bottom: 8px;" id="avgAge">0</div>
                                <div style="font-size: 16px; opacity: 0.9;">í‰ê·  ì—°ë ¹</div>
                            </div>
                        </div>
                    </div>

                    <!-- í™œë™ ë¡œê·¸ -->
                    <div style="background: var(--gradient-card); padding: 32px; border-radius: 20px; box-shadow: var(--shadow);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);">ğŸ“‹ ì‹œìŠ¤í…œ í™œë™ ë¡œê·¸</h3>
                            <span style="font-size: 28px; color: var(--primary-color);">ğŸ“‹</span>
                        </div>
                        <div id="activityLog" style="background: #1f2937; color: #f9fafb; border-radius: 12px; padding: 16px; height: 250px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #10b981; border-radius: 4px; background: rgba(16, 185, 129, 0.1);">
                                [ì‹œìŠ¤í…œ] ğŸ’¾ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ
                            </div>
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #3b82f6; border-radius: 4px; background: rgba(59, 130, 246, 0.1);">
                                [ì •ë³´] ğŸ“Š ì—‘ì…€, CSV, JSON ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ í™œì„±í™”
                            </div>
                            <div style="margin-bottom: 8px; padding: 4px 8px; border-left: 3px solid #10b981; border-radius: 4px; background: rgba(16, 185, 129, 0.1);">
                                [ì„±ê³µ] ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„ ë° ì°¨íŠ¸ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í†µê³„/ë³´ê³ ì„œ í˜ì´ì§€ -->
            <div id="reportsPage" class="page hidden">
                <div class="dashboard-container">
                    <div style="background: var(--gradient-card); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow); text-align: center;">
                        <h1 style="font-size: 32px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 16px;">ğŸ“ˆ í†µê³„ ë° ë³´ê³ ì„œ</h1>
                        <p style="font-size: 18px; color: var(--text-secondary); font-weight: 500;">ì˜ë¢° ë°ì´í„°ë¥¼ ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¶„ì„í•œ ì‹œê°ì  í†µê³„</p>
                    </div>
                    
                    <!-- ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 40px;">
                        
                        <!-- ì„±ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ‘¥ ì„±ë³„ ë¶„í¬</h3>
                            <canvas id="genderChart" width="300" height="200"></canvas>
                        </div>

                        <!-- ì—°ë ¹ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ“Š ì—°ë ¹ë³„ ë¶„í¬</h3>
                            <canvas id="ageChart" width="300" height="200"></canvas>
                        </div>

                        <!-- íŒ€ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ¢ íŒ€ë³„ ë¶„í¬</h3>
                            <canvas id="teamChart" width="300" height="200"></canvas>
                        </div>

                        <!-- ì§€ì—­ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ—ºï¸ ì§€ì—­ë³„ ë¶„í¬</h3>
                            <canvas id="regionChart" width="300" height="200"></canvas>
                        </div>

                        <!-- ë‹´ë‹¹ìë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ‘¨â€âš•ï¸ ë‹´ë‹¹ìë³„ ë¶„í¬</h3>
                            <canvas id="counselorChart" width="300" height="200"></canvas>
                        </div>

                        <!-- ì¡°ì¹˜ê²°ê³¼ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                        <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px; font-weight: 700;">ğŸ“‹ ì¡°ì¹˜ê²°ê³¼ë³„ ë¶„í¬</h3>
                            <canvas id="actionChart" width="300" height="200"></canvas>
                        </div>
                    </div>

                    <!-- ì›”ë³„ ì¶”ì´ ì°¨íŠ¸ -->
                    <div style="background: white; padding: 32px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 40px;">
                        <h3 style="text-align: center; margin-bottom: 24px; color: #1f2937; font-size: 20px; font-weight: 700;">ğŸ“ˆ ì›”ë³„ ì˜ë¢° ì¶”ì´</h3>
                        <canvas id="monthlyChart" width="800" height="300"></canvas>
                    </div>

                    <!-- ì¢…í•© í†µê³„ ìš”ì•½ -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 32px; border-radius: 20px; box-shadow: var(--shadow);">
                        <h3 style="text-align: center; margin-bottom: 24px; font-size: 24px; font-weight: 700;">ğŸ“Š ì¢…í•© í†µê³„ ìš”ì•½</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryTotal">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ì´ ì ‘ìˆ˜ ê±´ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryMale">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ë‚¨ì„± ë¹„ìœ¨</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryFemale">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ì—¬ì„± ë¹„ìœ¨</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;" id="summaryCompleted">0</div>
                                <div style="font-size: 14px; opacity: 0.9;">ì¢…ê²°ë¥ </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        let currentUserInfo = null;
        let currentActivePage = 'referrals';
        let selectedTeamFilter = 'all';
        let editingReferralData = null;
        let viewingReferralData = null;
        let charts = {}; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ìš©

        // ğŸ”§ ë””ë²„ê¹… ì‹œìŠ¤í…œ
        let debugLog = [];
        
        function debugAddLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLog.push(logEntry);
            
            // ë””ë²„ê·¸ íŒ¨ë„ì— ì‹¤ì‹œê°„ í‘œì‹œ
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const logDiv = document.createElement('div');
                logDiv.className = type === 'error' ? 'debug-error' : 'debug-info';
                logDiv.textContent = `[${timestamp}] ${message}`;
                debugContent.appendChild(logDiv);
                
                // ìµœëŒ€ 20ê°œ ë¡œê·¸ë§Œ ìœ ì§€
                while (debugContent.children.length > 20) {
                    debugContent.removeChild(debugContent.firstChild);
                }
                
                // ìë™ ìŠ¤í¬ë¡¤
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // ì½˜ì†”ì—ë„ ì¶œë ¥
            console.log(`ğŸ”§ [${type.toUpperCase()}] ${message}`);
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                panel.classList.toggle('hidden');
                debugAddLog('ë””ë²„ê·¸ íŒ¨ë„ í† ê¸€', 'info');
            }
        }
        
        function clearDebugLog() {
            debugLog = [];
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = '<div class="debug-info">ë¡œê·¸ê°€ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        function debugSystemStatus() {
            debugAddLog('=== ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ===', 'info');
            debugAddLog(`ì „ì²´ ì˜ë¢° ë°ì´í„°: ${referralDatabase.length}ê±´`, 'info');
            debugAddLog(`í˜„ì¬ ë³´ê³ ìˆëŠ” ì˜ë¢°: ${viewingReferralData ? viewingReferralData.refNo : 'null'}`, 'info');
            debugAddLog(`í˜„ì¬ ìˆ˜ì •ì¤‘ì¸ ì˜ë¢°: ${editingReferralData ? editingReferralData.refNo : 'null'}`, 'info');
            debugAddLog(`í˜„ì¬ í™œì„± í˜ì´ì§€: ${currentActivePage}`, 'info');
            debugAddLog(`ì„ íƒëœ íŒ€ í•„í„°: ${selectedTeamFilter}`, 'info');
            debugAddLog(`í˜„ì¬ ì‚¬ìš©ì: ${currentUserInfo ? currentUserInfo.name : 'null'}`, 'info');
            
            // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
            const criticalElements = [
                'editReferralModal',
                'editReferralForm',
                'editCurrentReferralBtn',
                'saveEditedReferralBtn'
            ];
            
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                debugAddLog(`DOM ìš”ì†Œ ${id}: ${element ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ'}`, element ? 'info' : 'error');
            });
            
            debugAddLog('=== ìƒíƒœ ì²´í¬ ì™„ë£Œ ===', 'info');
        }

        // ì˜ë¢° ë°ì´í„° - ì‹¤ì œ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì–‘ì‹ ì ìš©
        let referralDatabase = [
            { 
                refNo: 'R0001', 
                name: 'ê¹€**', 
                gender: 'ë‚¨ì„±', 
                age: 35, 
                referralDate: '2025-07-10',
                referralPath: 'ê°€ì¡±ì‹ ê³ ',
                agency: 'ì.ë©´.ë™ í–‰ì •ë³µì§€ì„¼í„°', 
                team: 'íšŒë³µíŒ€',
                region: 'ì´ì²œì‹œ ì°½ì „ë™',
                counselor: 'ë°•ìƒë‹´ì‚¬', 
                diagnosis: 'ìš°ìš¸ì¦', 
                interventionContent: 'ìµœê·¼ 2ê°œì›”ê°„ ìš°ìš¸ê° ì‹¬í™”, ì¼ìƒìƒí™œ ì–´ë ¤ì›€. ê°€ì¡± ì‹ ê³ ë¡œ ìƒë‹´ ì˜ë¢°.',
                actionResult: 'ì§€ì†ìƒë‹´',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-001',
                responseRequired: 'ì²˜ë¦¬ê²°ê³¼ íšŒì‹  ìš”ì²­'
            },
            { 
                refNo: 'R0002', 
                name: 'ì´**', 
                gender: 'ì—¬ì„±', 
                age: 28, 
                referralDate: '2025-07-12',
                referralPath: 'ê²½ì°°ì‹ ê³ ',
                agency: 'ê²½ì°°ì„œ', 
                team: 'ìì‚´ì˜ˆë°©ì„¼í„°',
                region: 'ì´ì²œì‹œ ë¶€ë°œì',
                counselor: 'ê¹€ìƒë‹´ì‚¬', 
                diagnosis: 'ì¡°í˜„ë³‘', 
                interventionContent: 'ìí•´ ì‹œë„ í›„ ê²½ì°° ì¶œë™. ì¦‰ì‹œ ì „ë¬¸ìƒë‹´ í•„ìš”í•œ ìƒíƒœ.',
                actionResult: 'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: true,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: true,
                criInfo: 'CRI-002',
                responseRequired: 'ê¸´ê¸‰ ì¡°ì¹˜ ê²°ê³¼ ì¦‰ì‹œ íšŒì‹  í•„ìš”'
            },
            { 
                refNo: 'R0003', 
                name: 'ë°•**', 
                gender: 'ë‚¨ì„±', 
                age: 16, 
                referralDate: '2025-07-13',
                referralPath: 'í•™êµì˜ë¢°',
                agency: 'í•™êµ', 
                team: 'ì•„ë™ì²­ì†Œë…„',
                region: 'ì´ì²œì‹œ ì‹ ë‘”ë©´',
                counselor: 'ìµœìƒë‹´ì‚¬', 
                diagnosis: 'ë¶ˆì•ˆì¥ì• ', 
                interventionContent: 'í•™êµì—ì„œ ë˜ë˜ê´€ê³„ ì–´ë ¤ì›€ ë° ë¶ˆì•ˆì¦ìƒìœ¼ë¡œ ì˜ë¢°.',
                actionResult: 'ì¹˜ë£Œì—°ê³„',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: true,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-003',
                responseRequired: '-'
            },
            { 
                refNo: 'R0004', 
                name: 'ìµœ**', 
                gender: 'ì—¬ì„±', 
                age: 42, 
                referralDate: '2025-07-14',
                referralPath: 'ë³´ê±´ì†Œì˜ë¢°',
                agency: 'ë³´ê±´ì†Œ', 
                team: 'ì¦ì§„íŒ€',
                region: 'ì´ì²œì‹œ í˜¸ë²•ë©´',
                counselor: 'ì •ìƒë‹´ì‚¬', 
                diagnosis: 'ê¸°íƒ€ì§ˆí™˜', 
                interventionContent: 'ì •ì‹ ê±´ê°• ìƒë‹´ ìš”ì²­. ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ í•„ìš”.',
                actionResult: 'ì¢…ê²°',
                closureStatus: 'ì¢…ê²°',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: true,
                policeInvolvement: false,
                criInfo: 'CRI-004',
                responseRequired: 'ìƒë‹´ ì™„ë£Œ ê²°ê³¼ í†µë³´'
            },
            { 
                refNo: 'R0005', 
                name: 'ì •**', 
                gender: 'ë‚¨ì„±', 
                age: 52, 
                referralDate: '2025-07-14',
                referralPath: 'ë³¸ì¸ì‹ ì²­',
                agency: 'ë³¸ì¸', 
                team: 'ë‚¨ë¶€ë¶„ì†Œ',
                region: 'ì´ì²œì‹œ ë§ˆì¥ë©´',
                counselor: 'ì†¡ìƒë‹´ì‚¬', 
                diagnosis: 'ì•Œì½”ì˜¬ì‚¬ìš©ì¥ì• ', 
                interventionContent: 'ë³¸ì¸ì´ ì§ì ‘ ì•Œì½”ì˜¬ ë¬¸ì œë¡œ ìƒë‹´ ì‹ ì²­.',
                actionResult: 'ì²˜ë¦¬ì¤‘',
                closureStatus: 'ì§„í–‰ì¤‘',
                diagnosisProtection: false,
                writtenReferral: false,
                phoneReferral: false,
                policeInvolvement: false,
                criInfo: 'CRI-005',
                responseRequired: '-'
            }
        ];

        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateCurrentTime() {
            try {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString('ko-KR');
                }
            } catch (error) {
                debugAddLog('ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            try {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                // ê¸°ì¡´ ì•Œë¦¼ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ì œê±°
                while (container.children.length >= 3) {
                    container.removeChild(container.firstChild);
                }

                const notification = document.createElement('div');
                notification.className = 'notification ' + type;
                
                const messageDiv = document.createElement('div');
                messageDiv.style.display = 'flex';
                messageDiv.style.justifyContent = 'space-between';
                messageDiv.style.alignItems = 'center';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = 'Ã—';
                closeButton.style.cssText = 'background:none;border:none;font-size:18px;cursor:pointer;margin-left:10px;color:inherit;';
                closeButton.onclick = function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                };
                
                messageDiv.appendChild(textSpan);
                messageDiv.appendChild(closeButton);
                notification.appendChild(messageDiv);
                container.appendChild(notification);
                
                // ìë™ ì œê±°
                setTimeout(function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                debugAddLog('ì•Œë¦¼ í‘œì‹œ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogin() {
            try {
                debugAddLog('ë¡œê·¸ì¸ ì‹œë„ ì‹œì‘', 'info');
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!username || !password) {
                    showNotification('ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                    return;
                }

                if (username === 'admin' && password === '1234') {
                    currentUserInfo = { 
                        name: 'ì‹œìŠ¤í…œê´€ë¦¬ì', 
                        role: 'ê´€ë¦¬ì'
                    };
                    
                    const loginScreen = document.getElementById('loginScreen');
                    const mainApp = document.getElementById('mainApp');
                    
                    if (loginScreen) loginScreen.classList.add('hidden');
                    if (mainApp) mainApp.classList.remove('hidden');
                    
                    // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                    const nameElement = document.getElementById('currentUserName');
                    const roleElement = document.getElementById('currentUserRole');
                    if (nameElement) nameElement.textContent = currentUserInfo.name;
                    if (roleElement) roleElement.textContent = currentUserInfo.role;
                    
                    showNotification(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUserInfo.name}ë‹˜! ë””ë²„ê¹… ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    debugAddLog('ë¡œê·¸ì¸ ì„±ê³µ: ' + currentUserInfo.name, 'info');
                    
                    // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                    updateReferralsTable();
                    updateTeamCounts();
                    updateDataStats();
                    selectTeam('all');
                } else {
                    showNotification('ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    debugAddLog('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì˜ëª»ëœ ìê²©ì¦ëª…', 'error');
                }
            } catch (error) {
                debugAddLog('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ë¡œê·¸ì¸';
            }
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogout() {
            try {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    currentUserInfo = null;
                    
                    const mainApp = document.getElementById('mainApp');
                    const loginScreen = document.getElementById('loginScreen');
                    
                    if (mainApp) mainApp.classList.add('hidden');
                    if (loginScreen) loginScreen.classList.remove('hidden');
                    
                    showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    debugAddLog('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
                }
            } catch (error) {
                debugAddLog('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜
        function showPage(pageId) {
            try {
                debugAddLog('í˜ì´ì§€ ì „í™˜: ' + pageId, 'info');
                
                // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => page.classList.add('hidden'));

                // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ ë¹„í™œì„±í™”
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));

                // ì„ íƒëœ í˜ì´ì§€ í‘œì‹œ
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }

                // í˜ì´ì§€ë³„ ì´ˆê¸°í™”
                if (pageId === 'reports') {
                    // í†µê³„ í˜ì´ì§€ ì§„ì… ì‹œ ì°¨íŠ¸ ìƒì„±
                    setTimeout(() => createCharts(), 100);
                } else if (pageId === 'data') {
                    // ë°ì´í„° ê´€ë¦¬ í˜ì´ì§€ ì§„ì… ì‹œ í†µê³„ ì—…ë°ì´íŠ¸
                    updateDataStats();
                }

                // ì„ íƒëœ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ í™œì„±í™”
                const activeNav = document.querySelector(`.nav-link[onclick*="${pageId}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }

                currentActivePage = pageId;
                
                const pageNames = {
                    'referrals': 'ì˜ë¢° ê´€ë¦¬',
                    'data': 'ë°ì´í„° ê´€ë¦¬',
                    'reports': 'í†µê³„/ë³´ê³ ì„œ'
                };
                
                showNotification(`${pageNames[pageId] || pageId} í˜ì´ì§€ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`, 'info');
            } catch (error) {
                debugAddLog('í˜ì´ì§€ ì „í™˜ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // íŒ€ ì„ íƒ í•¨ìˆ˜
        function selectTeam(teamId) {
            try {
                debugAddLog('íŒ€ ì„ íƒ: ' + teamId, 'info');
                selectedTeamFilter = teamId;
                
                // ëª¨ë“  íŒ€ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ë¦¬ì…‹
                const teamItems = document.querySelectorAll('[data-team]');
                teamItems.forEach(item => {
                    item.style.background = '#f8f9fa';
                    item.style.color = '#374151';
                    item.style.transform = 'none';
                    item.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                });
                
                // ì„ íƒëœ íŒ€ ê°•ì¡° í‘œì‹œ
                const selectedTeam = document.querySelector(`[data-team="${teamId}"]`);
                if (selectedTeam) {
                    const teamColors = {
                        'all': '#6b7280',
                        'ì¦ì§„íŒ€': '#3b82f6',
                        'íšŒë³µíŒ€': '#059669',
                        'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                        'ì•„ë™ì²­ì†Œë…„': '#d97706',
                        'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                    };
                    
                    const color = teamColors[teamId] || '#6b7280';
                    selectedTeam.style.background = color;
                    selectedTeam.style.color = 'white';
                    selectedTeam.style.transform = 'translateY(-2px) scale(1.05)';
                    selectedTeam.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
                }
                
                updateCurrentTeamDisplay(teamId);
                updateReferralsTable();
                
                const teamNames = {
                    'all': 'ì „ì²´ íŒ€',
                    'ì¦ì§„íŒ€': 'ì¦ì§„íŒ€',
                    'íšŒë³µíŒ€': 'íšŒë³µíŒ€',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': 'ìì‚´ì˜ˆë°©ì„¼í„°',
                    'ì•„ë™ì²­ì†Œë…„': 'ì•„ë™ì²­ì†Œë…„',
                    'ë‚¨ë¶€ë¶„ì†Œ': 'ë‚¨ë¶€ë¶„ì†Œ'
                };
                
                showNotification(`${teamNames[teamId]} ì„ íƒë¨`, 'info');
            } catch (error) {
                debugAddLog('íŒ€ ì„ íƒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // í˜„ì¬ íŒ€ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCurrentTeamDisplay(teamId) {
            try {
                const teamInfo = {
                    'all': { icon: 'ğŸ“Š', title: 'ì „ì²´ íŒ€ ì˜ë¢° ëª©ë¡', desc: 'ëª¨ë“  íŒ€ì˜ ì˜ë¢°ë¥¼ í†µí•© ê´€ë¦¬', color: '#6b7280' },
                    'ì¦ì§„íŒ€': { icon: 'ğŸ¯', title: 'ì¦ì§„íŒ€ ì˜ë¢° ëª©ë¡', desc: 'ì •ì‹ ê±´ê°• ì¦ì§„ì‚¬ì—… ê´€ë ¨ ì˜ë¢°', color: '#3b82f6' },
                    'íšŒë³µíŒ€': { icon: 'ğŸŒ±', title: 'íšŒë³µíŒ€ ì˜ë¢° ëª©ë¡', desc: 'ì •ì‹ ê±´ê°• íšŒë³µì§€ì› ê´€ë ¨ ì˜ë¢°', color: '#059669' },
                    'ìì‚´ì˜ˆë°©ì„¼í„°': { icon: 'ğŸš¨', title: 'ìì‚´ì˜ˆë°©ì„¼í„° ì˜ë¢° ëª©ë¡', desc: 'ìì‚´ì˜ˆë°© ë° ìœ„ê¸°ê°œì… ì˜ë¢°', color: '#dc2626' },
                    'ì•„ë™ì²­ì†Œë…„': { icon: 'ğŸ‘¶', title: 'ì•„ë™ì²­ì†Œë…„ ì˜ë¢° ëª©ë¡', desc: 'ì•„ë™ì²­ì†Œë…„ ì •ì‹ ê±´ê°• ì˜ë¢°', color: '#d97706' },
                    'ë‚¨ë¶€ë¶„ì†Œ': { icon: 'ğŸ¢', title: 'ë‚¨ë¶€ë¶„ì†Œ ì˜ë¢° ëª©ë¡', desc: 'ë‚¨ë¶€ë¶„ì†Œ ê´€í•  ì§€ì—­ ì˜ë¢°', color: '#7c3aed' }
                };
                
                const info = teamInfo[teamId] || teamInfo['all'];
                
                const iconElement = document.getElementById('currentTeamIcon');
                const titleElement = document.getElementById('currentTeamTitle');
                const descElement = document.getElementById('currentTeamDesc');
                
                if (iconElement) iconElement.textContent = info.icon;
                if (titleElement) titleElement.textContent = info.title;
                if (descElement) descElement.textContent = info.desc;
                
                const currentTeamInfo = document.getElementById('currentTeamInfo');
                if (currentTeamInfo) {
                    const border = currentTeamInfo.querySelector('div');
                    if (border) border.style.borderColor = info.color;
                    
                    const titles = currentTeamInfo.querySelectorAll('h3, p, div');
                    titles.forEach(element => {
                        element.style.color = info.color;
                    });
                }
            } catch (error) {
                debugAddLog('íŒ€ í‘œì‹œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateReferralsTable() {
            try {
                debugAddLog('ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹œì‘', 'info');
                const tbody = document.getElementById('referralsTableBody');
                if (!tbody) {
                    debugAddLog('í…Œì´ë¸” body ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                    return;
                }
                
                tbody.innerHTML = '';
                
                const filteredData = selectedTeamFilter === 'all' ? 
                    referralDatabase : referralDatabase.filter(item => item.team === selectedTeamFilter);
                
                const countElement = document.getElementById('currentTeamCount');
                if (countElement) {
                    countElement.textContent = filteredData.length;
                }
                
                // ìƒíƒœë³„ ìƒ‰ìƒ ì •ì˜
                const actionResultColors = {
                    'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)': '#3b82f6',
                    'ì§€ì†ìƒë‹´': '#059669',
                    'ì¹˜ë£Œì—°ê³„': '#d97706',
                    'ì„œë¹„ìŠ¤ ì—°ê³„': '#7c3aed',
                    'ê¸°íƒ€ì¡°ì¹˜': '#6b7280',
                    'ì •ë³´ì œê³µ': '#0891b2',
                    'ì¢…ê²°': '#059669',
                    'ì²˜ë¦¬ì¤‘': '#f59e0b'
                };
                
                const closureStatusColors = {
                    'ì§„í–‰ì¤‘': '#d97706',
                    'ì¢…ê²°': '#059669',
                    'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸': '#6b7280',
                    'ë¯¸ë“±ë¡ì ì¢…ê²°': '#ef4444'
                };
                
                const teamColors = {
                    'ì¦ì§„íŒ€': '#3b82f6',
                    'íšŒë³µíŒ€': '#059669',
                    'ìì‚´ì˜ˆë°©ì„¼í„°': '#dc2626',
                    'ì•„ë™ì²­ì†Œë…„': '#d97706',
                    'ë‚¨ë¶€ë¶„ì†Œ': '#7c3aed'
                };
                
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f3f4f6';
                    row.onmouseover = function() { this.style.background = '#f9fafb'; };
                    row.onmouseout = function() { this.style.background = 'white'; };
                    
                    row.innerHTML = `
                        <td style="padding: 15px 12px; font-weight: 700; color: #1f2937; font-size: 13px;">${item.refNo}</td>
                        <td style="padding: 15px 12px; font-weight: 600; font-size: 13px;">${item.name}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.gender}<br><small style="color: #6b7280;">${item.age}ì„¸</small></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.referralDate}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.agency}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span style="color: ${teamColors[item.team] || '#6b7280'}; font-weight: 600;">${item.team}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.counselor}</td>
                        <td style="padding: 15px 12px; font-size: 13px;">${item.diagnosis}</td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${actionResultColors[item.actionResult] || '#6b7280'};">${item.actionResult || '-'}</span></td>
                        <td style="padding: 15px 12px; font-size: 13px;"><span class="status-badge" style="background: ${closureStatusColors[item.closureStatus] || '#6b7280'};">${item.closureStatus}</span></td>
                        <td style="padding: 15px 12px; text-align: center;">
                            <button class="action-btn view" onclick="viewReferralDetail('${item.refNo}')">ìƒì„¸</button>
                            <button class="action-btn edit" onclick="editReferral('${item.refNo}')">ìˆ˜ì •</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                debugAddLog(`í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${filteredData.length}ê±´`, 'info');
            } catch (error) {
                debugAddLog('ì˜ë¢° í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateTeamCounts() {
            try {
                const teams = ['ì¦ì§„íŒ€', 'íšŒë³µíŒ€', 'ìì‚´ì˜ˆë°©ì„¼í„°', 'ì•„ë™ì²­ì†Œë…„', 'ë‚¨ë¶€ë¶„ì†Œ'];
                
                const allCountElement = document.getElementById('allTeamCount');
                if (allCountElement) {
                    allCountElement.textContent = referralDatabase.length + 'ê±´';
                }
                
                teams.forEach((team, index) => {
                    const count = referralDatabase.filter(item => item.team === team).length;
                    const element = document.getElementById('team' + (index + 1) + 'Count');
                    if (element) {
                        element.textContent = count + 'ê±´';
                    }
                });
                
                debugAddLog('íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('íŒ€ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ìƒˆ ì˜ë¢° ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openNewReferralModal() {
            try {
                debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ì—´ê¸°', 'info');
                const modal = document.getElementById('newReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    
                    // ì˜ë¢°ë‚ ì§œë¥¼ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¤ì •
                    const today = new Date().toISOString().slice(0, 10);
                    const dateField = document.getElementById('referralDate');
                    if (dateField) {
                        dateField.value = today;
                    }
                }
            } catch (error) {
                debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function closeNewReferralModal() {
            try {
                debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ë‹«ê¸°', 'info');
                const modal = document.getElementById('newReferralModal');
                const form = document.getElementById('newReferralForm');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
            } catch (error) {
                debugAddLog('ìƒˆ ì˜ë¢° ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì˜ë¢° í¼ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜
        function collectReferralFormData() {
            try {
                const formData = {
                    refNo: 'R' + String(referralDatabase.length + 1).padStart(4, '0'),
                    name: (document.getElementById('referrerName').value || '').trim() + '**',
                    gender: document.getElementById('referrerGender').value,
                    age: parseInt(document.getElementById('referrerAge').value) || 0,
                    referralDate: document.getElementById('referralDate').value,
                    referralPath: (document.getElementById('referralPath').value || '').trim() || '-',
                    agency: document.getElementById('referringAgency').value,
                    team: document.getElementById('assignedTeam').value,
                    region: (document.getElementById('region').value || '').trim() || '-',
                    counselor: (document.getElementById('assignedCounselor').value || '').trim() || 'ë‹´ë‹¹ì ë°°ì • ì¤‘',
                    diagnosis: (document.getElementById('diagnosis').value || '').trim() || 'ì§„ë‹¨ ëŒ€ê¸°',
                    interventionContent: (document.getElementById('interventionContent').value || '').trim(),
                    actionResult: document.getElementById('actionResult').value || 'ì²˜ë¦¬ì¤‘',
                    closureStatus: 'ì§„í–‰ì¤‘', // ê¸°ë³¸ê°’
                    diagnosisProtection: document.getElementById('diagnosisProtectionRequest').checked,
                    writtenReferral: document.getElementById('writtenReferral').checked,
                    phoneReferral: document.getElementById('phoneReferral').checked,
                    policeInvolvement: document.getElementById('policeInvolvement').checked,
                    responseRequired: (document.getElementById('responseRequired').value || '').trim() || '-',
                    criInfo: (document.getElementById('criInfo').value || '').trim() || '-'
                };

                // ê¸°ë³¸ ìœ íš¨ì„± ê²€ì‚¬
                if (!formData.name || formData.name === '**') {
                    throw new Error('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                if (!formData.gender) {
                    throw new Error('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.age || formData.age <= 0) {
                    throw new Error('ì˜¬ë°”ë¥¸ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                if (!formData.referralDate) {
                    throw new Error('ì˜ë¢°ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.agency) {
                    throw new Error('ì˜ë¢°ê¸°ê´€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.team) {
                    throw new Error('ë‹´ë‹¹íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                if (!formData.interventionContent) {
                    throw new Error('ê°œì…ë‚´ìš©/í˜„ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }

                return formData;
            } catch (error) {
                throw error;
            }
        }

        // ì„ì‹œì €ì¥ í•¨ìˆ˜
        function saveDraftReferral() {
            try {
                debugAddLog('ì„ì‹œì €ì¥ ì‹œì‘', 'info');
                const formData = collectReferralFormData();
                formData.closureStatus = 'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸'; // ì„ì‹œì €ì¥ ìƒíƒœ
                formData.actionResult = 'ì²˜ë¦¬ì¤‘';
                
                referralDatabase.push(formData);
                updateReferralsTable();
                updateTeamCounts();
                closeNewReferralModal();
                
                showNotification(`ì˜ë¢°ê°€ ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ì˜ë¢°ë²ˆí˜¸: ${formData.refNo})`, 'warning');
                debugAddLog('ì„ì‹œì €ì¥ ì™„ë£Œ: ' + formData.refNo, 'info');
                
                // í†µê³„ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                updateDataStats();
                if (currentActivePage === 'reports') {
                    setTimeout(() => createCharts(), 100);
                }
                
                addLog('ğŸ’¾ ì„ì‹œì €ì¥: ' + formData.refNo, 'info');
            } catch (error) {
                debugAddLog('ì„ì‹œì €ì¥ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì„ì‹œì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ğŸ”§ ì˜ë¢° ìƒì„¸ë³´ê¸° - ë””ë²„ê¹… ê°•í™”
        function viewReferralDetail(refNo) {
            try {
                debugAddLog('ì˜ë¢° ìƒì„¸ë³´ê¸° ì‹œì‘: ' + refNo, 'info');
                const referral = referralDatabase.find(item => item.refNo === refNo);
                if (!referral) {
                    debugAddLog('ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ' + refNo, 'error');
                    showNotification('ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                viewingReferralData = referral; // ğŸ”§ ì¤‘ìš”: ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                debugAddLog('viewingReferralData ì„¤ì • ì™„ë£Œ: ' + referral.refNo, 'info');
                
                const detailContent = document.getElementById('referralDetailContent');
                if (detailContent) {
                    detailContent.innerHTML = generateReferralDetailHTML(referral);
                }
                
                const modal = document.getElementById('referralDetailModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    debugAddLog('ìƒì„¸ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ', 'info');
                }
                
                addLog('ğŸ‘€ ì˜ë¢° ìƒì„¸ë³´ê¸° ì—´ë¦¼: ' + refNo, 'info');
            } catch (error) {
                debugAddLog('ì˜ë¢° ìƒì„¸ë³´ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì˜ë¢° ìƒì„¸ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì˜ë¢° ìƒì„¸ë³´ê¸° HTML ìƒì„±
        function generateReferralDetailHTML(referral) {
            const actionResultColor = getActionResultColor(referral.actionResult);
            const closureStatusColor = getClosureStatusColor(referral.closureStatus);
            
            return `
                <div style="grid-column: 1 / -1; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h4>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ë²ˆí˜¸</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 600;">${referral.refNo}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì´ë¦„</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.name}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì„±ë³„</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.gender}</div>
                </div>
                <div class="form-group">
                    <label><strong>ë‚˜ì´</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.age}ì„¸</div>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ë‚ ì§œ</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.referralDate}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì§€ì—­</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.region || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #fff7ed; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“‹ ì˜ë¢° ì •ë³´</h4>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ê²½ë¡œ</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.referralPath || '-'}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì˜ë¢°ê¸°ê´€</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.agency}</div>
                </div>
                <div class="form-group">
                    <label><strong>ë‹´ë‹¹íŒ€</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 600; color: #059669;">${referral.team}</div>
                </div>
                <div class="form-group">
                    <label><strong>ë‹´ë‹¹ì</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.counselor}</div>
                </div>
                <div class="form-group">
                    <label><strong>CRI</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.criInfo || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“‹ ì˜ë¢° ìœ í˜•</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>ì§„ë‹¨ ë³´í˜¸ìš”ì²­:</strong> ${referral.diagnosisProtection ? 'âœ…' : 'âŒ'}</div>
                        <div><strong>ì„œë©´ì˜ë¢°:</strong> ${referral.writtenReferral ? 'âœ…' : 'âŒ'}</div>
                        <div><strong>ìœ ì„ ì˜ë¢°:</strong> ${referral.phoneReferral ? 'âœ…' : 'âŒ'}</div>
                        <div><strong>ê²½ì°°ê°œì…ì—¬ë¶€:</strong> ${referral.policeInvolvement ? 'âœ…' : 'âŒ'}</div>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ¥ ì§„ë‹¨ ë° ì¡°ì¹˜ ì •ë³´</h4>
                </div>
                <div class="form-group">
                    <label><strong>ì§„ë‹¨ëª…</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">${referral.diagnosis}</div>
                </div>
                <div class="form-group">
                    <label><strong>ì¡°ì¹˜ê²°ê³¼</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span class="status-badge" style="background: ${actionResultColor};">${referral.actionResult || '-'}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>ì¢…ê²°ì—¬ë¶€</strong></label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span class="status-badge" style="background: ${closureStatusColor};">${referral.closureStatus}</span>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“ ê°œì…ë‚´ìš©/í˜„ìƒí™©</h4>
                    <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 6px; white-space: pre-wrap;">${referral.interventionContent || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1; background: #f0f4f8; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“¬ íšŒì‹  ì •ë³´</h4>
                    <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 6px; white-space: pre-wrap;">
                        ${typeof referral.responseRequired === 'boolean' ? 
                            (referral.responseRequired ? 'íšŒì‹  í•„ìš”' : 'íšŒì‹  ë¶ˆí•„ìš”') : 
                            (referral.responseRequired || '-')
                        }
                    </div>
                </div>
            `;
        }

        // ì¡°ì¹˜ê²°ê³¼ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getActionResultColor(actionResult) {
            const colors = {
                'ë“±ë¡ê´€ë¦¬(ê¸°ë“±ë¡í¬í•¨)': '#3b82f6',
                'ì§€ì†ìƒë‹´': '#059669',
                'ì¹˜ë£Œì—°ê³„': '#d97706',
                'ì„œë¹„ìŠ¤ ì—°ê³„': '#7c3aed',
                'ê¸°íƒ€ì¡°ì¹˜': '#6b7280',
                'ì •ë³´ì œê³µ': '#0891b2',
                'ì¢…ê²°': '#059669',
                'ì²˜ë¦¬ì¤‘': '#f59e0b'
            };
            return colors[actionResult] || '#6b7280';
        }

        // ì¢…ê²°ì—¬ë¶€ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getClosureStatusColor(closureStatus) {
            const colors = {
                'ì§„í–‰ì¤‘': '#d97706',
                'ì¢…ê²°': '#059669',
                'ì¡°ì¹˜ ê²°ê³¼ ë“±ë¡ì œì™¸': '#6b7280',
                'ë¯¸ë“±ë¡ì ì¢…ê²°': '#ef4444'
            };
            return colors[closureStatus] || '#6b7280';
        }

        // ğŸ”§ í˜„ì¬ ì˜ë¢° ìˆ˜ì • - ë””ë²„ê¹… ê°•í™” ë° ì˜¤ë¥˜ ìˆ˜ì •
        function editCurrentReferral() {
            debugAddLog('=== editCurrentReferral í˜¸ì¶œë¨ ===', 'info');
            debugAddLog('í˜„ì¬ viewingReferralData: ' + (viewingReferralData ? viewingReferralData.refNo : 'null'), 'info');
            
            try {
                if (!viewingReferralData) {
                    debugAddLog('viewingReferralDataê°€ null', 'error');
                    showNotification('ìˆ˜ì •í•  ì˜ë¢° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                debugAddLog('ìƒì„¸ë³´ê¸° ë°ì´í„° í™•ì¸ë¨: ' + viewingReferralData.refNo, 'info');
                
                // ğŸ”§ ì¤‘ìš”: ë°ì´í„°ë¥¼ ë°±ì—…í•œ í›„ ëª¨ë‹¬ ë‹«ê¸°
                const backupReferralData = viewingReferralData;
                debugAddLog('ì˜ë¢° ë°ì´í„° ë°±ì—… ì™„ë£Œ: ' + backupReferralData.refNo, 'info');
                
                // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
                closeReferralDetailModal();
                
                // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (ë°±ì—…ëœ ë°ì´í„° ì‚¬ìš©)
                debugAddLog('ìˆ˜ì • ëª¨ë‹¬ë¡œ ì „í™˜...', 'info');
                editReferral(backupReferralData.refNo);
                
            } catch (error) {
                debugAddLog('editCurrentReferral ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ìˆ˜ì • ëª¨ë“œ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ğŸ”§ ì˜ë¢° ìˆ˜ì • ê¸°ëŠ¥ - ì™„ì „íˆ ìƒˆë¡œ ì‘ì„±
        function editReferral(refNo) {
            debugAddLog('=== ì˜ë¢° ìˆ˜ì • ì‹œì‘ ===', 'info');
            debugAddLog('ìˆ˜ì • ìš”ì²­ ì˜ë¢°ë²ˆí˜¸: ' + refNo, 'info');
            
            try {
                // 1. ì˜ë¢° ì°¾ê¸°
                const referral = referralDatabase.find(item => item.refNo === refNo);
                debugAddLog('ì°¾ì€ ì˜ë¢° ë°ì´í„°: ' + (referral ? referral.refNo : 'null'), 'info');
                
                if (!referral) {
                    debugAddLog('ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                    showNotification('ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // 2. ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                editingReferralData = referral;
                debugAddLog('editingReferralData ì„¤ì •: ' + editingReferralData.refNo, 'info');
                
                // 3. í¼ í•„ë“œì— ë°ì´í„° ì±„ìš°ê¸°
                debugAddLog('í¼ í•„ë“œ ì±„ìš°ê¸° ì‹œì‘...', 'info');
                
                const fields = {
                    'editRefNo': referral.refNo,
                    'editReferrerName': referral.name.replace('**', ''),
                    'editReferrerGender': referral.gender,
                    'editReferrerAge': referral.age,
                    'editReferralDate': referral.referralDate,
                    'editReferralPath': referral.referralPath || '',
                    'editReferringAgency': referral.agency,
                    'editAssignedTeam': referral.team,
                    'editCounselor': referral.counselor,
                    'editDiagnosis': referral.diagnosis,
                    'editActionResult': referral.actionResult || 'ì²˜ë¦¬ì¤‘',
                    'editClosureStatus': referral.closureStatus,
                    'editRegion': referral.region || '',
                    'editCriInfo': referral.criInfo || '',
                    'editInterventionContent': referral.interventionContent || '',
                    'editResponseRequired': typeof referral.responseRequired === 'boolean' ? 
                        (referral.responseRequired ? 'íšŒì‹  í•„ìš”' : '') : 
                        (referral.responseRequired || '')
                };
                
                // ê° í•„ë“œë³„ë¡œ ì„¤ì •í•˜ê³  í™•ì¸
                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                        debugAddLog(`âœ… ${fieldId}: "${value}"`, 'info');
                    } else {
                        debugAddLog(`âŒ í•„ë“œ ì—†ìŒ: ${fieldId}`, 'error');
                    }
                }
                
                // 4. ëª¨ë‹¬ ì—´ê¸°
                const modal = document.getElementById('editReferralModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    debugAddLog('ìˆ˜ì • ëª¨ë‹¬ ì—´ë¦¼', 'info');
                    addLog('ğŸ“ ì˜ë¢° ìˆ˜ì • ëª¨ë‹¬ ì—´ë¦¼: ' + refNo, 'info');
                } else {
                    debugAddLog('ìˆ˜ì • ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                }
                
                debugAddLog('=== ì˜ë¢° ìˆ˜ì • ì¤€ë¹„ ì™„ë£Œ ===', 'info');
                
            } catch (error) {
                debugAddLog('ì˜ë¢° ìˆ˜ì • ì˜¤ë¥˜: ' + error.message, 'error');
                addLog('âŒ ì˜ë¢° ìˆ˜ì • ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì˜ë¢° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }
        
        // ğŸ”§ ì €ì¥ ë²„íŠ¼ í•¸ë“¤ëŸ¬ - ì§ì ‘ í˜¸ì¶œìš©
        function handleSaveEditedReferral() {
            debugAddLog('=== ì €ì¥ ë²„íŠ¼ ì§ì ‘ í˜¸ì¶œë¨ ===', 'info');
            
            try {
                // í¼ ê²€ì¦ ë° ì €ì¥ ì‹¤í–‰
                const success = saveEditedReferral();
                
                if (success) {
                    debugAddLog('ì €ì¥ ì„±ê³µ', 'info');
                } else {
                    debugAddLog('ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                debugAddLog('ì €ì¥ í•¸ë“¤ëŸ¬ ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ğŸ”§ ì˜ë¢° ìˆ˜ì • ì €ì¥ í•¨ìˆ˜ - ì™„ì „íˆ ìƒˆë¡œ ì‘ì„±
        function saveEditedReferral() {
            debugAddLog('=== ì˜ë¢° ìˆ˜ì • ì €ì¥ ì‹œì‘ ===', 'info');
            debugAddLog('editingReferralData: ' + (editingReferralData ? editingReferralData.refNo : 'null'), 'info');
            
            try {
                // 1. ìˆ˜ì •í•  ë°ì´í„° í™•ì¸
                if (!editingReferralData) {
                    debugAddLog('editingReferralDataê°€ ì—†ìŒ', 'error');
                    showNotification('ìˆ˜ì •í•  ì˜ë¢° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return false;
                }
                
                // 2. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì˜ë¢° ì°¾ê¸°
                const index = referralDatabase.findIndex(item => item.refNo === editingReferralData.refNo);
                debugAddLog('ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤: ' + index, 'info');
                
                if (index === -1) {
                    debugAddLog('ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                    showNotification('ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return false;
                }
                
                // 3. í¼ì—ì„œ ìˆ˜ì •ëœ ë°ì´í„° ìˆ˜ì§‘
                debugAddLog('í¼ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...', 'info');
                
                // ğŸ”§ ì•ˆì „í•œ í¼ ìš”ì†Œ ì ‘ê·¼ í•¨ìˆ˜
                function safeGetElementValue(id, defaultValue = '') {
                    const element = document.getElementById(id);
                    if (!element) {
                        debugAddLog(`í¼ ìš”ì†Œ '${id}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`, 'error');
                        return defaultValue;
                    }
                    return element.value || defaultValue;
                }
                
                const updatedData = {
                    ...referralDatabase[index], // ê¸°ì¡´ ëª¨ë“  ë°ì´í„° ë³´ì¡´
                    // ìˆ˜ì • ê°€ëŠ¥í•œ í•„ë“œë“¤
                    name: (safeGetElementValue('editReferrerName').trim() || 'ë¬´ëª…') + '**',
                    gender: safeGetElementValue('editReferrerGender', 'ë¯¸ìƒ'),
                    age: parseInt(safeGetElementValue('editReferrerAge', '0')) || 0,
                    referralDate: safeGetElementValue('editReferralDate'),
                    referralPath: safeGetElementValue('editReferralPath').trim() || '-',
                    agency: safeGetElementValue('editReferringAgency', 'ë¯¸ìƒ'),
                    team: safeGetElementValue('editAssignedTeam', 'ë¯¸ë°°ì •'),
                    counselor: safeGetElementValue('editCounselor').trim() || 'ë‹´ë‹¹ì ë°°ì • ì¤‘',
                    diagnosis: safeGetElementValue('editDiagnosis').trim() || 'ì§„ë‹¨ ëŒ€ê¸°',
                    actionResult: safeGetElementValue('editActionResult', 'ì²˜ë¦¬ì¤‘'),
                    closureStatus: safeGetElementValue('editClosureStatus', 'ì§„í–‰ì¤‘'),
                    region: safeGetElementValue('editRegion').trim() || '-',
                    criInfo: safeGetElementValue('editCriInfo').trim() || '-',
                    interventionContent: safeGetElementValue('editInterventionContent').trim(),
                    responseRequired: safeGetElementValue('editResponseRequired').trim() || '-'
                };
                
                debugAddLog('ìˆ˜ì§‘ëœ ì—…ë°ì´íŠ¸ ë°ì´í„°: ' + updatedData.name, 'info');
                
                // 4. í•„ìˆ˜ í•„ë“œ ê²€ì¦
                debugAddLog('í•„ìˆ˜ í•„ë“œ ê²€ì¦ ì¤‘...', 'info');
                if (!updatedData.name || updatedData.name === '**' || updatedData.name === 'ë¬´ëª…**') {
                    debugAddLog('ì´ë¦„ í•„ë“œ ê²€ì¦ ì‹¤íŒ¨', 'error');
                    showNotification('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return false;
                }
                if (!updatedData.interventionContent || updatedData.interventionContent.trim() === '') {
                    debugAddLog('ê°œì…ë‚´ìš© í•„ë“œ ê²€ì¦ ì‹¤íŒ¨', 'error');
                    showNotification('ê°œì…ë‚´ìš©/í˜„ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return false;
                }
                if (!updatedData.referralDate) {
                    debugAddLog('ì˜ë¢°ë‚ ì§œ í•„ë“œ ê²€ì¦ ì‹¤íŒ¨', 'error');
                    showNotification('ì˜ë¢°ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return false;
                }
                debugAddLog('í•„ìˆ˜ í•„ë“œ ê²€ì¦ í†µê³¼', 'info');
                
                // 5. ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
                debugAddLog('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘...', 'info');
                referralDatabase[index] = updatedData;
                debugAddLog('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'info');
                
                // 6. UI ì—…ë°ì´íŠ¸
                debugAddLog('UI ì—…ë°ì´íŠ¸ ì¤‘...', 'info');
                updateReferralsTable();
                updateTeamCounts();
                updateDataStats();
                
                if (currentActivePage === 'reports') {
                    setTimeout(() => createCharts(), 100);
                }
                
                // 7. ëª¨ë‹¬ ë‹«ê¸°
                closeEditReferralModal();
                
                // 8. ì„±ê³µ ì•Œë¦¼
                showNotification(`âœ… ì˜ë¢°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜ë¢°ë²ˆí˜¸: ${updatedData.refNo}`, 'success');
                addLog('âœ… ì˜ë¢° ìˆ˜ì • ì™„ë£Œ: ' + updatedData.refNo, 'success');
                debugAddLog('ì˜ë¢° ìˆ˜ì • ì €ì¥ ì„±ê³µ', 'info');
                
                debugAddLog('=== ì˜ë¢° ìˆ˜ì • ì €ì¥ ì™„ë£Œ ===', 'info');
                return true;
                
            } catch (error) {
                debugAddLog('ìˆ˜ì • ì €ì¥ ì˜¤ë¥˜: ' + error.message, 'error');
                addLog('âŒ ìˆ˜ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
                showNotification('ìˆ˜ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                return false;
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ë“¤
        function closeReferralDetailModal() {
            try {
                debugAddLog('ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°', 'info');
                const modal = document.getElementById('referralDetailModal');
                if (modal) modal.classList.add('hidden');
                
                viewingReferralData = null;
                debugAddLog('ìƒì„¸ë³´ê¸° ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function closeEditReferralModal() {
            try {
                debugAddLog('ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°', 'info');
                const modal = document.getElementById('editReferralModal');
                const form = document.getElementById('editReferralForm');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
                
                editingReferralData = null;
                debugAddLog('ìˆ˜ì • ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadExcel() {
            try {
                addLog('ğŸ“ˆ ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...', 'info');
                debugAddLog('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘', 'info');
                
                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                
                // ì˜ë¢° ë°ì´í„° ì‹œíŠ¸
                const wsData = referralDatabase.map(item => ({
                    'ì˜ë¢°ë²ˆí˜¸': item.refNo,
                    'ì´ë¦„': item.name,
                    'ì„±ë³„': item.gender,
                    'ë‚˜ì´': item.age,
                    'ì˜ë¢°ë‚ ì§œ': item.referralDate,
                    'ì˜ë¢°ê²½ë¡œ': item.referralPath || '-',
                    'ì˜ë¢°ê¸°ê´€': item.agency,
                    'ë‹´ë‹¹íŒ€': item.team,
                    'ì§€ì—­': item.region || '-',
                    'ë‹´ë‹¹ì': item.counselor,
                    'ì§„ë‹¨ëª…': item.diagnosis,
                    'ì¡°ì¹˜ê²°ê³¼': item.actionResult || '-',
                    'ì¢…ê²°ì—¬ë¶€': item.closureStatus,
                    'ì§„ë‹¨ë³´í˜¸ìš”ì²­': item.diagnosisProtection ? 'O' : 'X',
                    'ì„œë©´ì˜ë¢°': item.writtenReferral ? 'O' : 'X',
                    'ìœ ì„ ì˜ë¢°': item.phoneReferral ? 'O' : 'X',
                    'ê²½ì°°ê°œì…': item.policeInvolvement ? 'O' : 'X',
                    'CRI': item.criInfo || '-',
                    'íšŒì‹ ìš”ì²­': item.responseRequired || '-',
                    'ê°œì…ë‚´ìš©': item.interventionContent || '-'
                }));
                
                const ws1 = XLSX.utils.json_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws1, "ì˜ë¢°ëª©ë¡");
                
                // í†µê³„ ì‹œíŠ¸
                const stats = generateStatistics();
                const statsData = [
                    ['êµ¬ë¶„', 'í•­ëª©', 'ê±´ìˆ˜', 'ë¹„ìœ¨'],
                    ['ì „ì²´', 'ì´ ì˜ë¢°', stats.total, '100%'],
                    ['ì„±ë³„', 'ë‚¨ì„±', stats.gender.male, Math.round(stats.gender.male/stats.total*100) + '%'],
                    ['ì„±ë³„', 'ì—¬ì„±', stats.gender.female, Math.round(stats.gender.female/stats.total*100) + '%'],
                    ['ìƒíƒœ', 'ì§„í–‰ì¤‘', stats.status.progressing, Math.round(stats.status.progressing/stats.total*100) + '%'],
                    ['ìƒíƒœ', 'ì¢…ê²°', stats.status.completed, Math.round(stats.status.completed/stats.total*100) + '%'],
                    ['ì—°ë ¹', 'í‰ê· ì—°ë ¹', Math.round(stats.avgAge) + 'ì„¸', '-']
                ];
                
                Object.entries(stats.teams).forEach(([team, count]) => {
                    statsData.push(['íŒ€ë³„', team, count, Math.round(count/stats.total*100) + '%']);
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, ws2, "í†µê³„");
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const fileName = `ì •ì‹ ê±´ê°•ì„¼í„°_ì˜ë¢°ë°ì´í„°_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                addLog('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + fileName, 'success');
                debugAddLog('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì„±ê³µ', 'info');
                showNotification('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                debugAddLog('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                addLog('âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                showNotification('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ğŸ’¾ JSON ë°±ì—… í•¨ìˆ˜
        function downloadJSON() {
            try {
                addLog('ğŸ’¾ JSON ë°±ì—… íŒŒì¼ ìƒì„± ì¤‘...', 'info');
                debugAddLog('JSON ë°±ì—… ì‹œì‘', 'info');
                
                const backupData = {
                    systemInfo: {
                        name: 'ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ',
                        version: 'v2.1',
                        backupDate: new Date().toISOString(),
                        totalRecords: referralDatabase.length
                    },
                    statistics: generateStatistics(),
                    referralData: referralDatabase
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json; charset=utf-8'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `ì •ì‹ ê±´ê°•ì„¼í„°_ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                addLog('âœ… JSON ë°±ì—… ì™„ë£Œ: ' + link.download, 'success');
                debugAddLog('JSON ë°±ì—… ì„±ê³µ', 'info');
                showNotification('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                debugAddLog('JSON ë°±ì—… ì˜¤ë¥˜: ' + error.message, 'error');
                addLog('âŒ JSON ë°±ì—… ì‹¤íŒ¨: ' + error.message, 'error');
                showNotification('ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadCSV() {
            try {
                addLog('ğŸ“„ CSV íŒŒì¼ ìƒì„± ì¤‘...', 'info');
                debugAddLog('CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘', 'info');
                
                const headers = [
                    'ì˜ë¢°ë²ˆí˜¸', 'ì´ë¦„', 'ì„±ë³„', 'ë‚˜ì´', 'ì˜ë¢°ë‚ ì§œ', 'ì˜ë¢°ê¸°ê´€', 'ë‹´ë‹¹íŒ€', 
                    'ì§€ì—­', 'ë‹´ë‹¹ì', 'ì§„ë‹¨ëª…', 'ì¡°ì¹˜ê²°ê³¼', 'ì¢…ê²°ì—¬ë¶€', 'ê°œì…ë‚´ìš©'
                ];
                
                const csvData = [
                    headers,
                    ...referralDatabase.map(item => [
                        item.refNo,
                        item.name,
                        item.gender,
                        item.age,
                        item.referralDate,
                        item.agency,
                        item.team,
                        item.region || '-',
                        item.counselor,
                        item.diagnosis,
                        item.actionResult || '-',
                        item.closureStatus,
                        item.interventionContent?.replace(/\n/g, ' ').substring(0, 100) || '-'
                    ])
                ];
                
                const csvContent = csvData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                const BOM = '\uFEFF'; // UTF-8 BOM for Korean support
                const blob = new Blob([BOM + csvContent], {type: 'text/csv; charset=utf-8'});
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `ì •ì‹ ê±´ê°•ì„¼í„°_ì˜ë¢°ë°ì´í„°_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                addLog('âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + link.download, 'success');
                debugAddLog('CSV ë‹¤ìš´ë¡œë“œ ì„±ê³µ', 'info');
                showNotification('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                debugAddLog('CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                addLog('âŒ CSV ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                showNotification('CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ğŸ“ˆ í†µê³„ ë°ì´í„° ìƒì„± í•¨ìˆ˜
        function generateStatistics() {
            const stats = {
                total: referralDatabase.length,
                gender: { male: 0, female: 0 },
                age: { total: 0, count: 0 },
                teams: {},
                regions: {},
                counselors: {},
                actions: {},
                status: { progressing: 0, completed: 0 }
            };

            referralDatabase.forEach(item => {
                // ì„±ë³„ í†µê³„
                if (item.gender === 'ë‚¨ì„±') stats.gender.male++;
                else if (item.gender === 'ì—¬ì„±') stats.gender.female++;

                // ë‚˜ì´ í†µê³„
                if (item.age > 0) {
                    stats.age.total += item.age;
                    stats.age.count++;
                }

                // íŒ€ë³„ í†µê³„
                stats.teams[item.team] = (stats.teams[item.team] || 0) + 1;

                // ì§€ì—­ë³„ í†µê³„
                const region = item.region || 'ë¯¸ì§€ì •';
                stats.regions[region] = (stats.regions[region] || 0) + 1;

                // ë‹´ë‹¹ìë³„ í†µê³„
                stats.counselors[item.counselor] = (stats.counselors[item.counselor] || 0) + 1;

                // ì¡°ì¹˜ê²°ê³¼ë³„ í†µê³„
                const action = item.actionResult || 'ë¯¸ì§€ì •';
                stats.actions[action] = (stats.actions[action] || 0) + 1;

                // ì¢…ê²°ìƒíƒœë³„ í†µê³„
                if (item.closureStatus === 'ì¢…ê²°') stats.status.completed++;
                else stats.status.progressing++;
            });

            stats.avgAge = stats.age.count > 0 ? stats.age.total / stats.age.count : 0;

            return stats;
        }

        // ğŸ“Š ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
        function createCharts() {
            debugAddLog('ì°¨íŠ¸ ìƒì„± ì‹œì‘', 'info');
            const stats = generateStatistics();
            
            // ì„±ë³„ ë¶„í¬ ì°¨íŠ¸
            createGenderChart(stats);
            
            // ì—°ë ¹ë³„ ë¶„í¬ ì°¨íŠ¸
            createAgeChart();
            
            // íŒ€ë³„ ë¶„í¬ ì°¨íŠ¸
            createTeamChart(stats);
            
            // ì§€ì—­ë³„ ë¶„í¬ ì°¨íŠ¸
            createRegionChart(stats);
            
            // ë‹´ë‹¹ìë³„ ë¶„í¬ ì°¨íŠ¸
            createCounselorChart(stats);
            
            // ì¡°ì¹˜ê²°ê³¼ë³„ ë¶„í¬ ì°¨íŠ¸
            createActionChart(stats);
            
            // ì›”ë³„ ì¶”ì´ ì°¨íŠ¸
            createMonthlyChart();
            
            // ì¢…í•© í†µê³„ ì—…ë°ì´íŠ¸
            updateSummaryStats(stats);
            
            debugAddLog('ì°¨íŠ¸ ìƒì„± ì™„ë£Œ', 'info');
        }

        function createGenderChart(stats) {
            const ctx = document.getElementById('genderChart').getContext('2d');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['ë‚¨ì„±', 'ì—¬ì„±'],
                    datasets: [{
                        data: [stats.gender.male, stats.gender.female],
                        backgroundColor: ['#3b82f6', '#ec4899'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = stats.total;
                                    const value = context.parsed;
                                    const percentage = Math.round(value / total * 100);
                                    return `${context.label}: ${value}ëª… (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAgeChart() {
            const ctx = document.getElementById('ageChart').getContext('2d');
            if (charts.age) charts.age.destroy();
            
            // ì—°ë ¹ëŒ€ë³„ ê·¸ë£¹í•‘
            const ageGroups = { '10ëŒ€': 0, '20ëŒ€': 0, '30ëŒ€': 0, '40ëŒ€': 0, '50ëŒ€': 0, '60ëŒ€ ì´ìƒ': 0 };
            
            referralDatabase.forEach(item => {
                const age = item.age;
                if (age < 20) ageGroups['10ëŒ€']++;
                else if (age < 30) ageGroups['20ëŒ€']++;
                else if (age < 40) ageGroups['30ëŒ€']++;
                else if (age < 50) ageGroups['40ëŒ€']++;
                else if (age < 60) ageGroups['50ëŒ€']++;
                else ageGroups['60ëŒ€ ì´ìƒ']++;
            });
            
            charts.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        label: 'ì—°ë ¹ë³„ ì˜ë¢° ê±´ìˆ˜',
                        data: Object.values(ageGroups),
                        backgroundColor: '#059669',
                        borderColor: '#047857',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createTeamChart(stats) {
            const ctx = document.getElementById('teamChart').getContext('2d');
            if (charts.team) charts.team.destroy();
            
            const colors = ['#3b82f6', '#059669', '#dc2626', '#d97706', '#7c3aed'];
            
            charts.team = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.teams),
                    datasets: [{
                        data: Object.values(stats.teams),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createRegionChart(stats) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            if (charts.region) charts.region.destroy();
            
            charts.region = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.regions),
                    datasets: [{
                        label: 'ì§€ì—­ë³„ ì˜ë¢° ê±´ìˆ˜',
                        data: Object.values(stats.regions),
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createCounselorChart(stats) {
            const ctx = document.getElementById('counselorChart').getContext('2d');
            if (charts.counselor) charts.counselor.destroy();
            
            charts.counselor = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.counselors),
                    datasets: [{
                        label: 'ë‹´ë‹¹ìë³„ ì˜ë¢° ê±´ìˆ˜',
                        data: Object.values(stats.counselors),
                        backgroundColor: '#7c3aed',
                        borderColor: '#6d28d9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createActionChart(stats) {
            const ctx = document.getElementById('actionChart').getContext('2d');
            if (charts.action) charts.action.destroy();
            
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            charts.action = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.actions),
                    datasets: [{
                        data: Object.values(stats.actions),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            
            // ì›”ë³„ ë°ì´í„° ìƒì„±
            const monthlyData = {};
            referralDatabase.forEach(item => {
                const month = item.referralDate.slice(0, 7); // YYYY-MM í˜•ì‹
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            
            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'ì›”ë³„ ì˜ë¢° ê±´ìˆ˜',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateSummaryStats(stats) {
            document.getElementById('summaryTotal').textContent = stats.total;
            document.getElementById('summaryMale').textContent = Math.round(stats.gender.male / stats.total * 100) + '%';
            document.getElementById('summaryFemale').textContent = Math.round(stats.gender.female / stats.total * 100) + '%';
            document.getElementById('summaryCompleted').textContent = Math.round(stats.status.completed / stats.total * 100) + '%';
        }

        // ë°ì´í„° ê´€ë¦¬ í˜ì´ì§€ í†µê³„ ì—…ë°ì´íŠ¸
        function updateDataStats() {
            try {
                const stats = generateStatistics();
                
                document.getElementById('totalReferrals').textContent = stats.total;
                document.getElementById('completedReferrals').textContent = stats.status.completed;
                document.getElementById('progressingReferrals').textContent = stats.status.progressing;
                document.getElementById('avgAge').textContent = Math.round(stats.avgAge) + 'ì„¸';
                
                debugAddLog('ë°ì´í„° í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'info');
            } catch (error) {
                debugAddLog('ë°ì´í„° í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
        function addLog(message, type = 'info') {
            try {
                const logContainer = document.getElementById('activityLog');
                if (!logContainer) return;
                
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '8px';
                logEntry.style.padding = '4px 8px';
                logEntry.style.borderLeft = '3px solid #374151';
                logEntry.style.borderRadius = '4px';
                
                const typeColors = {
                    'success': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                    'error': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                    'warning': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                    'info': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' }
                };
                
                const colors = typeColors[type] || typeColors.info;
                logEntry.style.borderLeftColor = colors.border;
                logEntry.style.background = colors.bg;
                
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // ë¡œê·¸ ê°œìˆ˜ ì œí•œ
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            } catch (error) {
                debugAddLog('ë¡œê·¸ ì¶”ê°€ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            try {
                debugAddLog('DOM ë¡œë“œ ì™„ë£Œ - ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘', 'info');
                
                // ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // ìƒˆ ì˜ë¢° í¼ ì´ë²¤íŠ¸
                const newReferralForm = document.getElementById('newReferralForm');
                if (newReferralForm) {
                    newReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        debugAddLog('ìƒˆ ì˜ë¢° í¼ ì œì¶œ ì´ë²¤íŠ¸', 'info');
                        
                        try {
                            const newReferral = collectReferralFormData();
                            newReferral.closureStatus = 'ì§„í–‰ì¤‘';
                            
                            referralDatabase.push(newReferral);
                            updateReferralsTable();
                            updateTeamCounts();
                            closeNewReferralModal();
                            
                            showNotification(`ìƒˆ ì˜ë¢°ê°€ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤! (ì˜ë¢°ë²ˆí˜¸: ${newReferral.refNo})`, 'success');
                            debugAddLog('ìƒˆ ì˜ë¢° ì ‘ìˆ˜ ì„±ê³µ: ' + newReferral.refNo, 'info');
                            
                            // í†µê³„ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                            updateDataStats();
                            if (currentActivePage === 'reports') {
                                setTimeout(() => createCharts(), 100);
                            }
                            
                            addLog('ğŸ“Š ìƒˆ ì˜ë¢° ì ‘ìˆ˜: ' + newReferral.refNo, 'success');
                        } catch (error) {
                            debugAddLog('ìƒˆ ì˜ë¢° ì ‘ìˆ˜ ì˜¤ë¥˜: ' + error.message, 'error');
                            showNotification('ìƒˆ ì˜ë¢° ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                        }
                    });
                    debugAddLog('ìƒˆ ì˜ë¢° í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ', 'info');
                }
                
                // ğŸ”§ ì˜ë¢° ìˆ˜ì • í¼ ì´ë²¤íŠ¸ - ë””ë²„ê¹… ê°•í™” ë° ì´ì¤‘ ë³´ì•ˆ
                const editReferralForm = document.getElementById('editReferralForm');
                if (editReferralForm) {
                    debugAddLog('ìˆ˜ì • í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡', 'info');
                    
                    // ë°©ë²• 1: í¼ ì œì¶œ ì´ë²¤íŠ¸
                    editReferralForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        debugAddLog('ìˆ˜ì • í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ (ë°©ë²• 1)', 'info');
                        handleSaveEditedReferral();
                    });
                    
                    debugAddLog('ìˆ˜ì • í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ', 'info');
                } else {
                    debugAddLog('editReferralFormì„ ì°¾ì„ ìˆ˜ ì—†ìŒ - ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„', 'info');
                }

                // ğŸ”§ ë°©ë²• 2: ë²„íŠ¼ ì§ì ‘ ì´ë²¤íŠ¸ (ë°±ì—…ìš©)
                setTimeout(() => {
                    const saveBtn = document.getElementById('saveEditedReferralBtn');
                    if (saveBtn && !saveBtn.hasAttribute('onclick-backup')) {
                        saveBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            debugAddLog('ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë°©ë²• 2)', 'info');
                            handleSaveEditedReferral();
                        });
                        saveBtn.setAttribute('onclick-backup', 'true');
                        debugAddLog('ì €ì¥ ë²„íŠ¼ ë°±ì—… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ', 'info');
                    }
                }, 2000);
                
                
                // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        const loginScreen = document.getElementById('loginScreen');
                        if (loginScreen && !loginScreen.classList.contains('hidden')) {
                            const activeElement = document.activeElement;
                            if (activeElement && (activeElement.id === 'username' || activeElement.id === 'password')) {
                                handleLogin();
                            }
                        }
                    }
                });
                
                // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                const modals = [
                    'newReferralModal',
                    'referralDetailModal', 
                    'editReferralModal'
                ];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.addEventListener('click', function(e) {
                            if (e.target === this) {
                                const closeFunction = {
                                    'newReferralModal': closeNewReferralModal,
                                    'referralDetailModal': closeReferralDetailModal,
                                    'editReferralModal': closeEditReferralModal
                                }[modalId];
                                
                                if (closeFunction) {
                                    closeFunction();
                                }
                            }
                        });
                    }
                });
                
                // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        const visibleModal = document.querySelector('.modal:not(.hidden)');
                        if (visibleModal) {
                            const modalId = visibleModal.id;
                            const closeFunction = {
                                'newReferralModal': closeNewReferralModal,
                                'referralDetailModal': closeReferralDetailModal,
                                'editReferralModal': closeEditReferralModal
                            }[modalId];
                            
                            if (closeFunction) {
                                closeFunction();
                            }
                        }
                    }
                });
                
                debugAddLog('ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ v2.1 ì™„ì „ êµ¬í˜„ ì™„ë£Œ!', 'info');
                debugAddLog('ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°: Excel, CSV, JSON ì§€ì›', 'info');
                debugAddLog('ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„ ì°¨íŠ¸: ì„±ë³„, ì—°ë ¹, íŒ€ë³„, ì§€ì—­ë³„, ë‹´ë‹¹ìë³„ ë¶„ì„', 'info');
                debugAddLog('ğŸ’¾ ë¡œì»¬ ë°ì´í„° ê´€ë¦¬: ë°±ì—… ë° ë³µì› ê¸°ëŠ¥', 'info');
                debugAddLog('ğŸ¯ ì™„ì „í•œ ì˜¤í”„ë¼ì¸ ì‹œìŠ¤í…œ - í´ë¼ìš°ë“œ ì˜ì¡´ì„± ì œê±°', 'info');
                debugAddLog('ğŸ”§ ë””ë²„ê¹… ì‹œìŠ¤í…œ í™œì„±í™” - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§', 'info');
                
                // ğŸ“ ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (onclick ì ‘ê·¼ìš©)
                window.debugSystemStatus = debugSystemStatus;
                window.handleSaveEditedReferral = handleSaveEditedReferral;
                window.editCurrentReferral = editCurrentReferral;
                window.viewReferralDetail = viewReferralDetail;
                window.editReferral = editReferral;
                window.selectTeam = selectTeam;
                window.openNewReferralModal = openNewReferralModal;
                window.closeNewReferralModal = closeNewReferralModal;
                window.closeReferralDetailModal = closeReferralDetailModal;
                window.closeEditReferralModal = closeEditReferralModal;
                window.saveDraftReferral = saveDraftReferral;
                window.handleLogin = handleLogin;
                window.handleLogout = handleLogout;
                window.showPage = showPage;
                window.downloadExcel = downloadExcel;
                window.downloadJSON = downloadJSON;
                window.downloadCSV = downloadCSV;
                window.toggleDebugPanel = toggleDebugPanel;
                window.clearDebugLog = clearDebugLog;
                
                debugAddLog('ëª¨ë“  ì „ì—­ í•¨ìˆ˜ ë“±ë¡ ì™„ë£Œ', 'info');
                debugAddLog('ë””ë²„ê¹… í•¨ìˆ˜ ë“±ë¡ë¨ - ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ debugSystemStatus() ì‹¤í–‰ ê°€ëŠ¥', 'info');
                
                // ğŸ“ ì´ˆê¸° ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
                setTimeout(() => {
                    debugAddLog('=== ì´ˆê¸° ì‹œìŠ¤í…œ ìƒíƒœ ===', 'info');
                    debugAddLog('ì˜ë¢° ë°ì´í„° ê°œìˆ˜: ' + referralDatabase.length, 'info');
                    debugAddLog('í˜„ì¬ í™œì„± í˜ì´ì§€: ' + currentActivePage, 'info');
                    debugSystemStatus();
                }, 1000);
                
            } catch (error) {
                debugAddLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message, 'error');
                showNotification('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', function(event) {
            debugAddLog('ì „ì—­ ì˜¤ë¥˜ ë°œìƒ: ' + event.error.message, 'error');
            showNotification('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
        });

        // Promise ê±°ë¶€ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('unhandledrejection', function(event) {
            debugAddLog('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€: ' + event.reason, 'error');
            showNotification('ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            event.preventDefault();
        });

    </script>
</body>
</html>